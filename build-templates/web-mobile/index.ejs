<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <title>
    <%= projectName %>
  </title>

  <!--http://www.html5rocks.com/en/mobile/mobifying/-->
  <meta name="viewport"
    content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true,viewport-fit=cover" />

  <!--https://developer.apple.com/library/safari/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">

  <!-- force webkit on 360 -->
  <meta name="renderer" content="webkit" />
  <meta name="force-rendering" content="webkit" />
  <!-- force edge on IE -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="msapplication-tap-highlight" content="no">

  <!-- force full screen on some browser -->
  <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <meta name="360-fullscreen" content="true" />

  <!--fix fireball/issues/3568 -->
  <!--<meta name="browsermode" content="application">-->
  <meta name="x5-page-mode" content="app">

  <!--<link rel="apple-touch-icon" href=".png" />-->
  <!--<link rel="apple-touch-icon-precomposed" href=".png" />-->

  <link rel="stylesheet" type="text/css" href="<%= cssUrl %>" />
  <link rel="stylesheet" type="text/css" href="splash.css" />

  <script>
    !function (f, b, e, v, n, t, s) {
      if (f.fbq) return; n = f.fbq = function () {
        n.callMethod ?
          n.callMethod.apply(n, arguments) : n.queue.push(arguments)
      };
      if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
      n.queue = []; t = b.createElement(e); t.async = !0;
      t.src = v; s = b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t, s)
    }(window, document, 'script',
      'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '{your-pixel-id-goes-here}');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id={your-pixel-id-goes-here}&ev=PageView&noscript=1" />
  </noscript>
</head>

<body>
  <div id="GameDiv" cc_exact_fit_screen="true">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
  </div>
  <div id="loading2">
    <div>
      <span>
        <img src="./images/loading.png" />
        <p>Loading...</p>
      </span>
    </div>
  </div>
  <div id="splash_2" class="splash">
    <div class="progress-bar stripes">
      <span style="width: 0%"></span>
    </div>
  </div>
  <%- include(cocosTemplate, {}) %>
    <script>
      function checkOrientation() {
        if (window.orientation === 0) {
          document.querySelector("#splash_2").className = 'splash landscape'
        } else {
          document.querySelector("#splash_2").className = 'splash'
        }
      }
      window.onload = () => {
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation);
      }
      window.setTimeout(() => checkOrientation(), 10)
    </script>
    <script src="customize/index.js" charset="utf-8"> </script>
    <script>
      // const version = '812.27'
      // if (!localStorage.getItem('version') || localStorage.getItem('version') !== version) {
      //   localStorage.setItem('version', version)
      //   location.reload()
      // }
      // 设置背景颜色
      document.body.style.backgroundColor = 'white';
    </script>
    <!-- agent handle -->
    <script>
      !function (e, t) { "object" == typeof exports && "object" == typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define([], t) : "object" == typeof exports ? exports.install = t() : e.install = t() }(window, (function () { return function (e) { var t = {}; function n(r) { if (t[r]) return t[r].exports; var o = t[r] = { i: r, l: !1, exports: {} }; return e[r].call(o.exports, o, o.exports, n), o.l = !0, o.exports } return n.m = e, n.c = t, n.d = function (e, t, r) { n.o(e, t) || Object.defineProperty(e, t, { enumerable: !0, get: r }) }, n.r = function (e) { "undefined" != typeof Symbol && Symbol.toStringTag && Object.defineProperty(e, Symbol.toStringTag, { value: "Module" }), Object.defineProperty(e, "__esModule", { value: !0 }) }, n.t = function (e, t) { if (1 & t && (e = n(e)), 8 & t) return e; if (4 & t && "object" == typeof e && e && e.__esModule) return e; var r = Object.create(null); if (n.r(r), Object.defineProperty(r, "default", { enumerable: !0, value: e }), 2 & t && "string" != typeof e) for (var o in e) n.d(r, o, function (t) { return e[t] }.bind(null, o)); return r }, n.n = function (e) { var t = e && e.__esModule ? function () { return e.default } : function () { return e }; return n.d(t, "a", t), t }, n.o = function (e, t) { return Object.prototype.hasOwnProperty.call(e, t) }, n.p = "", n(n.s = 0) }([function (e, t, n) { "use strict"; var r = this && this.__spreadArray || function (e, t, n) { if (n || 2 === arguments.length) for (var r, o = 0, i = t.length; o < i; o++)!r && o in t || (r || (r = Array.prototype.slice.call(t, 0, o)), r[o] = t[o]); return e.concat(r || Array.prototype.slice.call(t)) }; !function (e) { var t = window; t.KwaiAnalyticsObject = e, t[e] = t[e] || []; var n = t[e]; n.methods = ["page", "track", "identify", "instances", "debug", "on", "off", "once", "ready", "alias", "group", "enableCookie", "disableCookie"]; var o = function (e, t) { e[t] = function () { var n = Array.from(arguments), o = r([t], n, !0); e.push(o) } }; n.methods.forEach((function (e) { o(n, e) })), n.instance = function (e) { var t = n._i[e] || []; return n.methods.forEach((function (e) { o(t, e) })), t }, n.load = function (t, r) { n._i = n._i || {}, n._i[t] = [], n._i[t]._u = "https://s1.kwai.net/kos/s101/nlav11187/pixel/events.js", n._t = n._t || {}, n._t[t] = +new Date, n._o = n._o || {}, n._o[t] = r || {}; var o = document.createElement("script"); o.type = "text/javascript", o.async = !0, o.src = "https://s1.kwai.net/kos/s101/nlav11187/pixel/events.js?sdkid=" + t + "&lib=" + e; var i = document.getElementsByTagName("script")[0]; i.parentNode.insertBefore(o, i) } }("kwaiq") }]) }));
    </script>
    <script>
      let pkgId = '';
      const apHandle = function () {
        let reqUrl = window.location.href;
        reqUrl = reqUrl.substring(reqUrl.indexOf("?") + 1)
        const params = reqUrl.split("&");

        let referer = '';
        const packageType = '0';
        const getParamValue = (param, key) => {
          return param.substring(param.indexOf("=") + 1);
        }

        if (params) {
          params.forEach(v => {
            if (v.indexOf('referer') !== -1) {
              referer = getParamValue(v, 'referer');
            } else if (v.indexOf('pkgId') !== -1) {
              pkgId = getParamValue(v, 'pkgId');
            }
          })
        }
        if ('Sh6EoJ' === pkgId) {
          kwaiq.load('561954736342577195');
          kwaiq.page();
        }
      }
      apHandle();

      const requestGet = (url) => {
        return new Promise((reslove, reject) => {
          fetch(`${url}`).then((response) => {
            if (response.status === 200) {
              response.text().then(jsonStr => {
                reslove(JSON.parse(jsonStr.trim()))
              }).catch(e => reslove(undefined))
            } else {
              reslove(undefined)
            }
          }).catch((e) => {
            reslove(undefined)
          })
        })
      }
    </script>

    <!-- 要添加代理写在这里 -->


    <!-- 添加fb的头部代码，放到最后来处理 -->
    <script>
      console.log("pkgid", pkgId);
      if (pkgId) {
        // TODO 这里要替换URL地址
        const baseUrl = "http://54.251.66.82:10001";

        let remoteUrl = baseUrl + "/hall/channelPackage/getPixelId?channelAp=" + pkgId;
        requestGet(remoteUrl).then(res => {
          let fbToken = undefined;
          if (res && res.code === '200' && res.content) {
            fbToken = res.content;
          }

          if (fbToken) {
            let scirptStr = '<script>' +
              '!function (f, b, e, v, n, t, s) {' +
              'if (f.fbq) return; n = f.fbq = function () {' +
              'n.callMethod ?' +
              ' n.callMethod.apply(n, arguments) : n.queue.push(arguments)' +
              '};' +
              "if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';" +
              'n.queue = []; t = b.createElement(e); t.async = !0;' +
              't.src = v; s = b.getElementsByTagName(e)[0];' +
              's.parentNode.insertBefore(t, s)' +
              "}(window, document, 'script'," +
              "'https://connect.facebook.net/en_US/fbevents.js');" +
              // "fbq('init', " + fbToken + ");" +
              // "fbq('track', 'PageView');" +
              "<\/script> \n" +
              "<noscript>" +
              '<img height="1" width="1" style="display:none"' +
              'src="https://www.facebook.com/tr?id=' + fbToken + '&ev=PageView&noscript=1" />' +
              "</noscript>"
              ;
            document.body.append(scirptStr)
            fbq('init', fbToken);
            fbq('track', 'PageView');
          }
        })
      }

    </script>
    </script>

</body>

</html>