{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/ActionEffectPlayer.ts"],"names":["analyze","data","actLst","eff_lst","length","effLst","newIndex","push","effLen","i","nxt_idx","isCanReserver","key","setInitParam","param","obj","parentObj","angle","sax","setScale","say","zorder","setSiblingIndex","parent","children","tween","ActionCreater","ActionEffectPlayer","play","endCall","eff","undefined","nodeTw","init_param","len","lst","seqLst","j","actObj","create","actObjR","breserver","reverseTime","tw","then","reapt_obj","loop","repeat","call","isValid","forEach","v","start"],"mappings":"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","sourcesContent":["// 动作链播放器\r\n\r\nimport { Node, Tween, tween } from \"cc\"\r\nimport { ActionCreater } from \"./ActionCreater\"\r\n\r\nfunction analyze(data) {\r\n  let actLst = []\r\n\r\n  if (data && data.eff_lst.length > 0) {\r\n    let effLst = data.eff_lst\r\n    let newIndex = 0\r\n    actLst.push([])\r\n    let effLen = effLst.length - 1\r\n    for (let i = 0; i <= effLen; i++) {\r\n      actLst[newIndex].push(effLst[i])\r\n      if (effLst[i].nxt_idx === -1 && i < effLen) {\r\n        actLst.push([])\r\n        newIndex = actLst.length - 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  return actLst\r\n}\r\n\r\nfunction isCanReserver(key) {\r\n  if (key === \"move_by\" || key === \"scale_by\" || key === \"rotate_by\" || key === \"skew_by\" || key === \"jump_by\" || key === \"tint_by\") {\r\n    return true\r\n  }\r\n  return false\r\n}\r\n\r\nfunction setInitParam(param, obj: Node, parentObj: Node) {\r\n  if (param && obj) {\r\n    if (param.angle) { obj.angle = param.angle }\r\n    if (param.sax) { obj.setScale(param.sax, param.say) }\r\n    // if (param.say) { obj.setScale(param.sax, param.say) }\r\n    // if (param.skx) { obj.setSkewX(param.skx) }\r\n    // if (param.sky) { obj.setSkewY(param.sky) }\r\n    // if (param.srkx) { obj.setRotationSkewX(param.srkx) }\r\n    // if (param.srky) { obj.setRotationSkewY(param.srky) }\r\n    if (param.zorder) {\r\n      if (parentObj) {\r\n        parentObj.setSiblingIndex(parentObj.parent.children.length)\r\n      } else {\r\n        obj.setSiblingIndex(obj.parent.children.length)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////-\r\n\r\nexport const ActionEffectPlayer = {\r\n  play: (obj: Node, endCall, eff, parentObj = undefined) => {\r\n    if (obj && eff) {\r\n\r\n      const nodeTw = tween(obj);\r\n\r\n      let effLst = analyze(eff)\r\n      setInitParam(eff.init_param, obj, parentObj)\r\n\r\n      let effLen = effLst.length - 1\r\n      for (let i = 0; i <= effLen; i++) {\r\n        let len = effLst[i].length - 1\r\n        let lst = effLst[i]\r\n\r\n        let seqLst = [] //一个链\r\n\r\n        for (let j = 0; j <= len; j++) {\r\n          let actObj = ActionCreater.create(lst[j].key, lst[j].param) as Tween<any>\r\n          let actObjR = null\r\n\r\n          if (actObj && isCanReserver(lst[j].key) && lst[j].breserver) {\r\n            actObjR = actObj.reverseTime();\r\n          }\r\n\r\n          const tw = tween();\r\n          if (actObj) { tw.then(actObj) }\r\n          if (actObjR) { tw.then(actObjR) }\r\n\r\n          let reapt_obj = null\r\n          if (lst[j].loop === -1) {\r\n            reapt_obj = tween().repeat(10000000, tw)\r\n          } else {\r\n            reapt_obj = tween().repeat(lst[j].loop, tw)\r\n          }\r\n          seqLst.push(reapt_obj)\r\n        }\r\n\r\n        if (i === effLen) { //最后一个链来执行完成回调\r\n          if (endCall) {\r\n            seqLst.push(tween().call(() => obj.isValid && endCall()))\r\n          }\r\n        }\r\n\r\n        seqLst.forEach(v => {\r\n          nodeTw.then(v);\r\n        })\r\n        nodeTw.start();\r\n        // obj.runAction(tween().sequence(...seqLst))\r\n      }\r\n    } else {//没有动作链直接执行完成回调\r\n      endCall && endCall();\r\n    }\r\n  }\r\n}\r\n\r\n"]}