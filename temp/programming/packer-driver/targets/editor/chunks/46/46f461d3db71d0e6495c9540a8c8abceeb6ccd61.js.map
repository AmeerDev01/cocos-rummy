{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/MusicEffectPlayer.ts"],"names":["MusicEffectPlayer","AudioSource","Node","UseSetOption","getFileName","EFF_FILE_EXT_NAME","constructor","parentNode","sourceManage","musicResConfig","musicEffectConfig","uiRoot","musicEffList","audioSource","loopMusic","bgmNode","bgmAudioSource","addComponent","addChild","init","initBgmNode","uninit","destroy","forEach","v","mepAnsy","data","result_lst","mus_eff_id","id","mus_data_lst","getLength","mus_lst","cur_new_index","new_item","cur_add_time","cur_play_index","data_lst","bplay_cmp","push","eff_len","i","nxt_idx","length","value","count","k","update","dt","litem","litem_bcmp","j","llitem","splice","t","src","src_id","file","loop","playSound","getFile","source","clip","Instance","option","sound","createLoopMusic","isNotValid","play","pause","getComponent","playOn","node","as","isValid","musID","cfg_data","lst","is_exist","playBgm","srcFile"],"mappings":"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","sourcesContent":["/**\r\n  音效特效播放\r\n */\r\n\r\nimport { AudioClip, AudioSource, Node } from \"cc\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport UseSetOption from \"../../utils/UseSetOption\";\r\nimport { getFileName } from \"./FishTool\";\r\n\r\nexport const EFF_FILE_EXT_NAME = '.mp3'\r\n\r\ntype Item = {\r\n  cur_add_time: number;\r\n  cur_play_index: number;\r\n  data_lst: any[];\r\n  bplay_cmp: boolean;\r\n}\r\n\r\ntype Result = {\r\n  mus_eff_id: number,\r\n  mus_data_lst: Item[],\r\n}\r\n\r\n////////////////////////////////////-\r\nexport class MusicEffectPlayer {\r\n\r\n  private uiRoot: Node;\r\n  private musicResConfig = null\r\n  private musicEffectConfig = null\r\n  private musicEffList: Result[] = null\r\n  private audioSource: AudioSource = null\r\n  private sourceManage: SourceManage;\r\n\r\n  /**循环音效 */\r\n  private loopMusic: Node[] = [];\r\n  private parentNode: Node;\r\n\r\n  private bgmNode: Node;\r\n  private bgmAudioSource: AudioSource = null\r\n\r\n  constructor(parentNode: Node, sourceManage: SourceManage, musicResConfig, musicEffectConfig) {\r\n    this.sourceManage = sourceManage;\r\n    this.uiRoot = new Node();\r\n    this.audioSource = this.uiRoot.addComponent(AudioSource);\r\n    this.parentNode = parentNode;\r\n    parentNode.addChild(this.uiRoot);\r\n\r\n    this.init(musicResConfig, musicEffectConfig)\r\n    this.initBgmNode();\r\n  }\r\n\r\n  private init(musicResConfig, musicEffectConfig) {\r\n    this.musicResConfig = musicResConfig\r\n    this.musicEffectConfig = musicEffectConfig\r\n    this.musicEffList = []\r\n  }\r\n\r\n  private initBgmNode() {\r\n    this.bgmNode = new Node();\r\n    this.bgmAudioSource = this.bgmNode.addComponent(AudioSource);\r\n    this.parentNode.addChild(this.bgmNode);\r\n  }\r\n\r\n  public uninit() {\r\n    this.musicResConfig = null\r\n    this.musicEffectConfig = null\r\n    this.musicEffList = null\r\n    this.uiRoot.destroy();\r\n    this.loopMusic.forEach(v => v.destroy())\r\n    this.loopMusic = [];\r\n  }\r\n\r\n  public mepAnsy(data) {\r\n    let result_lst: Result = {\r\n      mus_eff_id: data.id,\r\n      mus_data_lst: [],\r\n    }\r\n\r\n    if (data && this.getLength(data.mus_lst) > 0) {\r\n      let mus_lst = data.mus_lst\r\n      let cur_new_index = 0\r\n\r\n      let new_item: Item = { cur_add_time: 0, cur_play_index: 0, data_lst: [], bplay_cmp: false, }\r\n      result_lst.mus_data_lst.push(new_item)\r\n      let eff_len = this.getLength(mus_lst)\r\n\r\n      for (let i = 1; i <= eff_len; i++) {\r\n        result_lst.mus_data_lst[cur_new_index].data_lst.push(mus_lst[i])\r\n        if (mus_lst[i].nxt_idx === -1 && i < eff_len) {\r\n          let new_item: Item = { cur_add_time: 0, cur_play_index: 0, data_lst: [], bplay_cmp: false, }\r\n          result_lst.mus_data_lst.push(new_item)\r\n          cur_new_index = result_lst.mus_data_lst.length - 1\r\n        }\r\n      }\r\n    }\r\n\r\n    return result_lst\r\n  }\r\n\r\n  private getLength(value) {\r\n    let count = 0;\r\n    for (const k in value) {\r\n      count++;\r\n    }\r\n    return count;\r\n  }\r\n\r\n  public update(dt) {\r\n    for (let i = 0; i < this.musicEffList.length; i++) {\r\n      let litem = this.musicEffList[i]\r\n      let litem_bcmp = true\r\n\r\n      for (let j = 0; j < litem.mus_data_lst.length; j++) {\r\n        let llitem = litem.mus_data_lst[j]\r\n        if (llitem.bplay_cmp === false) {\r\n          litem_bcmp = false\r\n          break\r\n        }\r\n      }\r\n\r\n      if (litem_bcmp) {\r\n        this.musicEffList.splice(i, 1)\r\n        break\r\n      }\r\n    }\r\n\r\n    for (let i = 0; i < this.musicEffList.length; i++) {\r\n      let litem = this.musicEffList[i]\r\n      for (let j = 0; j < litem.mus_data_lst.length; j++) {\r\n        let llitem = litem.mus_data_lst[j]\r\n\r\n        if (llitem.cur_play_index <= llitem.data_lst.length - 1) {\r\n          if (llitem.cur_add_time >= llitem.data_lst[llitem.cur_play_index].t) {\r\n\r\n            //播放音效\r\n            let src = this.musicResConfig[llitem.data_lst[llitem.cur_play_index].src_id].file\r\n            let loop = llitem.data_lst[llitem.cur_play_index].loop\r\n            // AudioEngine.playEffect(src + EFF_FILE_EXT_NAME, loop)\r\n            this.playSound(this.sourceManage.getFile(getFileName(src)).source, loop)\r\n\r\n            llitem.cur_add_time = 0\r\n            llitem.cur_play_index = llitem.cur_play_index + 1\r\n          } else {\r\n            llitem.cur_add_time = llitem.cur_add_time + dt\r\n          }\r\n        } else {\r\n          llitem.bplay_cmp = true\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private playSound(clip: AudioClip, loop: boolean) {\r\n    if (!UseSetOption.Instance().option.sound) {\r\n      return;\r\n    }\r\n\r\n    if (loop) {\r\n      this.createLoopMusic(clip);\r\n      return;\r\n    }\r\n    const audioSource = this.audioSource;\r\n    if (this.isNotValid(audioSource)) return;\r\n    audioSource.clip = clip;\r\n    audioSource.loop = loop;\r\n    audioSource.play();\r\n  }\r\n\r\n  public pause() {\r\n    this.bgmAudioSource.pause();\r\n    this.loopMusic.forEach(v => v.getComponent(AudioSource).pause())\r\n  }\r\n\r\n  /**继续播放 */\r\n  public playOn() {\r\n    this.bgmAudioSource.play();\r\n    this.loopMusic.forEach(v => v.getComponent(AudioSource).play())\r\n  }\r\n\r\n  private createLoopMusic(clip: AudioClip) {\r\n    let node = new Node;\r\n    this.parentNode.addChild(node);\r\n    this.loopMusic.push(node);\r\n    const as = node.addComponent(AudioSource);\r\n    as.clip = clip;\r\n    as.loop = true;\r\n    as.play();\r\n  }\r\n\r\n  private isNotValid(source: AudioSource) {\r\n    return !source || !source.isValid;\r\n  }\r\n\r\n  public play(musID) {\r\n    if (musID !== null && musID !== -1) {\r\n      let cfg_data = this.musicEffectConfig[musID]\r\n      let lst = this.mepAnsy(cfg_data)\r\n      let is_exist = false\r\n      for (const k in this.musicEffList) {\r\n        const v = this.musicEffList[k];\r\n        if (v.mus_eff_id === musID) {\r\n          is_exist = true\r\n          break\r\n        }\r\n      }\r\n\r\n      if (is_exist === false) {\r\n        if (lst.mus_data_lst.length > 0) {\r\n          this.musicEffList.push(lst)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public playBgm(srcFile) {\r\n    // this.bgmAudioSource.clip = this.sourceManage.getFile(getFileName(srcFile)).source;\r\n    // this.bgmAudioSource.loop = true;\r\n    // UseSetOption.Instance().option.music && this.bgmAudioSource.play();\r\n  }\r\n}\r\n\r\n\r\n"]}