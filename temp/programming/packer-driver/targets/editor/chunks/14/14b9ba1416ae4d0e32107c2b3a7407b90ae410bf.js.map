{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/FishGoldManager.ts"],"names":["FishGoldManager","Vec3","tween","ObjectClassType","toNodeSpaceAR","sin","Math","cos","sqrt","pow","ceil","pi","PI","goldConfigID","fishGoldConfig","textureConfig","actionConfig","commonConfig","objectPool","musicEffectPlayer","rootNode","init","uninit","getRootNode","fgmOnEndCall","obj","end_pos","getEndPos","t","getEndMoveTime","uiRoot","setSiblingIndex","parent","children","length","to","position","call","isValid","runLastEff","play","gold_recl_id","start","getObjPos","max_num","cur_num","angle","dis","pos","ranti","x","y","getUnitGoldNumber","score","k","v","gold_num","info","id","number","parseInt","beishu","max_gold_num","distance","i","getObject","type_fish_gold","content_size","getSize","setUseState","setPlayEndCall","index","width","height","gold_distance","new_spos","spos","gold_mus_id"],"mappings":"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","sourcesContent":["import { Node, Vec3, tween } from \"cc\"\r\nimport { ObjectClassType, ObjectPool } from \"./ObjectPool\"\r\nimport { FishGold } from \"./FishGold\"\r\nimport { MusicEffectPlayer } from \"./MusicEffectPlayer\"\r\nimport { toNodeSpaceAR } from \"./FishTool\"\r\n\r\n/**\r\n  金币管理\r\n */\r\nconst sin = Math.sin\r\nconst cos = Math.cos\r\nconst sqrt = Math.sqrt\r\nconst pow = Math.pow\r\nconst ceil = Math.ceil\r\nconst pi = Math.PI\r\n\r\nconst goldConfigID = 1;\r\n\r\n////////////////////////////////////////////////////////////////////////-\r\nexport class FishGoldManager {\r\n  private fishGoldConfig = null\r\n  private textureConfig = null\r\n  private actionConfig = null\r\n  private commonConfig = null\r\n  private objectPool: ObjectPool;\r\n  private musicEffectPlayer: MusicEffectPlayer;\r\n  private rootNode: Node;\r\n\r\n  public init(fishGoldConfig, textureConfig, actionConfig, commonConfig, objectPool: ObjectPool, musicEffectPlayer: MusicEffectPlayer, rootNode: Node) {\r\n    this.fishGoldConfig = fishGoldConfig\r\n    this.textureConfig = textureConfig\r\n    this.actionConfig = actionConfig\r\n    this.commonConfig = commonConfig\r\n    this.objectPool = objectPool\r\n    this.musicEffectPlayer = musicEffectPlayer\r\n    this.rootNode = rootNode\r\n  }\r\n\r\n  public uninit() {\r\n    this.fishGoldConfig = null\r\n    this.textureConfig = null\r\n    this.actionConfig = null\r\n    this.commonConfig = null\r\n    this.objectPool = null\r\n    this.musicEffectPlayer = null\r\n  }\r\n\r\n  public getRootNode() {\r\n    return this.rootNode\r\n  }\r\n\r\n  public fgmOnEndCall(obj: FishGold) {\r\n    let end_pos = toNodeSpaceAR(this.rootNode, obj.getEndPos());\r\n    let t = obj.getEndMoveTime()\r\n    if (t <= 0 || t > 10) {\r\n      t = 2\r\n    }\r\n\r\n    obj.uiRoot.setSiblingIndex(obj.uiRoot.parent.children.length);\r\n    tween(obj.uiRoot).to(t, { position: end_pos }).call(() => {\r\n      if (obj.uiRoot.isValid) {\r\n        obj.runLastEff()\r\n        this.musicEffectPlayer.play(this.commonConfig.gold_recl_id)\r\n      }\r\n    }).start();\r\n  }\r\n\r\n  public getObjPos(max_num, cur_num, angle, dis) {\r\n    let pos = new Vec3();\r\n    let ranti = (angle / 180) * pi\r\n\r\n    if (cur_num < max_num / 2) {\r\n      pos.x = dis * cos(pi - ranti)\r\n      pos.y = dis * sin(pi - ranti)\r\n    } else {\r\n      pos.x = -dis * cos(pi - ranti)\r\n      pos.y = -dis * sin(pi - ranti)\r\n    }\r\n\r\n    return pos\r\n  }\r\n\r\n  public getUnitGoldNumber(score) {\r\n    if (score !== null) {\r\n\r\n      for (const k in this.fishGoldConfig) {\r\n        const v = this.fishGoldConfig[k];\r\n        if (score > v.gold_num) {\r\n          return v.gold_num\r\n        }\r\n      }\r\n    }\r\n\r\n    return this.fishGoldConfig[goldConfigID].gold_num\r\n  }\r\n\r\n  //info = [spos, end_pos, number, angle, beishu]\r\n  public play(info) {\r\n    let id = goldConfigID\r\n    for (const k in this.fishGoldConfig) {\r\n      const v = this.fishGoldConfig[k];\r\n      if (info.number > v.gold_num) {\r\n        id = parseInt(k);\r\n        break\r\n      }\r\n    }\r\n\r\n    let max_num = ceil(info.beishu / 10)\r\n    if (max_num > this.commonConfig.max_gold_num) {\r\n      max_num = this.commonConfig.max_gold_num\r\n    }\r\n\r\n    let distance = 0\r\n    for (let i = 1; i <= max_num; i++) {\r\n      let obj = this.objectPool.getObject(ObjectClassType.type_fish_gold, id) as FishGold;\r\n      if (obj) {\r\n        let content_size = obj.getSize()\r\n        obj.setUseState(true)\r\n        obj.setPlayEndCall((obj) => {\r\n          this.fgmOnEndCall(obj)\r\n        })\r\n        let index = i - 1\r\n        if (i >= max_num / 2 && max_num > 1) {\r\n          index = max_num - i + 1\r\n        }\r\n        distance = (index) * (sqrt(pow(content_size.width, 2) + pow(content_size.height, 2)) + this.commonConfig.gold_distance)\r\n        let new_spos = this.getObjPos(max_num, i, info.angle, distance)\r\n        new_spos.x = new_spos.x + info.spos.x\r\n        new_spos.y = new_spos.y + info.spos.y\r\n        obj.play(new_spos, info.end_pos)\r\n      }\r\n    }\r\n\r\n    this.musicEffectPlayer.play(this.commonConfig.gold_mus_id)\r\n  }\r\n}\r\n\r\n\r\n"]}