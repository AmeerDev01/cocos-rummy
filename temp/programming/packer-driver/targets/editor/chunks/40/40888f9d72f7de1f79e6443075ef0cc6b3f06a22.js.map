{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/phoenixV2/index.ts"],"names":["Prefab","assetManager","listenerFactoy","LoaderPanelViewModel","global","lang","SubGameRunState","subGameList","addToastAction","setSubGameRunState","AudioMgr","setActiveAudio","config","socketConnect","removeInstance","phoenixV2FileMap","bundlePkgName","PrefabPathDefine","SoundPathDefine","fruitStore","getStore","PhoenixV2MainViewModel","initGameStore","initRoller","sourceManageMap","bundlePhoenixV2","sourceManageSeletor","bundleName","find","i","bundle","name","NORMAL_MAG_TYPE","msgListener","initTimeoutId","startUp","rootNode","configureStore","loadBundle","err","load","LOAING_PANEL","progress","total","hallDispatch","LOADING","setSubGameGate","gameId","prefab","isAllowOpenSubGame","READY","loaderviweModel","mountView","appendTo","setProps","loadBarType","setEvent","onLoadDone","_sourceManageMap","phoenixV2_Audio","window","setTimeout","closeSubGame","confirmContent","write","k","InitGameModule","GameBoardInit","confirmDoneBeforeFn","destoryGame","content","placeStr","playOneShot","DING","timeId","unMount","clearTimeout","comp","setTipContent","WebSocketModule","GameInit","RUN","then","dispatch","mainViewModel","getFile","MAIN_GAME","source","connect","viewNode","isValid","setSiblingIndex","parent","children","length","catch","e","versionStr","md5","startLoad","stopGame","remove"],"mappings":"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","sourcesContent":["import { AssetManager, Node, Prefab, assetManager } from \"cc\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport { listenerFactoy } from \"../../common/listenerFactoy\";\r\nimport LoaderPanelViewModel from \"../../common/viewModel/LoaderPanelViewModel\";\r\nimport { global, lang } from \"../../hall\";\r\nimport { SubGameRunState, subGameList } from \"../../hall/config\";\r\nimport { addToastAction, setSubGameRunState } from \"../../hall/store/actions/baseBoard\";\r\nimport { AudioMgr } from \"../../utils/AudioMgr\";\r\nimport { setActiveAudio } from \"../../utils/UseSetOption\";\r\nimport config from \"./config\";\r\nimport socketConnect, { removeInstance } from \"./socketConnect\";\r\nimport phoenixV2FileMap, { bundlePkgName } from './sourceDefine';\r\nimport { PrefabPathDefine } from \"./sourceDefine/prefabDefine\";\r\nimport { SoundPathDefine } from \"./sourceDefine/soundDefine\";\r\nimport fruitStore, { getStore } from './store';\r\nimport PhoenixV2MainViewModel from \"./viewModel/PhoenixV2MainViewModel\";\r\nimport { initGameStore } from \"./store/actions/game\";\r\nimport { initRoller } from \"./store/actions/roller\";\r\n\r\n\r\nlet sourceManageMap: Array<SourceManage> = []\r\nexport let bundlePhoenixV2: AssetManager.Bundle = null\r\nexport let mainViewModel: PhoenixV2MainViewModel;\r\nexport let phoenixV2_Audio: AudioMgr<SoundPathDefine>\r\nexport const sourceManageSeletor = (bundleName: string = bundlePkgName) => sourceManageMap.find(i => i.bundle.name === bundleName)\r\n\r\nexport enum NORMAL_MAG_TYPE {\r\n  /**切换游戏，特效中间触发 */\r\n  CHANGE_GAME\r\n}\r\n/**用于一般逻辑的监听器 */\r\nexport const msgListener = listenerFactoy<NORMAL_MAG_TYPE>()\r\nlet initTimeoutId = 0;\r\nexport const startUp = (rootNode: Node) => {\r\n  fruitStore.configureStore()\r\n\r\n  assetManager.loadBundle(bundlePkgName, (err, bundle) => {\r\n    bundlePhoenixV2 = bundle\r\n    bundlePhoenixV2.load(PrefabPathDefine.LOAING_PANEL, Prefab, (progress, total) => {\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.LOADING))\r\n      global.setSubGameGate(config.gameId, (progress / total))\r\n    }, (err, prefab) => {\r\n      if (!global.isAllowOpenSubGame(config.gameId)) return\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.READY))\r\n      const loaderviweModel = new LoaderPanelViewModel().mountView(prefab).appendTo(rootNode).setProps({\r\n        loadBarType: 1\r\n      }).setEvent({\r\n        onLoadDone: (_sourceManageMap) => {\r\n          sourceManageMap = _sourceManageMap\r\n          phoenixV2_Audio = new AudioMgr<SoundPathDefine>(sourceManageSeletor())\r\n          setActiveAudio(phoenixV2_Audio)\r\n\r\n          // 默认给10秒进入游戏超时处理，有时候socket连接成功之后，服务器没有发送进入房间 消息，导致卡住\r\n          initTimeoutId = window.setTimeout(() => {\r\n            global.closeSubGame({\r\n              confirmContent: lang.write(k => k.InitGameModule.GameBoardInit),\r\n              confirmDoneBeforeFn: () => destoryGame(loaderviweModel, initTimeoutId)\r\n            });\r\n            global.hallDispatch(addToastAction({ content: lang.write(k => k.InitGameModule.GameBoardInit, {}, { placeStr: \"game init failed\" }) }))\r\n            phoenixV2_Audio.playOneShot(SoundPathDefine.DING)\r\n          }, 10000);\r\n\r\n          // 卸载游戏方法\r\n          const destoryGame = (loaderviweModel: LoaderPanelViewModel, timeId: number) => {\r\n            loaderviweModel.unMount();\r\n            window.clearTimeout(timeId);\r\n          }\r\n\r\n          loaderviweModel.comp.setTipContent(lang.write(k => k.WebSocketModule.GameInit, {}, { placeStr: \"Game init...\" }))\r\n          global.hallDispatch(setSubGameRunState(SubGameRunState.RUN))\r\n          socketConnect().then(() => {\r\n            getStore().dispatch(initGameStore(0));\r\n            getStore().dispatch(initRoller(0));\r\n            mainViewModel = new PhoenixV2MainViewModel(() => {\r\n              destoryGame(loaderviweModel, initTimeoutId);\r\n            })\r\n              .mountView(sourceManageSeletor().getFile(PrefabPathDefine.MAIN_GAME).source)\r\n              .appendTo(rootNode)\r\n              .connect();\r\n            // 调整loader层级到最上层，让主界面初始化完成后才卸载\r\n            loaderviweModel.viewNode.isValid && loaderviweModel.viewNode.setSiblingIndex(loaderviweModel.viewNode.parent.children.length);\r\n          }).catch(e => loaderviweModel.comp.setTipContent(e || 'error'))\r\n        }\r\n      }).setProps({\r\n        versionStr: `md5: ${subGameList.find(i => i.gameId === config.gameId).md5}`\r\n      })\r\n      loaderviweModel.comp.startLoad([bundle], [...phoenixV2FileMap])\r\n    })\r\n  })\r\n}\r\n\r\nexport const stopGame = () => {\r\n  // log(\"stopGame\", initTimeoutId);\r\n  getStore().dispatch(initGameStore(0));\r\n  getStore().dispatch(initRoller(0));\r\n  initTimeoutId && window.clearTimeout(initTimeoutId);\r\n  mainViewModel && mainViewModel.unMount();\r\n  phoenixV2_Audio && phoenixV2_Audio.remove();\r\n  removeInstance();\r\n}"]}