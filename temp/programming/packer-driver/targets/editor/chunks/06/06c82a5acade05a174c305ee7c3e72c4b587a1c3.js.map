{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/dragon/Slot/Mediator/LoaderMediator.ts"],"names":["LoaderMediator","Prefab","SpriteFrame","assetManager","instantiate","PrefabDefine","BaseMediator","AudioManager","getBgProxy","global","addToastAction","setSubGameRunState","SubGameRunState","config","LoaderViewType","constructor","mediatorName","viewComponent","sourceMap","key","path","LOADER_PANEL","sourceType","source","listNotificationConst","name","INIT_LOADER_PANEL","handler","notification","panel","getSource","loadBundle","err","_bundle","getInstance","init","e","hallDispatch","content","String","load","progress","total","LOADING","setSubGameGate","gameId","prefab","isAllowOpenSubGame","READY","node","addChild","fileList","getBody","data","loaderScript","getComponent","remainNum","length","forEach","file","i","setLoadingProgress","getLoaderState","done","RUN","loadDir","SpriteFrames","console","log","setSpriteFrames","listenerEvent"],"mappings":"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","sourcesContent":["import { Prefab, Script, TypeScript, SpriteFrame, assetManager, instantiate, resources } from \"cc\";\r\nimport { INotification } from \"../../Framework/interfaces/INotification\";\r\nimport Mediator from \"../../Framework/patterns/mediator/Mediator\";\r\nimport { CommandDefine } from \"../Const/CommandDefine\";\r\nimport { PrefabDefine } from \"../Const/PrefabDefine\";\r\nimport BaseMediator from \"./BaseMediator\";\r\nimport { IlistTypeHander } from \"../types/IlistTypeHander\";\r\nimport { ISourceFile } from \"../types/ISourceFile\";\r\nimport { dragon_Loader } from \"../Component/dragon_Loader\";\r\nimport { AudioManager } from \"../Managr/AudioManager\";\r\nimport { getBgProxy } from \"../utils\";\r\nimport {global, lang} from \"../../../../hall\";\r\nimport {addToastAction, setSubGameRunState} from \"../../../../hall/store/actions/baseBoard\";\r\nimport { SubGameRunState } from \"../../../../hall/config\";\r\nimport config from \"../config\";\r\nexport enum LoaderViewType {\r\n  INIT_LOADER_PANEL = \"initLoaderPanel\"\r\n}\r\nexport default class LoaderMediator extends BaseMediator {\r\n  public constructor(mediatorName: string = null, viewComponent: any = null) {\r\n    super(mediatorName, viewComponent)\r\n  }\r\n  public sourceMap: Array<ISourceFile> = [\r\n    {\r\n      key: 'loaderPanel',\r\n      path: PrefabDefine.LOADER_PANEL,\r\n      sourceType: Prefab,\r\n      source: null\r\n    }\r\n  ]\r\n  protected listenerEvent() {\r\n\r\n  }\r\n  protected listNotificationConst: Array<IlistTypeHander<LoaderMediator>> = [\r\n    {\r\n      name: LoaderViewType.INIT_LOADER_PANEL,\r\n      handler(notification: INotification) {\r\n        const panel = this.getSource(PrefabDefine.LOADER_PANEL, false)\r\n\r\n        // resources.load(panel.path, Prefab, (err, prefab) => {\r\n        //   // 首先贴入加载框面板\r\n        //   const node = instantiate(prefab)\r\n        //   this.viewComponent.addChild(node)\r\n        //   const fileList: ISourceFile[] = notification.getBody().data\r\n        //   const loaderScript = <Loader>node.getComponent(\"Loader\")\r\n        //   let remainNum = fileList.length\r\n        //   //加载面板\r\n        //   fileList.forEach((file, i) => {\r\n        //     resources.load(file.path, Prefab, (err, prefab) => {\r\n        //       file.source = prefab\r\n        //       loaderScript.setLoadingProgress(file.key, fileList.length, --remainNum)\r\n        //       !remainNum && notification.getBody().done()\r\n        //     })\r\n        //   })\r\n        // })\r\n        assetManager.loadBundle(\"dragon\", async (err, _bundle) => {\r\n          // 首先贴入加载框面板\r\n            try{\r\n                await AudioManager.getInstance().init(_bundle)\r\n            }catch(e) {\r\n                global.hallDispatch(addToastAction({content: String(e)}))\r\n            }\r\n          _bundle.load(panel.path, Prefab, (progress, total) => {\r\n            global.hallDispatch(setSubGameRunState(SubGameRunState.LOADING))\r\n            global.setSubGameGate(config.gameId, (progress / total))\r\n          }, (err, prefab) => {\r\n            if (!global.isAllowOpenSubGame(config.gameId)) return\r\n            global.hallDispatch(setSubGameRunState(SubGameRunState.READY))\r\n            const node = instantiate(prefab)\r\n            this.viewComponent.addChild(node)\r\n            const fileList: ISourceFile[] = notification.getBody().data\r\n            const loaderScript = <dragon_Loader>node.getComponent(\"dragon_Loader\")\r\n            let remainNum = fileList.length\r\n            //加载面板\r\n            fileList.forEach((file, i) => {\r\n              _bundle.load(file.path, Prefab, (err, prefab) => {\r\n                file.source = prefab\r\n                loaderScript.setLoadingProgress(file.key, fileList.length, --remainNum)\r\n                if (loaderScript.getLoaderState()) {\r\n                  if (!remainNum) {\r\n                    notification.getBody().done()\r\n                    global.hallDispatch(setSubGameRunState(SubGameRunState.RUN))\r\n                  }\r\n                }\r\n              })\r\n            })\r\n          })\r\n          _bundle.loadDir('head', SpriteFrame, null, (err, SpriteFrames) => {\r\n            if (err) {\r\n              console.log(`theResourceFailedToLoad ${name}：`, err);\r\n            }\r\n            getBgProxy().setSpriteFrames(SpriteFrames)\r\n          })\r\n        })\r\n      }\r\n    }\r\n  ]\r\n}\r\n"]}