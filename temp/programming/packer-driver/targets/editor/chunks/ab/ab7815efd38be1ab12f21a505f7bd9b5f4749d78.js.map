{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/utils/BundleSplit.ts"],"names":["createBundle","id","data","options","onComplete","bundle","assetManager","bundles","get","name","AssetManager","BuiltinBundleName","RESOURCES","resources","Bundle","base","init","EDITOR","map","i","bundleName","indexOf","then","catch","e","config","subGameList","gameBundle","factory","register","getRemoteBundle","subGameInfo","progressFn","Promise","reslove","reject","gemeConfig","find","gameId","option","onFileProgress","n","t","url","enableRemote","gameBundleUrl","md5","loadGame","loadBundle","err1","_bundle","releaseBundle","releaseAll"],"mappings":"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","sourcesContent":["import { AssetManager, assetManager, resources } from \"cc\";\r\nimport { DEV, EDITOR } from \"cc/env\";\r\nimport { HallGameGateType, config, subGameList } from \"../hall/config\"\r\nimport { getPackageName } from \"../common/bridge\";\r\n\r\nfunction createBundle(id: string, data: any, options: Record<string, any>, onComplete: ((err: Error | null, data?: AssetManager.Bundle | null) => void)) {\r\n  let bundle = assetManager.bundles.get(data.name);\r\n  if (!bundle) {\r\n    bundle = data.name === AssetManager.BuiltinBundleName.RESOURCES ? resources : new AssetManager.Bundle();\r\n    data.base = data.base || `${id}/`;\r\n    bundle.init(data);\r\n  }\r\n  //HACK: Can not import scripts in GameView due to the difference of Scripting System between the GameView and Preview\r\n  if (!EDITOR && subGameList.map(i => i.bundleName).indexOf(bundle.name) !== -1) {\r\n    // if (!EDITOR && bundle.name !== bundleName) {\r\n    try {\r\n      import(`virtual:///prerequisite-imports/${bundle.name}`).then(() => {\r\n        onComplete(null, bundle);\r\n      }).catch(() => {\r\n        onComplete(null, bundle);\r\n      });\r\n    } catch (e) {\r\n      onComplete(null, bundle);\r\n    }\r\n\r\n  } else {\r\n    onComplete(null, bundle);\r\n  }\r\n}\r\n\r\nconst gameBundle: { [key: string]: AssetManager.Bundle } = {}\r\nexport default {\r\n  init: () => {\r\n    assetManager.factory.register(\"bundle\", createBundle)\r\n  },\r\n  getRemoteBundle: (subGameInfo: HallGameGateType, progressFn: (curr: number, total: number) => void): Promise<AssetManager.Bundle> => {\r\n    // return new Promise((reslove, reject) => {\r\n    //   assetManager.loadBundle(\"http://54.251.66.82:8008/subGame/yxx\",\r\n    //     {\r\n    //       version: \"9a011\",\r\n    //       onFileProgress: (n, t) => {\r\n    //         console.log(`${n}&${t}`)\r\n    //       }\r\n    //     }, (err, _bundle) => {\r\n    //       if (!err) {\r\n    //         reslove(_bundle)\r\n    //       } else {\r\n    //         reject(err)\r\n    //       }\r\n    //     })\r\n    // })\r\n    return new Promise((reslove, reject) => {\r\n      const gemeConfig = subGameList.find(i => i.gameId === subGameInfo.gameId)\r\n      const option = {\r\n        onFileProgress: (n, t) => {\r\n          progressFn(n, t)\r\n        }\r\n      }\r\n      const url = gemeConfig.enableRemote ? `${config.gameBundleUrl}/subGame/${subGameInfo.bundleName}` : subGameInfo.bundleName\r\n      gemeConfig.enableRemote && (option[\"version\"] = gemeConfig.md5)\r\n\r\n      const loadGame = () => {\r\n        assetManager.loadBundle(url, option,\r\n          (err1, _bundle) => {\r\n            if (!err1) {\r\n              gameBundle[subGameInfo.bundleName] = _bundle\r\n              reslove(_bundle)\r\n              // this.node.getChildByName(\"Label\").getComponent(Label).string = \"done\"\r\n            } else {\r\n              reject(err1)\r\n              // this.node.getChildByName(\"Label\").getComponent(Label).string = err1.message\r\n            }\r\n          })\r\n      }\r\n      loadGame()\r\n      // if (!DEV && getPackageName() === 'web' && window['installBundle']) {\r\n      //   // (document.querySelector(\"#loading2\") as any).style.display = 'block'\r\n      //   window['installBundle'](subGameInfo.bundleName)\r\n      //   window['onBundleInstallProgress'] = (bundleName: string, progress: number) => {\r\n      //     if (progress === 1) {\r\n      //       // (document.querySelector(\"#loading2\") as any).style.display = 'none'\r\n      //       loadGame()\r\n      //     } else {\r\n\r\n      //     }\r\n      //   }\r\n      // } else {\r\n      //   loadGame()\r\n      // }\r\n    })\r\n  },\r\n  releaseBundle: (gameId: number) => {\r\n    const gemeConfig = subGameList.find(i => i.gameId === gameId)\r\n    gameBundle[gemeConfig.bundleName].releaseAll()\r\n  }\r\n}"]}