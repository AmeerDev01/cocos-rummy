{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/utils/Fetcher.ts"],"names":["Fetcher","Prefab","sys","ToastType","addToastAction","setLoadingAction","baseBoardView","global","hallAudio","lang","sourceManageSeletor","SoundPathDefine","getStore","Throttler","sendNativeVibrate","BaseViewModel","PrefabPathDefine","EffectType","constructor","baseUrl","dispatch","send","url","sendData","method","headers","option","Promise","reslove","reject","param","Object","assign","Token","localStorage","getItem","_option","isLoading","JSON","stringify","isDebouncerAsync","hallDispatch","content","write","k","PersonCenterModule","PersonCenterSumbit","placeStr","then","isPass","isShow","fetch","response","status","json","data","code","message","mainPanelViewModel","logOut","loginPageV2ViewModel","comp","events","onOpenLoginDialog","getFileAsync","_PROHIBIT_PANEL","fileSource","prohibitViewModel","mountView","source","setEvent","onCloseHandle","unMount","EFFECT1","appendTo","viewNode","effectType","EFFECT2","isModal","type","ERROR","catch","InitGameModule","FetcherFaild","play","toString","e"],"mappings":"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","sourcesContent":["import { default as redux } from \"redux\";\r\nimport Singleton from \"./Singleton\";\r\nimport { ToastType, addToastAction, setLoadingAction } from \"../hall/store/actions/baseBoard\";\r\nimport { Prefab, sys } from \"cc\";\r\nimport { baseBoardView, global, hallAudio, lang, sourceManageSeletor } from \"../hall\";\r\nimport { SoundPathDefine } from \"../hall/sourceDefine/soundDefine\";\r\nimport { getStore } from \"../hall/store\";\r\nimport Throttler from \"./Throttler\";\r\nimport { sendNativeVibrate } from \"../common/bridge\";\r\nimport { Hall_ProhibitPanel, IState as HPState, IProps as HPProps, IEvent as HPEvent } from '../hall/components/login_v2/Hall_ProhibitPanel';\r\nimport BaseViewModel from \"../common/viewModel/BaseViewModel\";\r\nimport { PrefabPathDefine } from \"../hall/sourceDefine/prefabDefine\";\r\nimport { EffectType } from \"./NodeIOEffect\";\r\n\r\nexport default class Fetcher<T> {\r\n  constructor(baseUrl: string) {\r\n    this.baseUrl = baseUrl\r\n    this.dispatch = getStore().dispatch\r\n  }\r\n  private dispatch: redux.Dispatch\r\n  private baseUrl: string\r\n\r\n  send(url: T, sendData: object = {}, method: 'post' | 'get' | 'delete' = 'post', headers?: {}, option?: {}): Promise<any> {\r\n    return new Promise((reslove, reject) => {\r\n      const param = {\r\n        method,\r\n        headers: Object.assign({ 'Content-Type': 'application/json', Token: sys.localStorage.getItem(\"token\") || \"\" }, headers)\r\n      }\r\n      const _option = Object.assign({}, {\r\n        isLoading: true\r\n      }, option)\r\n      if (method !== \"get\") {\r\n        param[\"body\"] = JSON.stringify(sendData)\r\n      }\r\n      // console.log('u', this.baseUrl + url)\r\n      Throttler.isDebouncerAsync(this.baseUrl + url, 500, true, () => {\r\n        global.hallDispatch(addToastAction({ content: lang.write(k => k.PersonCenterModule.PersonCenterSumbit, {}, { placeStr: \"操作过于频繁，请稍等~\" }) }))\r\n      }).then((isPass) => {\r\n        _option.isLoading && this.dispatch(setLoadingAction({ isShow: true }))\r\n        fetch(this.baseUrl + url, param).then((response) => {\r\n          this.dispatch(setLoadingAction({ isShow: false }))\r\n          if (response.status === 200) {\r\n            response.json().then(({ data, code, status, message }) => {\r\n              if (status === \"SUCCESS\") {\r\n                reslove(data)\r\n              } else if (code === 'BIZ-5101') {\r\n                //跳转至登录页\r\n                this.dispatch(setLoadingAction({ isShow: false }))\r\n                if (baseBoardView.mainPanelViewModel) {\r\n                  baseBoardView.mainPanelViewModel.logOut()\r\n                } else {\r\n                  baseBoardView.loginPageV2ViewModel.comp.events.onOpenLoginDialog()\r\n                }\r\n              } else if (code === 'BIZ-5102') {\r\n                //IP被限制\r\n                sourceManageSeletor().getFileAsync(PrefabPathDefine._PROHIBIT_PANEL, Prefab).then((fileSource) => {\r\n                  const prohibitViewModel = new BaseViewModel<Hall_ProhibitPanel, HPState, HPProps, HPEvent>('Hall_ProhibitPanel').mountView(fileSource.source)\r\n                    .setEvent({ onCloseHandle: () => prohibitViewModel.unMount(EffectType.EFFECT1) }).appendTo(baseBoardView.viewNode, { effectType: EffectType.EFFECT2, isModal: true })\r\n                })\r\n              } else {\r\n                this.dispatch(addToastAction({ content: message, type: ToastType.ERROR }))\r\n                this.dispatch(setLoadingAction({ isShow: false }))\r\n                reject(message)\r\n              }\r\n            }).catch(() => {\r\n              this.dispatch(addToastAction({ content: lang.write(k => k.InitGameModule.FetcherFaild, {}, { placeStr: \"json数据解析失败\" }), type: ToastType.ERROR }))\r\n              this.dispatch(setLoadingAction({ isShow: false }))\r\n              // console.log(\"json数据解析失败\", response)\r\n              hallAudio.play(SoundPathDefine.ERROR)\r\n              reject(\"json数据解析失败\")\r\n            })\r\n          } else {\r\n            this.dispatch(addToastAction({ content: response.status.toString(), type: ToastType.ERROR }))\r\n            this.dispatch(setLoadingAction({ isShow: false }))\r\n            hallAudio.play(SoundPathDefine.ERROR)\r\n            reject(response)\r\n          }\r\n        }).catch((e) => {\r\n          sendNativeVibrate(100)\r\n          this.dispatch(addToastAction({ content: e.toString(), type: ToastType.ERROR }))\r\n          this.dispatch(setLoadingAction({ isShow: false }))\r\n          hallAudio.play(SoundPathDefine.ERROR)\r\n          reject(e)\r\n        })\r\n      })\r\n    })\r\n  }\r\n}"]}