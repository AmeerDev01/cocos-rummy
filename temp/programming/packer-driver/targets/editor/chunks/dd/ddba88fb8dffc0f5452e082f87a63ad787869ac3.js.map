{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/utils/StepNumber.ts"],"names":["StepNumber","Label","UIOpacity","UITransform","Vec3","instantiate","tween","constructor","beginNum","endNum","update","done","targetNode","flyLabelNode","flyHeight","flyHandler","timer","defaultStepTime","minKeepTime","maxKeepTime","step","currNum","set","setFlyNode","num","flyNode","active","getComponent","string","Math","abs","formatAmountWithCommas","setScale","addChild","x","y","z","position","to","height","easing","start","addComponent","opacity","call","destroy","stepTime","minDistance","maxDistance","distance","isFlyNumber","window","clearInterval","setInterval","stop"],"mappings":"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","sourcesContent":["import { Label, Node, UIOpacity, UITransform, Vec3, instantiate, tween } from \"cc\"\r\n/**\r\n * 步进数字\r\n */\r\nexport default class StepNumber {\r\n  constructor(beginNum: number, endNum: number, update: (num: number) => void, done?: () => void) {\r\n    this.beginNum = beginNum\r\n    this.endNum = endNum\r\n    this.update = update\r\n    this.done = done\r\n    this.set()\r\n  }\r\n  private targetNode: Node\r\n  private flyLabelNode: Node\r\n  private flyHeight: number\r\n  private flyHandler: (num: number) => void\r\n  /**\r\n   * 激活飘数字效果\r\n   * @param targetNode \r\n   * @param flyLabelNode \r\n   */\r\n  public setFlyNode(targetNode: Node, flyLabelNode: Node, flyHeight?: number) {\r\n    flyHeight && (this.flyHeight = flyHeight)\r\n    this.targetNode = targetNode\r\n    this.flyLabelNode = flyLabelNode\r\n    this.flyHandler = (num: number) => {\r\n      if (!this.flyLabelNode) return\r\n      const flyNode = instantiate(this.flyLabelNode)\r\n      flyNode.active = true\r\n      if (this.targetNode) {\r\n        flyNode.getComponent(Label).string = (num > 0 ? '+' : '-') + Math.abs(num).formatAmountWithCommas()\r\n        flyNode.setScale(0.9, 0.9)\r\n        this.targetNode.addChild(flyNode)\r\n        const { x, y, z } = flyNode.position\r\n        tween(flyNode).to(0.7, { position: new Vec3(x, y + (this.flyHeight || flyNode.getComponent(UITransform).height), z) }, { easing: \"backOut\" }).start()\r\n        !flyNode.getComponent(UIOpacity) && (flyNode.addComponent(UIOpacity))\r\n        tween(flyNode.getComponent(UIOpacity)).to(0.8, { opacity: 0 }).call(() => {\r\n          flyNode.destroy()\r\n        }).start()\r\n      }\r\n    }\r\n  }\r\n  /**设置步进时间(默认步进时间20ms)，传入步进时间，你可以通过控制步进时间间接控制步进量 */\r\n  public set(stepTime: number = 20) {\r\n    stepTime && (this.defaultStepTime = stepTime)\r\n    // 比如50ms一次，每次变量10，持续时间最低1000ms~5000ms，那么数字间隔最低为1000/50 * 10 = 200,最高5000/50 * 10=1000，如果超越这个区间，将动态调整变量\r\n    const minDistance = (this.minKeepTime / this.defaultStepTime) * this.step\r\n    const maxDistance = (this.maxKeepTime / this.defaultStepTime) * this.step\r\n    const distance = this.endNum - this.beginNum\r\n    if (Math.abs(distance) <= minDistance || Math.abs(distance) >= maxDistance) {\r\n      // 重算步进量\r\n      this.step = distance / (this.minKeepTime / this.defaultStepTime)\r\n    } else {\r\n      distance < 0 && (this.step = this.step * -1)\r\n    }\r\n    // distance < 0 && (this.step = this.step * -1)\r\n    return this;\r\n  }\r\n  /**\r\n   * 开始执行\r\n   * @param isFlyNumber 是否激活数字飘动效果，前提是要设置flyHandler\r\n   * @returns \r\n   */\r\n  public start(isFlyNumber: boolean = true) {\r\n    this.timer && window.clearInterval(this.timer)\r\n    if (Math.abs(this.endNum - this.beginNum) < this.step) {\r\n      //如果间隔都没有步进量来的大，直接结束\r\n      this.update(this.endNum)\r\n      this.done && this.done()\r\n      return\r\n    }\r\n    this.currNum = this.beginNum\r\n    // console.log(this.endNum - this.beginNum)\r\n    this.flyHandler && isFlyNumber && this.flyHandler(this.endNum - this.beginNum)\r\n    this.timer = window.setInterval(() => {\r\n      this.currNum += this.step\r\n      //乘以2是怕越过终点，这样就停不下来了\r\n      if (Math.abs(this.currNum - this.endNum) <= Math.abs(this.step)) {\r\n        this.stop()\r\n      } else {\r\n        this.update(this.currNum)\r\n      }\r\n    }, this.defaultStepTime)\r\n  }\r\n  /**调过过程，直接变成目标值 */\r\n  public stop() {\r\n    this.currNum = this.endNum\r\n    this.update(this.endNum)\r\n    window.clearInterval(this.timer)\r\n    this.done && this.done()\r\n  }\r\n  private update: (num: number) => void\r\n  private done: () => void\r\n  private timer: number\r\n  /**默认的步进时间 */\r\n  private defaultStepTime = 20\r\n  /**最小持续时间 */\r\n  private readonly minKeepTime = 500\r\n  /**最大持续时间 */\r\n  private readonly maxKeepTime = 2000\r\n  /**步进量 */\r\n  private step = 10\r\n  /**在变化的值 */\r\n  private currNum = 0\r\n  private beginNum: number = 0\r\n  private endNum: number = 0\r\n}"]}