{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/domino/index.ts"],"names":["Prefab","assetManager","LoaderPanelViewModel","AudioMgr","config","socketConnect","removeInstance","dominoFileMap","bundlePkgName","PrefabPathDefine","SoundPathDefine","dominoStore","RoomChooseViewModel","TestViewModel","global","lang","addToastAction","setSubGameRunState","SubGameRunState","getStore","sourceManageMap","bundleDomino","sourceManageSeletor","bundleName","find","i","bundle","name","initTimeoutId","startUp","rootNode","dispatch","configureStore","loadBundle","err","load","LOAING_PANEL","progress","total","hallDispatch","LOADING","setSubGameGate","gameId","prefab","isAllowOpenSubGame","READY","loaderviweModel","mountView","appendTo","setProps","loadBarType","setEvent","onLoadDone","_sourceManageMap","domino_Audio","remove","comp","setTipContent","write","k","WebSocketModule","GameInit","placeStr","RUN","window","setTimeout","closeSubGame","confirmContent","InitGameModule","GameBoardInit","content","socketHandle","clearTimeout","unMount","then","roomChooseViewModel","getFile","ROOM_CHOOSE","source","connect","playBg","isTest","TEST","catch","e","startLoad","stopGame","play","domino_jl_bk","playBtnClick","playOneShot","btn_click","playChooseCard","domino_choose_card","playCoin","domino_coin","playFapai","domino_fapai","playGameBegin","domino_game_begin","playGuoPai","domino_guopai","playSend","domino_send","playTimeout","domino_time_out","playWin","domino_win","playDead","domino_dead"],"mappings":"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","sourcesContent":["import { AssetManager, Node, Prefab, assetManager } from \"cc\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport LoaderPanelViewModel from \"../../common/viewModel/LoaderPanelViewModel\";\r\nimport { AudioMgr } from \"../../utils/AudioMgr\";\r\nimport config from \"./config\";\r\nimport socketConnect, { removeInstance } from \"./socketConnect\";\r\nimport dominoFileMap, { bundlePkgName } from \"./sourceDefine\";\r\nimport { PrefabPathDefine } from \"./sourceDefine/prefabDefine\";\r\nimport { SoundPathDefine } from \"./sourceDefine/soundDefine\";\r\nimport dominoStore from './store';\r\nimport RoomChooseViewModel from \"./viewModel/RoomChooseViewModel\";\r\nimport TestViewModel from \"./viewModel/TestViewModel\";\r\nimport { global, lang } from \"../../hall\";\r\nimport { addToastAction, setSubGameRunState } from \"../../hall/store/actions/baseBoard\";\r\nimport { SubGameRunState } from \"../../hall/config\";\r\nimport { getStore } from \"../../hall/store\";\r\n\r\nlet sourceManageMap: Array<SourceManage> = []\r\nexport let bundleDomino: AssetManager.Bundle = null\r\nexport let domino_Audio: AudioMgr<SoundPathDefine>\r\nexport let roomChooseViewModel: RoomChooseViewModel\r\nexport const sourceManageSeletor = (bundleName: string = bundlePkgName) => sourceManageMap.find(i => i.bundle.name === bundleName)\r\nexport let rootNode: Node\r\nlet initTimeoutId = 0;\r\n\r\nexport const startUp = (rootNode: Node) => {\r\n  const dispatch = getStore().dispatch\r\n  rootNode = rootNode\r\n  dominoStore.configureStore()\r\n  assetManager.loadBundle(bundlePkgName, (err, bundle) => {\r\n    bundleDomino = bundle\r\n    bundleDomino.load(PrefabPathDefine.LOAING_PANEL, Prefab, (progress, total) => {\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.LOADING))\r\n      global.setSubGameGate(config.gameId, (progress / total))\r\n    }, (err, prefab) => {\r\n      if (!global.isAllowOpenSubGame(config.gameId)) return\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.READY))\r\n      const loaderviweModel = new LoaderPanelViewModel().mountView(prefab).appendTo(rootNode).setProps({\r\n        loadBarType: 1\r\n      }).setEvent({\r\n        onLoadDone: (_sourceManageMap) => {\r\n          sourceManageMap = _sourceManageMap\r\n          domino_Audio && domino_Audio.remove();\r\n          domino_Audio = new AudioMgr<SoundPathDefine>(sourceManageSeletor())\r\n          loaderviweModel.comp.setTipContent(lang.write(k => k.WebSocketModule.GameInit, {}, { placeStr: \"Game init...\" }))\r\n          global.hallDispatch(setSubGameRunState(SubGameRunState.RUN))\r\n          // 默认给10秒进入游戏超时处理，有时候socket连接成功之后，服务器没有发送进入房间 消息，导致卡住\r\n          initTimeoutId = window.setTimeout(() => {\r\n            global.closeSubGame({\r\n              confirmContent: lang.write(k => k.InitGameModule.GameBoardInit)\r\n            });\r\n            dispatch(addToastAction({ content: lang.write(k => k.InitGameModule.GameBoardInit, {}, { placeStr: \"game init failed\" }) }))\r\n          }, 10000);\r\n\r\n          const socketHandle = () => {\r\n            initTimeoutId && window.clearTimeout(initTimeoutId);\r\n            loaderviweModel.unMount().then(() => {\r\n              \r\n              roomChooseViewModel = new RoomChooseViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.ROOM_CHOOSE).source).appendTo(rootNode).connect()\r\n\r\n              playBg();\r\n\r\n              if (config.isTest) {\r\n                new TestViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.TEST).source).appendTo(rootNode).connect()\r\n              }\r\n            })\r\n          }\r\n\r\n          if (config.isTest) {\r\n            socketConnect();\r\n            socketHandle();\r\n          } else {\r\n            socketConnect().then(socketHandle).catch(e => loaderviweModel.comp.setTipContent(e || 'error'))\r\n          }\r\n        }\r\n      })\r\n      loaderviweModel.comp.startLoad([bundle], [...dominoFileMap])\r\n    })\r\n  })\r\n}\r\n\r\nexport const stopGame = () => {\r\n  // log(\"stopGame\", initTimeoutId);\r\n  initTimeoutId && window.clearTimeout(initTimeoutId);\r\n  roomChooseViewModel && roomChooseViewModel.unMount();\r\n  domino_Audio && domino_Audio.remove();\r\n  removeInstance();\r\n}\r\n\r\nexport const playBg = () => {\r\n  domino_Audio.play(SoundPathDefine.domino_jl_bk, true);\r\n}\r\nexport const playBtnClick = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.btn_click);\r\n}\r\nexport const playChooseCard = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_choose_card);\r\n}\r\nexport const playCoin = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_coin);\r\n}\r\nexport const playFapai = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_fapai);\r\n}\r\nexport const playGameBegin = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_game_begin);\r\n}\r\nexport const playGuoPai = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_guopai);\r\n}\r\nexport const playSend = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_send);\r\n}\r\nexport const playTimeout = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_time_out);\r\n}\r\nexport const playWin = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_win);\r\n}\r\nexport const playDead = () => {\r\n  domino_Audio.playOneShot(SoundPathDefine.domino_dead);\r\n}"]}