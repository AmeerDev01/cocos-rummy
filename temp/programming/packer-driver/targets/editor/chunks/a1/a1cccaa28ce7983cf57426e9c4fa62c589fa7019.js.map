{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/base/ViewModel.ts"],"names":["ViewModel","StoreInject","store","constructor","instantiate","find","tween","UIOpacity","getStore","getEffectByType","hallAudio","SoundPathDefine","viewModelMap","componentStr","isUnMount","parentNode","unsubscribe","isModal","modalBg","props","prefabSource","viewNode","comp","unMountCallBack","dispatch","action","appendTo","option","_option","Object","assign","effectType","effectDone","effectOption","active","uiOpacity","getComponent","addComponent","opacity","to","start","addChild","playOneShot","POP_UP","done","window","setTimeout","begin","enter","then","uuid","mountView","unMount","Promise","reslove","reject","destroy","call","e","console","error","out","setProps","force","setEvent","enevts","inject","initProps","mapStateToProps","subscribe","newPropsPart","getState"],"mappings":"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","sourcesContent":["import { Node, Prefab, Component, assetManager, instantiate, find, tween, UIOpacity } from \"cc\"\r\nimport { getStore } from \"../hall/store\"\r\nimport { BaseComponent } from \"./BaseComponent\";\r\nimport { EffectType, EnterOption, getEffectByType } from \"../utils/NodeIOEffect\";\r\nimport { Action, AnyAction, default as redux } from \"redux\";\r\nimport { hallAudio } from \"../hall\";\r\nimport { SoundPathDefine } from \"../hall/sourceDefine/soundDefine\";\r\n\r\nexport const viewModelMap: { [key: string]: ViewModel<any, unknown, unknown> } = {}\r\n/**BaseViewModel为特定的功能而设计，在这里撰写主逻辑 */\r\nabstract class ViewModel<C extends BaseComponent<any, P, E>, P, E> {\r\n  constructor(componentStr: string) {\r\n    this.componentStr = componentStr\r\n    this.store = getStore()\r\n  }\r\n  protected componentStr: string\r\n  protected store\r\n  /**是否已卸载(此值在卸载开始之时就已赋值) */\r\n  public isUnMount: boolean = false\r\n  /**被挂载的父节点 */\r\n  public parentNode: Node\r\n  /**取消订阅 */\r\n  private unsubscribe: () => void\r\n  /**是否是模态弹出框的模式 */\r\n  private isModal: boolean = false\r\n  /**模态框的底层透明层 */\r\n  private modalBg: Node = null\r\n  /**自身的props，一般选择使用组件的 */\r\n  private props: P\r\n  /**未实例化的预制体 */\r\n  public prefabSource: Prefab\r\n  /**已经实例化的节点对象 */\r\n  public viewNode: Node\r\n  /**脚本组件 */\r\n  public comp: C\r\n  /**链接到redux-store-state，当然，不接入redux，就不调用 */\r\n  // public abstract connect(store: redux.Store<any, redux.AnyAction>): void\r\n  public abstract connect(initProps?: Partial<P>): void\r\n  // public abstract connect(storeState: StateType): void\r\n\r\n  /**视图初始化并挂载到节点上后要执行的动作（appendTo之后要执行的动作） */\r\n  protected abstract begin(): void\r\n  /**卸载时的回调函数 */\r\n  protected unMountCallBack() { }\r\n  protected dispatch(action: AnyAction) {\r\n    this.store.dispatch(action)\r\n  }\r\n\r\n  /**挂载到视图 */\r\n  public appendTo(parentNode: Node, option?: {\r\n    /**添加到节点的动效 */\r\n    effectType?: EffectType,\r\n    /**添加完成之后的回调 */\r\n    effectDone?: () => void,\r\n    /**是否以模态框的形式添加，既后面加一层模态框 */\r\n    isModal?: boolean,\r\n    effectOption?: EnterOption\r\n\r\n  }) {\r\n    const _option = Object.assign({\r\n      effectType: null,\r\n      effectDone: null,\r\n      isModal: false,\r\n      effectOption: {}\r\n    }, option || {})\r\n    this.isModal = _option.isModal\r\n    this.parentNode = parentNode\r\n    if (_option.isModal) {\r\n      this.modalBg = instantiate(find(\"Canvas/modalBg\"))\r\n      this.modalBg.active = true\r\n      const uiOpacity = this.modalBg.getComponent(UIOpacity) || this.modalBg.addComponent(UIOpacity);\r\n      uiOpacity.opacity = 0\r\n      tween(uiOpacity).to(0.1, { opacity: 255 }).start()\r\n      this.modalBg.addChild(this.viewNode)\r\n      parentNode.addChild(this.modalBg)\r\n      hallAudio && hallAudio.playOneShot(SoundPathDefine.POP_UP)\r\n    } else {\r\n      parentNode.addChild(this.viewNode)\r\n    }\r\n    const done = () => window.setTimeout(() => {\r\n      this.begin()\r\n    }, 10)\r\n    _option.effectType !== null ? getEffectByType(_option.effectType)(this.viewNode).enter(_option.effectOption).then(() => {\r\n      _option.effectDone && _option.effectDone()\r\n      done()\r\n    }) : done()\r\n    viewModelMap[this.viewNode.uuid] = this\r\n    return this\r\n  }\r\n\r\n  /**初始化视图对象，告知viewmodel需要实例化的预制体和组件脚本(若不执行这个，节点对象和自定义脚本将无法调用) */\r\n  public mountView(prefabSource: Prefab) {\r\n    // this.prefabFile = PrefabFiles.find(item => item.path === prefabFile).source\r\n    this.prefabSource = prefabSource//sourceManage.getFile(\"hall\", prefabPath)?.source\r\n    this.viewNode = instantiate(prefabSource)\r\n    this.viewNode.addComponent(this.componentStr)\r\n    this.comp = this.viewNode.getComponent(this.componentStr) as C\r\n    return this\r\n  }\r\n  /**卸载(销毁节点，且取消订阅) */\r\n  public unMount(effectType: EffectType = null) {\r\n    // hallAudio && hallAudio.playOneShot(SoundPathDefine.BTU_CLICK)\r\n    this.isUnMount = true\r\n    return new Promise((reslove, reject) => {\r\n      this.unsubscribe && this.unsubscribe()\r\n      if (this.viewNode) {\r\n        const done = () => {\r\n          try {\r\n            // this.viewNode && this.viewNode.removeAllChildren()\r\n            this.comp && this.comp.destroy()\r\n            this.viewNode && this.viewNode.destroy()\r\n            if (this.isModal) {\r\n              const uiOpacity = this.modalBg.getComponent(UIOpacity) || this.modalBg.addComponent(UIOpacity);\r\n              tween(uiOpacity).to(0.1, { opacity: 0 }).call(() => this.modalBg.destroy()).start()\r\n            }\r\n            this.unMountCallBack()\r\n            reslove(true)\r\n          } catch (e) {\r\n            console.error(e)\r\n            reslove(true)\r\n          }\r\n        }\r\n        effectType !== null ? getEffectByType(effectType)(this.viewNode).out(false).then(() => done()) : done()\r\n      } else {\r\n        reject(\"The view has been destroied!\")\r\n      }\r\n\r\n    })\r\n  }\r\n  public setProps(props: Partial<P>, force: boolean = false) {\r\n    // this.props = props\r\n    this.comp.setProps(props, force)\r\n    return this\r\n  }\r\n\r\n  public setEvent(enevts: Partial<E>) {\r\n    this.comp.setEvent(enevts)\r\n    return this\r\n  }\r\n  /**\r\n   * redux的状态注入器\r\n   * @param initProps 注入时的默认props(如果页面已经挂载会触发更新)\r\n   * @param mapStateToProps props对redux-state的订阅映射\r\n   * @param force 是否强制触发订阅函数（默认情况下，若新旧的state数据一致，将不会触发错误，若force=true，将强制触发，比如适用于toast，两次触发toast的字符串是一样的，需要忽略数据是否更新。请慎用true）\r\n   * @returns \r\n   */\r\n  protected inject(initProps: Partial<P>, mapStateToProps: (state: any) => P, force: boolean = false) {\r\n    this.props = Object.assign({}, this.props, initProps)\r\n    this.comp.setProps(this.props)\r\n    this.dispatch = this.store.dispatch\r\n    this.comp.dispatch = this.store.dispatch\r\n    this.unsubscribe = this.store.subscribe(() => {\r\n      const newPropsPart = mapStateToProps(this.store.getState())\r\n      this.props = Object.assign({}, this.props, newPropsPart)\r\n      this.comp.setProps(this.props, force)\r\n    })\r\n    return this\r\n  }\r\n\r\n}\r\nexport default ViewModel\r\n\r\n\r\nexport function StoreInject(store: redux.Store<any, redux.AnyAction>) {\r\n  return function <T extends { new(...args: any[]): {} }>(constructor: T) {\r\n    return class extends constructor {\r\n      store = store\r\n    }\r\n  }\r\n}\r\n"]}