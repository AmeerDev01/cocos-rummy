{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/viewModel/GiftUserViewModel.ts"],"names":["GiftUserViewModel","Sprite","instantiate","sp","tween","ViewModel","GIFT_ICON_CONFIG","commonAudio","sourceManageSeletor","PrefabPathDefine","isChatShieldingUser","SoundPathDefine","BANKER_ID","GameType","initStatus","constructor","begin","connect","initProps","inject","show","parent","gameType","userInfo","callback","instance","viewNode","active","setSiblingIndex","children","length","mountView","getFile","GIFT_USER","source","appendTo","memberId","playOneShot","spin","setProps","isUser","head","gold","name","setEvent","selectGift","value","count","i","window","setTimeout","flyGift","fromMemberId","toMemberId","startPos","endPos","sourceFile","GIFT_ANIMATION","console","error","iconConfig","getIconConfig","node","addChild","sprGiftNode","getChildByName","getComponent","spriteFrame","spriteFramePath","giftAnimationNode","skeleton","Skeleton","skeletonPath","skeletonData","setAnimation","paused","setCompleteListener","destroy","setWorldPosition","add","offset","to","worldPosition","angle","call","isValid","dub","start","find","v","undefined"],"mappings":"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","sourcesContent":["import { Node, Sprite, Vec3, instantiate, sp, tween } from \"cc\"\r\nimport ViewModel from \"../../base/ViewModel\"\r\nimport { Common_GiftUser, IProps, IEvent, GIFT_ICON_CONFIG } from \"../components/Common_GiftUser\"\r\nimport { commonAudio, sourceManageSeletor } from \"../../hall\"\r\nimport { PrefabPathDefine } from \"../sourceDefine/prefabDefine\"\r\nimport { isChatShieldingUser } from \"../../utils/tool\"\r\nimport { SoundPathDefine } from \"../sourceDefine/soundDefine\"\r\n\r\nexport const BANKER_ID = \"1100000\";\r\n\r\nexport enum GameType {\r\n  /**鱼虾蟹 */\r\n  YXX = 1,\r\n  /**龙虎 */\r\n  DRAGON_TIGER = 2,\r\n  /**BANDER球球 */\r\n  BANDAR_QIU_QIU = 3,\r\n  /**BANDER */\r\n  BANDAR = 4,\r\n}\r\n\r\nexport type UserInfo = {\r\n  memberId: string,\r\n  head: number,\r\n  name: string,\r\n  gold: number\r\n}\r\n\r\nlet initStatus = false;\r\n\r\nclass GiftUserViewModel extends ViewModel<Common_GiftUser, IProps, IEvent> {\r\n  constructor() {\r\n    super('Common_GiftUser')\r\n  }\r\n  protected begin() {\r\n    initStatus = false;\r\n  }\r\n  public connect(initProps: Partial<IProps> = {}) {\r\n    this.inject(initProps, () => {\r\n      return {\r\n      }\r\n    })\r\n    return this\r\n  }\r\n\r\n  private static instance: GiftUserViewModel = null;\r\n\r\n  /**\r\n   * 显示礼物窗口\r\n   * @param parent \r\n   * @param gameType 游戏类型\r\n   * @param userInfo \r\n   * @param startPos \r\n   * @param endPos \r\n   */\r\n  public static show(parent: Node, gameType: GameType, userInfo: UserInfo | null, callback: (value: number, memberId?: string) => void) {\r\n    if (initStatus) {\r\n      return;\r\n    }\r\n    initStatus = true;\r\n    if (this.instance) {\r\n      this.instance.viewNode.active = true;\r\n      this.instance.viewNode.setSiblingIndex(this.instance.viewNode.parent.children.length);\r\n      initStatus = false;\r\n    } else {\r\n      this.instance = new GiftUserViewModel().mountView(sourceManageSeletor(\"common\").getFile(PrefabPathDefine.GIFT_USER).source).appendTo(parent)\r\n    }\r\n    const memberId = userInfo ? userInfo.memberId : BANKER_ID;\r\n    commonAudio.playOneShot(SoundPathDefine.spin);\r\n    this.instance.setProps({\r\n      isUser: userInfo ? true : false,\r\n      gameType: gameType,\r\n      head: userInfo ? userInfo.head : 0,\r\n      gold: userInfo ? userInfo.gold : 0,\r\n      name: userInfo ? userInfo.name : \"\",\r\n      memberId: userInfo ? userInfo.memberId : \"\",\r\n    }).setEvent({\r\n      selectGift: (value: number, count: number) => {\r\n        for (let i = 0; i < count; i++) {\r\n          window.setTimeout(() => {\r\n            callback && callback(value, memberId);\r\n          }, 200 * i)\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 飞礼物\r\n   * @param parent \r\n   * @param fromMemberId 开始的用户id\r\n   * @param toMemberId 结束的用户id\r\n   * @param startPos \r\n   * @param endPos \r\n   * @param value \r\n   * @param count 执行次数\r\n   */\r\n  public static flyGift(parent: Node, fromMemberId: string, toMemberId: string, startPos: Vec3, endPos: Vec3, value: number) {\r\n    if (isChatShieldingUser(fromMemberId) || isChatShieldingUser(toMemberId)) {\r\n      return;\r\n    }\r\n    if (!startPos || !endPos) {\r\n      return;\r\n    }\r\n    const sourceFile = sourceManageSeletor(\"common\").getFile(PrefabPathDefine.GIFT_ANIMATION);\r\n    if (!sourceFile) {\r\n      console.error(PrefabPathDefine.GIFT_ANIMATION, \" prefab not fround\")\r\n      return;\r\n    }\r\n\r\n    const iconConfig = this.getIconConfig(value)\r\n    if (!iconConfig) {\r\n      console.error(\"gift spriteFrame is null\")\r\n      return;\r\n    }\r\n\r\n    const node = instantiate(sourceFile.source) as Node;\r\n    parent.addChild(node);\r\n\r\n    const sprGiftNode = node.getChildByName(\"props_spr_gift\").getComponent(Sprite);\r\n    sprGiftNode.spriteFrame = sourceManageSeletor(\"common\").getFile(iconConfig.spriteFramePath).source;\r\n    const giftAnimationNode = node.getChildByName(\"props_gift_animation\")\r\n    const skeleton = giftAnimationNode.getComponent(sp.Skeleton);\r\n\r\n    const source = sourceManageSeletor(\"common\").getFile(iconConfig.skeletonPath).source\r\n    skeleton.skeletonData = source;\r\n    skeleton.setAnimation(0, \"animation\", false);\r\n    skeleton.paused = true;\r\n    giftAnimationNode.active = false;\r\n    skeleton.setCompleteListener(() => {\r\n      node.destroy();\r\n    })\r\n    node.setWorldPosition(startPos)\r\n\r\n    endPos = endPos.add(iconConfig.offset)\r\n    tween(node).to(0.5, { worldPosition: endPos, angle: iconConfig.angle }).call(() => {\r\n      if (node.isValid) {\r\n        giftAnimationNode.active = true;\r\n        sprGiftNode.node.active = false;\r\n        skeleton.paused = false;\r\n        commonAudio.playOneShot(iconConfig.dub);\r\n      }\r\n    }).start();\r\n  }\r\n\r\n  private static getIconConfig(value: number) {\r\n    const iconConfig = GIFT_ICON_CONFIG.find(v => v.value === value)\r\n    if (iconConfig) {\r\n      return iconConfig;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n\r\nexport default GiftUserViewModel"]}