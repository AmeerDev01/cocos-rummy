{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/thor/index.ts"],"names":["Prefab","assetManager","fruitStore","bundlePkgName","PrefabPathDefine","LoaderPanelViewModel","thorFileMap","SubGameRunState","socketConnect","HeaderViewModel","FooterViewModel","GameBoardViewModel","listenerFactoy","AudioMgr","setActiveAudio","config","global","lang","addToastAction","setSubGameRunState","WinShowViewModel","RoleViewModel","sourceManageMap","bundleThor","sourceManageSeletor","bundleName","find","i","bundle","name","NORMAL_MAG_TYPE","msgListener","startUp","rootNode","configureStore","initTimeoutId","loadBundle","err","load","LOAING_PANEL","progress","total","hallDispatch","LOADING","setSubGameGate","gameId","prefab","isAllowOpenSubGame","READY","loaderviweModel","mountView","appendTo","setProps","loadBarType","setEvent","onLoadDone","_sourceManageMap","thor_Audio","comp","setTipContent","write","k","WebSocketModule","GameInit","placeStr","window","setTimeout","closeSubGame","confirmContent","InitGameModule","GameBoardInit","confirmDoneBeforeFn","destoryGame","content","timeId","unMount","clearTimeout","then","RUN","gameBoardViewModel","getFile","GAME_BOARD","source","connect","winShowViewModel","WINSHOW","getWrapNode","roleViewModel","THORROLE","footerViewModel","FOOTER_DOWN","headerViewModel","HEADER_UP","viewNode","isValid","setSiblingIndex","parent","children","length","scheduleOnce","catch","e","startLoad"],"mappings":"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","sourcesContent":["import { AssetManager, Node, Prefab, assetManager, sys } from \"cc\"\r\nimport fruitStore from './store';\r\nimport { bundlePkgName } from \"./sourceDefine\";\r\nimport { PrefabPathDefine } from \"./sourceDefine/prefabDefine\";\r\nimport LoaderPanelViewModel from \"../../common/viewModel/LoaderPanelViewModel\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport thorFileMap from './sourceDefine';\r\nimport { SubGameRunState, config as hallConfig, subGameList } from \"../../hall/config\";\r\nimport socketConnect, { SKT_MAG_TYPE, sktInstance } from \"./socketConnect\";\r\nimport HeaderViewModel from \"./viewModel/HeaderViewModel\";\r\nimport FooterViewModel from \"./viewModel/FooterViewModel\";\r\nimport GameBoardViewModel from \"./viewModel/GameBoardViewModel\";\r\nimport { listenerFactoy } from \"../../common/listenerFactoy\";\r\nimport { AudioMgr } from \"../../utils/AudioMgr\";\r\nimport { SoundPathDefine } from \"./sourceDefine/soundDefine\";\r\nimport { setActiveAudio } from \"../../utils/UseSetOption\";\r\nimport config from \"./config\";\r\nimport { baseBoardView, global, lang } from \"../../hall\";\r\nimport { addToastAction, setSubGameRunState } from \"../../hall/store/actions/baseBoard\";\r\nimport baseBoard from \"../../hall/store/reducer/baseBoard\";\r\nimport WinShowViewModel from \"./viewModel/WinShowViewModel\";\r\nimport RoleViewModel from \"./viewModel/RoleViewModel\";\r\n\r\n\r\nlet sourceManageMap: Array<SourceManage> = []\r\nexport let bundleThor: AssetManager.Bundle = null\r\nexport let gameBoardViewModel: GameBoardViewModel\r\nexport let footerViewModel: FooterViewModel\r\nexport let headerViewModel: HeaderViewModel\r\nexport let winShowViewModel: WinShowViewModel\r\nexport let roleViewModel: RoleViewModel\r\nexport let thor_Audio: AudioMgr<SoundPathDefine>\r\nexport const sourceManageSeletor = (bundleName: string = 'thor') => sourceManageMap.find(i => i.bundle.name === bundleName)\r\n\r\nexport enum NORMAL_MAG_TYPE {\r\n  /**切换游戏，特效中间触发 */\r\n  CHANGE_GAME\r\n}\r\n/**用于一般逻辑的监听器 */\r\nexport const msgListener = listenerFactoy<NORMAL_MAG_TYPE>()\r\nexport const startUp = (rootNode: Node) => {\r\n  fruitStore.configureStore()\r\n  let initTimeoutId = 0;\r\n  assetManager.loadBundle(bundlePkgName, (err, bundle) => {\r\n    bundleThor = bundle\r\n    bundleThor.load(PrefabPathDefine.LOAING_PANEL, Prefab, (progress, total) => {\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.LOADING))\r\n      global.setSubGameGate(config.gameId, (progress / total))\r\n    }, (err, prefab) => {\r\n      if (!global.isAllowOpenSubGame(config.gameId)) return\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.READY))\r\n      const loaderviweModel = new LoaderPanelViewModel().mountView(prefab).appendTo(rootNode).setProps({\r\n        loadBarType: 1\r\n      }).setEvent({\r\n        onLoadDone: (_sourceManageMap) => {\r\n          sourceManageMap = _sourceManageMap\r\n          thor_Audio = new AudioMgr<SoundPathDefine>(sourceManageSeletor())\r\n          setActiveAudio(thor_Audio)\r\n          // hallConfig.gameConfig.find(item => item.name === \"thor\")\r\n          loaderviweModel.comp.setTipContent(lang.write(k => k.WebSocketModule.GameInit, {}, { placeStr: \"Game init...\" }))\r\n          initTimeoutId = window.setTimeout(() => {\r\n            global.closeSubGame({\r\n              confirmContent: lang.write(k => k.InitGameModule.GameBoardInit),\r\n              confirmDoneBeforeFn: () => destoryGame(loaderviweModel, initTimeoutId)\r\n            });\r\n            global.hallDispatch(addToastAction({ content: lang.write(k => k.InitGameModule.GameBoardInit, {}, { placeStr: \"game init failed\" }) }))\r\n          }, 15000);\r\n          const destoryGame = (loaderviweModel: LoaderPanelViewModel, timeId: number) => {\r\n            loaderviweModel.unMount();\r\n            window.clearTimeout(timeId);\r\n          }\r\n          socketConnect().then(() => {\r\n            global.hallDispatch(setSubGameRunState(SubGameRunState.RUN))\r\n              gameBoardViewModel = new GameBoardViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.GAME_BOARD).source).appendTo(rootNode).connect()\r\n              winShowViewModel = new WinShowViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.WINSHOW).source).appendTo(gameBoardViewModel.comp.getWrapNode()).connect()\r\n              roleViewModel = new RoleViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.THORROLE).source).appendTo(gameBoardViewModel.comp.getWrapNode()).connect()\r\n              footerViewModel = new FooterViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.FOOTER_DOWN).source).appendTo(gameBoardViewModel.comp.getWrapNode()).connect()\r\n              headerViewModel = new HeaderViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.HEADER_UP).source).appendTo(gameBoardViewModel.comp.getWrapNode()).connect()\r\n              loaderviweModel.viewNode.isValid && loaderviweModel.viewNode.setSiblingIndex(loaderviweModel.viewNode.parent.children.length);\r\n              loaderviweModel.comp.scheduleOnce(()=>{\r\n                destoryGame(loaderviweModel, initTimeoutId);\r\n              },1)\r\n          }).catch(e => loaderviweModel.comp.setTipContent(e || 'error'))\r\n        }\r\n      }).setProps({\r\n        // versionStr: `md5: ${subGameList.find(i => i.gameId === config.gameId).md5}`\r\n      })\r\n      loaderviweModel.comp.startLoad([bundle], [...thorFileMap])\r\n    })\r\n  })\r\n}\r\n"]}