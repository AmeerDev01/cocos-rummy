{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/components/Common_LoaderPanel.ts"],"names":["_decorator","Label","Node","ProgressBar","BaseComponent","SourceManage","global","GameConfig","ccclass","property","Common_LoaderPanel","constructor","events","onLoadDone","propertyNode","props_progressTip","props_progressBar","props_error_log","props_btn_return","props_version","sourceManageList","props","loadBarType","reverseProgress","versionStr","t","initState","total","progress","loadingObj","bindEvent","on","EventType","TOUCH_END","forEach","sm","stopPreLoad","closeSubGame","isPre","startLoad","bundleList","fileMap","totalCount","filter","i","isPreLoad","length","hasDoneCount","self","bundle","sourceManage","bundlePkgName","name","push","preLoadAllFiles1","doneCount","sourceFileloading","isValid","delayShowClose","setState","window","setTimeout","isClear","clearTimeout","node","active","bindUI","useState","state","string","toFixed","setTipContent","content","hideCloseBtn","destroyCallBack","useProps","key","value","isDev","cur","update","deltaTime"],"mappings":"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","sourcesContent":["import { _decorator, AssetManager, Label, Node, ProgressBar, tween, Vec3 } from 'cc';\r\nimport { BaseComponent } from '../../base/BaseComponent';\r\nimport SourceManage, { ISourceFile } from '../../base/SourceManage';\r\nimport { global } from '../../hall';\r\nimport { GameConfig } from '../../config/GameConfig';\r\nconst { ccclass, property } = _decorator;\r\n\r\ninterface IState {\r\n\t/**总数 */\r\n\ttotal: number\r\n\t/**当前已加载个数 */\r\n\tprogress: number\r\n\t/**正在加载的对象 */\r\n\tloadingObj: ISourceFile\r\n}\r\n\r\nexport interface IProps {\r\n\tloadBarType: number,\r\n\t/**进度是否是递减的数值 */\r\n\treverseProgress?: boolean,\r\n\tversionStr?: string\r\n}\r\n\r\nexport interface IEvent {\r\n\tonLoadDone: (sourceManageList: Array<SourceManage>) => void\r\n}\r\n\r\n@ccclass('Common_LoaderPanel')\r\nexport class Common_LoaderPanel extends BaseComponent<IState, IProps, IEvent> {\r\n\tconstructor() {\r\n\t\tsuper()\r\n\t}\r\n\r\n\tpublic events: IEvent = {\r\n\t\tonLoadDone: () => { }\r\n\t}\r\n\tprotected propertyNode = {\r\n\t\t/**进度条节点 */\r\n\t\tprops_progressTip: new Label(),\r\n\t\tprops_progressBar: new ProgressBar(),\r\n\t\tprops_error_log: new Label(),\r\n\t\tprops_btn_return: new Node(),\r\n\t\tprops_version: new Label()\r\n\t}\r\n\tprivate sourceManageList: SourceManage[] = []\r\n\tprotected initState(props: IProps): IState {\r\n\t\treturn {\r\n\t\t\ttotal: 0,\r\n\t\t\tprogress: 0,\r\n\t\t\tloadingObj: null\r\n\t\t}\r\n\t}\r\n\tpublic props: IProps = {\r\n\t\tloadBarType: 1,\r\n\t\treverseProgress: true,\r\n\t\tversionStr: '-'\r\n\t}\r\n\tprotected bindEvent(): void {\r\n\t\tthis.propertyNode.props_btn_return.on(Node.EventType.TOUCH_END, () => {\r\n\t\t\tthis.sourceManageList.forEach(sm => sm.stopPreLoad())\r\n\t\t\tglobal.closeSubGame({ isPre: true })\r\n\t\t})\r\n\t}\r\n\r\n\tpublic startLoad(bundleList: Array<AssetManager.Bundle>, fileMap: ISourceFile[]) {\r\n\t\tconst totalCount: number = fileMap.filter(i => i.isPreLoad).length\r\n\t\tlet hasDoneCount: number = 0\r\n\t\t// const sourceManageList: Array<SourceManage> = []\r\n\t\t// this.propertyNode.props_error_log.string = \"开始加载\"\r\n\t\tconst self = this\r\n\t\tbundleList.forEach(bundle => {\r\n\t\t\tconst sourceManage = new SourceManage(bundle, fileMap.filter(i => i.bundlePkgName === bundle.name && i.isPreLoad))\r\n\t\t\tthis.sourceManageList.push(sourceManage)\r\n\t\t\tsourceManage.preLoadAllFiles1((total: number, doneCount: number, sourceFileloading: ISourceFile) => {\r\n\t\t\t\tif (!this.isValid) return;\r\n\t\t\t\thasDoneCount++\r\n\t\t\t\tthis.delayShowClose();\r\n\t\t\t\tthis.setState({\r\n\t\t\t\t\t// loadingObj: sourceFileloading, total, progress: doneCount\r\n\t\t\t\t\tloadingObj: sourceFileloading, total: totalCount, progress: hasDoneCount\r\n\t\t\t\t})\r\n\t\t\t\t// if (total === doneCount) {\r\n\t\t\t\tif (totalCount === hasDoneCount) {\r\n\t\t\t\t\tthis.delayShowClose(true);\r\n\t\t\t\t\t// this.hideCloseBtn();\r\n\t\t\t\t\tthis.events && window.setTimeout(() => this.events && this.events.onLoadDone(this.sourceManageList), 1000)\r\n\t\t\t\t}\r\n\t\t\t}, () => { }, this.propertyNode.props_error_log)\r\n\t\t})\r\n\r\n\t\t// this.sourceManage = new SourceManage(bundle, fileMap)\r\n\t\t// this.sourceManage.preLoadAllFiles1((total: number, doneCount: number, sourceFileloading: ISourceFile) => {\r\n\t\t// \tthis.setState({\r\n\t\t// \t\tloadingObj: sourceFileloading, total, progress: total - doneCount\r\n\t\t// \t})\r\n\t\t// }, () => { this.events.onLoadDone(this.sourceManage) }, this.propertyNode.props_error_log)\r\n\r\n\t}\r\n\r\n\tprivate t = 0;\r\n\tprivate delayShowClose(isClear: boolean = false) {\r\n\t\tthis.t && window.clearTimeout(this.t);\r\n\t\t!isClear && (this.t = window.setTimeout(() => {\r\n\t\t\tthis.node.isValid && (this.propertyNode.props_btn_return.active = true)\r\n\t\t}, 50 * 1000));\r\n\t}\r\n\r\n\tprotected bindUI(): void {\r\n\t\tthis.propertyNode.props_btn_return.active = false;\r\n\t\tthis.useState(() => {\r\n\t\t\tif (!this.state.total) {\r\n\t\t\t\tthis.propertyNode.props_progressBar.progress = 1\r\n\t\t\t\tthis.propertyNode.props_progressTip.string = \"无可预加载的资源，任务已完成\"\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tthis.propertyNode.props_progressBar.progress = this.props.reverseProgress ? (1 - this.state.progress / this.state.total) : (this.state.progress / this.state.total)\r\n\t\t\t// this.propertyNode.props_progressTip.string = (this.state.progress === this.state.total\r\n\t\t\t// \t? \"已加载完成\" : `正在加载资源:${this.state.loadingObj.path}\r\n\t\t\t// \t(${(this.state.progress) + '/' + this.state.total})`)\r\n\r\n\t\t\tthis.propertyNode.props_progressTip.string = `${(this.state.progress * 100 / this.state.total).toFixed(0)}%`\r\n\t\t}, [], false)\r\n\t}\r\n\r\n\tpublic setTipContent(content: string) {\r\n\t\tthis.propertyNode.props_progressTip.string = content\r\n\t}\r\n\r\n\tpublic hideCloseBtn() {\r\n\t\tthis.propertyNode.props_btn_return.active = false;\r\n\t}\r\n\tprotected destroyCallBack(): void {\r\n\t\tthis.delayShowClose(true);\r\n\t}\r\n\tprotected useProps(key: string, value: { pre: any; cur: any; }): void {\r\n\t\t// console.log(key, \"change\", value.cur)\r\n\t\tif (key === \"versionStr\") {\r\n\t\t\tthis.propertyNode.props_version.string = `${GameConfig.isDev ? '内部版本-' : ''}${value.cur}`\r\n\t\t\tif (!GameConfig.isDev) {\r\n\t\t\t\tthis.propertyNode.props_version.node.active = false\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tupdate(deltaTime: number) {\r\n\r\n\t}\r\n}\r\n\r\n"]}