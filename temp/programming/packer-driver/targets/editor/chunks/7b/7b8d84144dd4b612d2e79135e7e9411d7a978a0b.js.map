{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/hall/viewModel/ActivityViewModel.ts"],"names":["ActivityViewModel","ViewModel","ActivityType","ApiUrl","fetcher","updateActivityStatus","SKT_MAG_TYPE","sktInstance","sktMsgListener","constructor","begin","send","ACTIVITY_LIST","then","rsp","setActivityItemId","setProps","activityList","catch","e","setEvent","setReadStatus","value","comp","props","getItemUnreadStatus","deleteReadStatus","initReadStatus","url","Date","parse","status","getUnreadStatus","dispatch","find","v","gameId","TURNPLATE","initTurntabledateStatus","forEach","id","name","actIds","undefined","getCacheActIds","length","i","element","actId","splice","localStorage","setItem","JSON","stringify","push","filter","turntableData","addOnce","TURNTABLEDATA","data","count","sendSktMessage","getItem","connect","inject","state"],"mappings":"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","sourcesContent":["import { Node } from \"cc\"\r\nimport ViewModel from \"../../base/ViewModel\"\r\nimport { Hall_ActivityPanel, IProps, IEvent, ActivityItem, ActivityType } from \"../components/Hall_ActivityPanel\"\r\nimport { StateType } from \"../store/reducer\"\r\nimport Fetcher from \"../../utils/Fetcher\"\r\nimport { ApiUrl } from \"../apiUrl\"\r\nimport { fetcher } from \"../index\"\r\nimport { updateActivityStatus } from \"../store/actions/memberInfo\"\r\nimport { SKT_MAG_TYPE, sktInstance, sktMsgListener } from \"../socketConnect\"\r\n\r\nclass ActivityViewModel extends ViewModel<Hall_ActivityPanel, IProps, IEvent> {\r\n  constructor() {\r\n    super(\"Hall_ActivityPanel\")\r\n  }\r\n\r\n  protected begin() {\r\n    fetcher.send(ApiUrl.ACTIVITY_LIST, {}, \"get\").then((rsp) => {\r\n      this.setActivityItemId(rsp)\r\n      this.setProps({\r\n        activityList: rsp\r\n      })\r\n    }).catch((e) => {\r\n      //this.dispatch(addToastAction({ content: e }))\r\n    })\r\n    this.setEvent({\r\n      setReadStatus: (value: string) => {\r\n        this.setReadStatus(this.comp.props.activityList, value);\r\n      },\r\n      getItemUnreadStatus: (value: string) => {\r\n        return this.getItemUnreadStatus(value);\r\n      },\r\n      deleteReadStatus: (value: string) => {\r\n        this.deleteReadStatus(value);\r\n      }\r\n    })\r\n  }\r\n\r\n  public initReadStatus() {\r\n    const url = `${ApiUrl.ACTIVITY_LIST}?t=${Date.parse(new Date() as any)}`\r\n    fetcher.send(url, {}, \"get\").then((rsp) => {\r\n      const activityList: ActivityItem[] = rsp;\r\n      this.setActivityItemId(activityList)\r\n\r\n      const status = this.getUnreadStatus(activityList)\r\n      this.dispatch(updateActivityStatus(status));\r\n\r\n      if (activityList && activityList.find(v => v.gameId === ActivityType.TURNPLATE)) {\r\n        this.initTurntabledateStatus(activityList);\r\n      }\r\n\r\n    }).catch((e) => {\r\n      //this.dispatch(addToastAction({ content: e }))\r\n    })\r\n  }\r\n\r\n  private setActivityItemId(activityList: ActivityItem[]) {\r\n    activityList && activityList.forEach(v => v.id = v.name)\r\n  }\r\n\r\n  /**\r\n   * 获得活动未读状态\r\n   * @param activityList \r\n   * @returns \r\n   */\r\n  private getUnreadStatus(activityList: ActivityItem[], actIds: string[] = undefined) {\r\n    if (!actIds) {\r\n      actIds = this.getCacheActIds();\r\n      if (actIds.length === 0) {\r\n        return true;\r\n      }\r\n    }\r\n    for (let i = 0; i < activityList.length; i++) {\r\n      const element = activityList[i];\r\n      if (!actIds.find(v => v === element.id)) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    // 把已经关闭的活动已读标识删掉\r\n    for (let i = 0; i < actIds.length; i++) {\r\n      const actId = actIds[i];\r\n      if (!activityList.find(v => v.id === actId)) {\r\n        actIds.splice(i, 1);\r\n        i--;\r\n      }\r\n    }\r\n    localStorage.setItem(\"actIds\", JSON.stringify(actIds));\r\n    return false;\r\n  }\r\n\r\n  private getItemUnreadStatus(value: string) {\r\n    return !this.getCacheActIds().find(v => v === value);\r\n  }\r\n\r\n  private setReadStatus(activityList: ActivityItem[], value: string) {\r\n    let actIds: string[] = this.getCacheActIds();\r\n    if (!actIds.find(v => v === value)) {\r\n      actIds.push(value);\r\n    }\r\n    localStorage.setItem(\"actIds\", JSON.stringify(actIds));\r\n\r\n    const status = this.getUnreadStatus(activityList, actIds);\r\n    this.dispatch(updateActivityStatus(status));\r\n  }\r\n\r\n  /**删除已读状态 */\r\n  private deleteReadStatus(value: string) {\r\n    let actIds: string[] = this.getCacheActIds();\r\n    if (actIds.length > 0) {\r\n      actIds = actIds.filter(v => v !== value)\r\n      localStorage.setItem(\"actIds\", JSON.stringify(actIds));\r\n    }\r\n  }\r\n\r\n  /**初始化转盘数据 */\r\n  private initTurntabledateStatus(activityList: ActivityItem[]) {\r\n    const turntableData = activityList.find(v => v.gameId === ActivityType.TURNPLATE)\r\n    sktMsgListener.addOnce(SKT_MAG_TYPE.TURNTABLEDATA, \"main\", (data) => {\r\n      if (data[0]) {\r\n        if (data[0].count > 0) {\r\n          this.deleteReadStatus(turntableData.id);\r\n        } else {\r\n          this.setReadStatus(activityList, turntableData.id);\r\n        }\r\n      } else {\r\n        this.setReadStatus(activityList, turntableData.id);\r\n      }\r\n    })\r\n    sktInstance.sendSktMessage(SKT_MAG_TYPE.TURNTABLEDATA)\r\n  }\r\n\r\n  private getCacheActIds() {\r\n    const value = localStorage.getItem(\"actIds\")\r\n    let actIds: string[] = [];\r\n    if (value) {\r\n      actIds = JSON.parse(value);\r\n    }\r\n    return actIds;\r\n  }\r\n  public connect() {\r\n    this.inject({}, (state: StateType) => {\r\n      return {\r\n      }\r\n    })\r\n    return this\r\n  }\r\n}\r\n\r\nexport default ActivityViewModel"]}