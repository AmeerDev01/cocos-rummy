{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/BackgroundScene.ts"],"names":["BackgroundScene","UITransform","Vec3","tween","createAnimationNode","createSpriteNode","getAnimation","getFileName","backgroundZOrder","constructor","sceneParent","sourceManage","sceneSize","scaleRatio","orgMusicID","uiRoot","convertToNodeSpaceAR","pos","getComponent","x","y","createView","view","parent","textureConfig","k","v","config","src_id","stype","spr","setWorldPosition","window","setTimeout","isValid","play","file","init","state","cutSeconds","scInfo","bgmConfig","musicEffectPlayer","bk_mus_id","musicSrc","playBgm","bkSrc","bk_pic_id","picSize","setAnchorPoint","width","multiplyScalar","view_inf","setScale","setSiblingIndex","children","length","to","worldPosition","start","getBkMusicId","destroy"],"mappings":"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","sourcesContent":["import { EventTouch, Node, Scene, Sprite, UITransform, Vec3, director, screen, tween, view } from \"cc\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport { createAnimationNode, createSpriteNode, getAnimation, getFileName, getSpriteAtlasBySpriteFrame, getSpriteFrame } from \"./FishTool\";\r\nimport { MusicEffectPlayer } from \"./MusicEffectPlayer\";\r\n\r\n/**\r\n  背景\r\n */\r\nconst backgroundZOrder = 0\r\n\r\nexport class BackgroundScene {\r\n  private sourceManage: SourceManage;\r\n  private orgMusicID: number;\r\n  public uiRoot: Node;\r\n  /**缩放比例 */\r\n  private scaleRatio = 1;\r\n  private sceneParent: Node;\r\n\r\n\r\n  constructor(sceneParent: Node, sourceManage: SourceManage, sceneSize, scaleRatio: number) {\r\n    this.sourceManage = sourceManage;\r\n    this.scaleRatio = scaleRatio;\r\n    this.sceneParent = sceneParent;\r\n  }\r\n\r\n  private convertToNodeSpaceAR(pos) {\r\n    return this.uiRoot.getComponent(UITransform).convertToNodeSpaceAR(new Vec3(pos.x, pos.y))\r\n  }\r\n\r\n  public createView(view, parent: Node, textureConfig) {\r\n    for (const k in view) {\r\n      const v = view[k];\r\n      let config = textureConfig[v.src_id]\r\n      if (config) {\r\n        if (config.stype === 1) { //animation\r\n          let spr = createAnimationNode(this.sourceManage, parent, config, true, true);\r\n          // spr.setPosition(this.convertToNodeSpaceAR(v.pos))\r\n          spr.setWorldPosition(new Vec3(v.pos.x, v.pos.y))\r\n          window.setTimeout(() => {\r\n            parent.isValid && getAnimation(spr).play();\r\n          }, 100)\r\n        } else if (config.stype === 2) { //pic\r\n          let spr = createSpriteNode(this.sourceManage, parent, config.file);\r\n          // spr.setPosition(this.convertToNodeSpaceAR(v.pos))\r\n          spr.setWorldPosition(new Vec3(v.pos.x, v.pos.y))\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public init(state, cutSeconds, scInfo, bgmConfig, textureConfig, sceneSize, musicEffectPlayer: MusicEffectPlayer) {\r\n    this.orgMusicID = scInfo.bk_mus_id\r\n\r\n    let musicSrc = bgmConfig[scInfo.bk_mus_id]\r\n    if (musicSrc) {\r\n      // AudioEngine.playMusic(musicSrc.file, true)\r\n      musicEffectPlayer.playBgm(musicSrc.file);\r\n    }\r\n\r\n    // console.log(view.getResolutionPolicy());\r\n    // console.log(view.getVisibleSize());\r\n    // console.log(view.getDesignResolutionSize());\r\n    // console.log(screen.windowSize);\r\n    // console.log(screen.resolution);\r\n    // console.log(screen.devicePixelRatio);\r\n\r\n    let bkSrc = textureConfig[scInfo.bk_pic_id].file\r\n    this.uiRoot = createSpriteNode(this.sourceManage, this.sceneParent, getFileName(bkSrc))\r\n    let picSize = this.uiRoot.getComponent(UITransform)\r\n    picSize.setAnchorPoint(0, 0)\r\n    // let pos = new Vec3(sceneSize.width + picSize.width / 2, sceneSize.height / 2)\r\n    let pos = new Vec3(sceneSize.width, 0)\r\n\r\n    if (state === 0) {\r\n      // pos.x = sceneSize.width / 2\r\n      // pos.y = sceneSize.height / 2\r\n      pos.x = 0;\r\n      pos.y = 0;\r\n      // this.uiRoot.setWorldPosition(pos)\r\n      // this.createView(scInfo.view_inf, this.uiRoot, textureConfig)\r\n    }\r\n    this.uiRoot.setWorldPosition(new Vec3(0, 0))\r\n    pos = pos.multiplyScalar(this.scaleRatio)\r\n    this.createView(scInfo.view_inf, this.uiRoot, textureConfig)\r\n\r\n    this.uiRoot.setScale(new Vec3(this.scaleRatio, this.scaleRatio))\r\n    this.uiRoot.setWorldPosition(pos)\r\n\r\n    this.uiRoot.setSiblingIndex(this.uiRoot.parent.children.length)\r\n\r\n    if (state === 1) {\r\n      // tween(this.uiRoot).to(cutSeconds, { worldPosition: new Vec3(sceneSize.width / 2, sceneSize.height / 2).multiplyScalar(this.scaleRatio) }).start();\r\n      tween(this.uiRoot).to(cutSeconds, { worldPosition: new Vec3(0, 0).multiplyScalar(this.scaleRatio) }).start();\r\n    }\r\n  }\r\n\r\n  public getBkMusicId() {\r\n    return this.orgMusicID\r\n  }\r\n\r\n  public destroy() {\r\n    this.uiRoot.destroy();\r\n    this.sourceManage = null;\r\n  }\r\n}"]}