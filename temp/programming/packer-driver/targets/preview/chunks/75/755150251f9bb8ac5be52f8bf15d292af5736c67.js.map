{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/LockFish.ts"],"names":["LockFish","Rect","UITransform","Vec2","Vec3","view","createSpriteAtlasNode","getSpriteAtlasBySpriteFrame","toNodeSpaceAR","sqrt","Math","sin","cos","atan","pow","abs","pi","PI","pia","constructor","info","commonConfig","sourceManage","fishManager","batteryManager","spos","spos1","parent","side","player_id","is_local","off_pos","lkey","spr_lock_line","block","is_lock_success","lock_fish_lst","cur_lock_index","cur_lock_obj_id","cur_lock_angle","remot_lock_angle","lock_call","is_lock_change","is_force_lock","front_force_lock_obj_id","lock_spr_dis","line_r","last_spr","last_spr_r","lockTexturesInfo","rect","getVisibleSize","width","height","init","frame_name","test_size","last_frame_name","active","setPosition","getRootNode","getComponent","lock","length","cur_fsh_obj","getObjectId","setLockFish","fsh_id","forceToLockFish","resetLockLst","lst","unlock","k","v","selectLockFish","fsh_obj","getFishObjById","isFishCanLock","console","log","new_index","fpos","getCurrentPos","battery_obj","getBatteryByPlayerId","bpos","getNoOffsetBulletPos","dis","x","y","contains","isPosValid","epos","angle","getRotationAngle","angle_valide","update","dt","clone","end_pos","resetLockLineByPos","pos1","pos2","setAngle","getSendBulletPos","distance","show_index","dist_add","lst_len","i","cal_dis","pos","getPosByDistanceAndAngle","obj","push","ranti","sx","sy","getLockState","getCurrentLockFishId","getCurrentLockAngle","setLockCall","call","isLockObjChange","destroy"],"mappings":"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","sourcesContent":["/**\r\n  锁定功能\r\n */\r\n\r\nimport { Node, Rect, UITransform, Vec2, Vec3, view } from \"cc\"\r\nimport SourceManage from \"../../base/SourceManage\"\r\nimport { createSpriteAtlasNode, createSpriteNode, getSpriteAtlasBySpriteFrame, toNodeSpaceAR } from \"./FishTool\"\r\nimport { FishManager } from \"./FishManager\"\r\nimport { BatteryManager } from \"./BatteryManager\"\r\nimport { Battery } from \"./Battery\"\r\nimport { Fish } from \"./Fish\"\r\nimport { ICreateObj } from \"./ObjectPool\"\r\n\r\nconst sqrt = Math.sqrt\r\nconst sin = Math.sin\r\nconst cos = Math.cos\r\nconst atan = Math.atan\r\nconst pow = Math.pow\r\nconst abs = Math.abs\r\nconst pi = Math.PI\r\nconst pia = 180;\r\n\r\n\r\n/**\r\ninfo = {\r\n  parent,\r\n  side,\r\n  is_local,\r\n  lkey,\r\n  offset_pos,\r\n  player_id,\r\n}\r\n */\r\n\r\nexport class LockFish {\r\n  private spos: Vec3;\r\n  private spos1: Vec3;\r\n  private parent: Node;\r\n  private side: number;\r\n  private player_id: number;\r\n  private is_local: boolean;\r\n  private off_pos: Vec3;\r\n  private lkey;\r\n  private spr_lock_line: Node[];\r\n  private block;\r\n  private is_lock_success: boolean;\r\n  private lock_fish_lst: Fish[];\r\n  private cur_lock_index: number;\r\n  private cur_lock_obj_id: number;\r\n  private cur_lock_angle: number;\r\n  private remot_lock_angle: number;\r\n  private lock_call;\r\n  private is_lock_change: boolean;\r\n  private is_force_lock: boolean;\r\n  private front_force_lock_obj_id: number;\r\n  // 调整锁定线的间距，设置这两个值\r\n  private lock_spr_dis: number;\r\n  private line_r: number;\r\n\r\n  private last_spr: Node;\r\n  private last_spr_r: number;\r\n\r\n  private sourceManage: SourceManage;\r\n  private fishManager: FishManager;\r\n  private batteryManager: BatteryManager;\r\n  private commonConfig;\r\n  private lockTexturesInfo;\r\n\r\n  private rect: Rect;\r\n\r\n  constructor(info, commonConfig, sourceManage: SourceManage, fishManager: FishManager, batteryManager: BatteryManager) {\r\n    this.commonConfig = commonConfig;\r\n    this.sourceManage = sourceManage;\r\n    this.fishManager = fishManager;\r\n    this.batteryManager = batteryManager;\r\n    this.rect = new Rect(0, 0, view.getVisibleSize().width, view.getVisibleSize().height)\r\n    this.init(info);\r\n  }\r\n\r\n  public init(info) {\r\n    this.spos = new Vec3()\r\n    this.spos1 = new Vec3()\r\n    this.parent = info.parent\r\n    this.side = info.side\r\n    this.player_id = info.player_id\r\n    this.is_local = info.is_local\r\n    // this.off_pos = info.offset_pos\r\n    this.off_pos = new Vec3(0, 0)\r\n    this.lkey = info.lkey\r\n\r\n\r\n    this.spr_lock_line = []\r\n    this.block = false\r\n    this.is_lock_success = false\r\n    this.lock_fish_lst = []\r\n    this.cur_lock_index = -1\r\n    this.cur_lock_obj_id = -1\r\n    this.lock_spr_dis = 30\r\n    this.cur_lock_angle = 0\r\n    this.remot_lock_angle = 0\r\n    this.lock_call = null\r\n    this.is_lock_change = false\r\n    this.is_force_lock = false\r\n    this.lockTexturesInfo = info.lockTexturesInfo\r\n\r\n    this.front_force_lock_obj_id = -1\r\n\r\n\r\n    let frame_name = info.lkey + '_1';\r\n    let test_size = getSpriteAtlasBySpriteFrame(this.sourceManage, this.lockTexturesInfo, frame_name);\r\n\r\n    this.line_r = 0\r\n    if (test_size.width <= test_size.height) {\r\n      this.line_r = test_size.width / 2\r\n    } else {\r\n      this.line_r = test_size.height / 2\r\n    }\r\n\r\n    let last_frame_name = info.lkey\r\n    this.last_spr = createSpriteAtlasNode(this.sourceManage, this.parent, this.lockTexturesInfo, last_frame_name);\r\n    this.last_spr.active = false\r\n    // this.last_spr.setWorldPosition(new Vec3(0, 0))\r\n    this.last_spr.setPosition(toNodeSpaceAR(this.batteryManager.getRootNode(), new Vec3(0, 0)))\r\n\r\n    let width = this.last_spr.getComponent(UITransform).width;\r\n    let height = this.last_spr.getComponent(UITransform).height;\r\n\r\n    this.last_spr_r = 0\r\n    if (width <= height) {\r\n      this.last_spr_r = width / 2\r\n    } else {\r\n      this.last_spr_r = height / 2\r\n    }\r\n  }\r\n\r\n  public lock() {\r\n    this.block = true\r\n    this.is_lock_change = false\r\n    this.is_force_lock = false\r\n    this.front_force_lock_obj_id = -1\r\n\r\n    if (this.lock_fish_lst.length > 0) {\r\n\r\n      this.cur_lock_index = this.cur_lock_index + 1\r\n\r\n      if (this.cur_lock_index > this.lock_fish_lst.length) { this.cur_lock_index = 0 }\r\n\r\n      //this.cur_lock_obj_id = -1\r\n\r\n      let cur_fsh_obj = this.lock_fish_lst[this.cur_lock_index]\r\n      if (cur_fsh_obj) {\r\n        this.cur_lock_obj_id = cur_fsh_obj.getObjectId()\r\n        //print(\"begin lock fish>>>>>>>>>>>>>>>>\")\r\n        this.is_lock_change = true\r\n        this.is_lock_success = true\r\n\r\n        if (this.lock_call) {\r\n          this.lock_call(this.cur_lock_obj_id)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public setLockFish(fsh_id) {\r\n    if (this.is_local === false) { this.block = true }\r\n\r\n    if (this.block && fsh_id !== -1) {\r\n      this.is_lock_success = true\r\n      this.cur_lock_obj_id = fsh_id\r\n    }\r\n  }\r\n\r\n  public forceToLockFish(fsh_id) {\r\n    if (this.is_local === true && (fsh_id !== -1)) {\r\n      this.block = true\r\n      this.is_force_lock = true\r\n      this.front_force_lock_obj_id = this.cur_lock_obj_id\r\n      this.cur_lock_obj_id = fsh_id\r\n      this.is_lock_success = true\r\n    }\r\n  }\r\n\r\n  public resetLockLst(lst) {\r\n    this.lock_fish_lst = lst\r\n  }\r\n\r\n  public unlock() {\r\n    this.cur_lock_index = -1\r\n    this.cur_lock_obj_id = -1\r\n    this.is_force_lock = false\r\n    this.front_force_lock_obj_id = -1\r\n    this.block = false\r\n    this.is_lock_success = false\r\n    this.cur_lock_angle = 0\r\n    this.remot_lock_angle = 0\r\n\r\n    this.last_spr.active = (false)\r\n    for (let k = 0; k < this.spr_lock_line.length; k++) {\r\n      const v = this.spr_lock_line[k];\r\n      if (!v) continue;\r\n      v.active = false\r\n    }\r\n  }\r\n\r\n\r\n  public selectLockFish(): Fish {\r\n    if (this.is_force_lock && this.is_local) {\r\n      let fsh_obj = this.fishManager.getFishObjById(this.cur_lock_obj_id) as Fish;\r\n      if (this.isFishCanLock(fsh_obj)) {\r\n        this.is_lock_success = true\r\n        if (this.lock_call) {\r\n          if (this.front_force_lock_obj_id !== this.cur_lock_obj_id && this.cur_lock_obj_id !== -1) {\r\n            this.front_force_lock_obj_id = this.cur_lock_obj_id\r\n            this.is_lock_change = true\r\n            console.log(\"force to lock fish >>>>>>>>>>>\")\r\n            this.lock_call(this.cur_lock_obj_id)\r\n          }\r\n        }\r\n        return fsh_obj\r\n      }\r\n\r\n      return null\r\n    }\r\n\r\n    if (this.is_local === false) {\r\n      let fsh_obj = this.fishManager.getFishObjById(this.cur_lock_obj_id)\r\n      if (this.isFishCanLock(fsh_obj)) {\r\n        this.is_lock_success = true\r\n        this.is_lock_change = true\r\n        return fsh_obj\r\n      }\r\n\r\n      return null\r\n    }\r\n\r\n    let new_index = -1\r\n    for (let k = 0; k < this.lock_fish_lst.length; k++) {\r\n      const v = this.lock_fish_lst[k];\r\n      if (!v) continue;\r\n      if (this.cur_lock_obj_id === v.getObjectId() && this.isFishCanLock(v) === true) {\r\n        this.is_lock_change = false\r\n        return v\r\n      }\r\n\r\n      if (this.isFishCanLock(v) === true && new_index === -1) {\r\n        new_index = k\r\n      }\r\n    }\r\n\r\n    if (new_index === -1) {\r\n      this.cur_lock_index = -1\r\n      this.cur_lock_obj_id = -1\r\n      this.is_lock_success = false\r\n      this.is_lock_change = true\r\n    } else {\r\n      this.cur_lock_index = new_index\r\n      this.cur_lock_obj_id = this.lock_fish_lst[this.cur_lock_index].getObjectId()\r\n      if (this.lock_call) {\r\n        this.lock_call(this.cur_lock_obj_id)\r\n      }\r\n\r\n      this.is_lock_success = true\r\n      this.is_lock_change = true\r\n    }\r\n\r\n    return this.lock_fish_lst[this.cur_lock_index]\r\n  }\r\n\r\n  public isFishCanLock(fsh_obj: Fish) {\r\n    if (fsh_obj) {\r\n      let fpos = fsh_obj.getCurrentPos()\r\n      let battery_obj = this.batteryManager.getBatteryByPlayerId(this.player_id)\r\n      let bpos = battery_obj.getNoOffsetBulletPos()\r\n      // let rect = new Rect(0, 0, this.commonConfig.bonding_size.width, this.commonConfig.bonding_size.height)\r\n      let dis = sqrt(pow(fpos.x - bpos.x, 2) + pow(fpos.y - bpos.y, 2))\r\n\r\n      if (this.rect.contains(new Vec2(fpos.x, fpos.y)) && this.isPosValid(this.side, bpos, fpos) && dis > 65) {\r\n        return true\r\n      }\r\n    }\r\n\r\n    return false\r\n  }\r\n\r\n  public isPosValid(side, spos, epos) {\r\n    let angle = this.getRotationAngle(spos, epos, side)\r\n\r\n    let angle_valide = false\r\n\r\n    if ((side === 1) && ((angle >= 0 && angle <= 90) || (angle >= 270 && angle <= 360)) && spos.x < epos.x) {\r\n      angle_valide = true\r\n    } else if ((side === 2) && (angle >= 90 && angle <= 270 && spos.x > epos.x)) {\r\n      angle_valide = true\r\n    } else if ((side === 3) && (angle >= 180 && angle <= 360 && epos.y < spos.y)) {\r\n      angle_valide = true\r\n    } else if ((side === 4) && (angle >= 0 && angle <= 180 && epos.y > spos.y)) {\r\n      angle_valide = true\r\n    }\r\n\r\n\r\n    return angle_valide\r\n  }\r\n\r\n  public update(dt) {\r\n    if (this.block === true) {\r\n      let fsh_obj = this.selectLockFish()\r\n\r\n      if (fsh_obj && this.is_lock_success === true) {\r\n        let battery_obj = this.batteryManager.getBatteryByPlayerId(this.player_id) as Battery\r\n        if (battery_obj) {\r\n          // 获得炮管位置\r\n          this.spos = battery_obj.getNoOffsetBulletPos().clone();\r\n        }\r\n        let end_pos = fsh_obj.getCurrentPos().clone();\r\n\r\n        this.spos.x = this.spos.x - this.off_pos.x\r\n        this.spos.y = this.spos.y - this.off_pos.y\r\n\r\n        // console.log('lockfish', end_pos.x, end_pos.y, 'off_pos', this.off_pos.x, this.off_pos.y);\r\n\r\n        end_pos.x = end_pos.x - this.off_pos.x\r\n        end_pos.y = end_pos.y - this.off_pos.y\r\n\r\n        this.resetLockLineByPos(this.spos, end_pos, battery_obj)\r\n      } else {\r\n        for (let k = 0; k < this.spr_lock_line.length; k++) {\r\n          const v = this.spr_lock_line[k];\r\n          if (!v) continue;\r\n          v.active = (false)\r\n        }\r\n        this.last_spr.active = false\r\n        if (this.is_force_lock || !this.is_local) {\r\n          this.is_force_lock = false\r\n          this.block = false\r\n          this.is_lock_success = false\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public resetLockLineByPos(pos1, pos2, battery_obj: Battery) {\r\n    let angle = this.getRotationAngle(pos1, pos2, this.side)\r\n\r\n    if (battery_obj) {\r\n      battery_obj.setAngle(angle)\r\n      this.spos1 = battery_obj.getSendBulletPos().clone();\r\n      this.spos1.x = this.spos1.x - this.off_pos.x\r\n      this.spos1.y = this.spos1.y - this.off_pos.y\r\n    }\r\n\r\n    let distance = sqrt(pow(this.spos1.x - pos2.x, 2) + pow(this.spos1.y - pos2.y, 2))\r\n\r\n    distance = distance - (this.line_r + this.last_spr_r)\r\n\r\n    let show_index = 0\r\n    let dist_add = 0\r\n\r\n    let lst_len = this.spr_lock_line.length\r\n\r\n    for (let i = 1; i <= lst_len; i++) {\r\n      dist_add = (i - 1) * (this.line_r * 2 + this.lock_spr_dis)\r\n      if (dist_add > distance) {\r\n        show_index = i - 1;\r\n        break\r\n      }\r\n\r\n      let cal_dis = (i - 1) * (this.line_r * 2 + this.lock_spr_dis)\r\n      let pos = this.getPosByDistanceAndAngle(cal_dis, angle)\r\n      // this.spr_lock_line[i - 1].setWorldPosition(pos)\r\n      this.spr_lock_line[i - 1].setPosition(toNodeSpaceAR(this.batteryManager.getRootNode(), pos))\r\n      this.spr_lock_line[i - 1].active = true\r\n      // this.spr_lock_line[i - 1].angle = 360 - angle;\r\n      this.spr_lock_line[i - 1].angle = angle;\r\n    }\r\n\r\n    let frame_name = this.lkey + `_1`\r\n\r\n    while (dist_add < distance) {\r\n      let obj = createSpriteAtlasNode(this.sourceManage, this.parent, this.lockTexturesInfo, frame_name);\r\n      this.spr_lock_line.push(obj)\r\n      let pos = this.getPosByDistanceAndAngle(dist_add, angle)\r\n      // obj.setWorldPosition(pos)\r\n      obj.setPosition(toNodeSpaceAR(this.batteryManager.getRootNode(), pos))\r\n      obj.active = true\r\n      // obj.angle = 360 - angle\r\n      obj.angle = angle\r\n\r\n      dist_add = dist_add + (this.line_r * 2 + this.lock_spr_dis)\r\n      show_index = show_index + 1\r\n    }\r\n\r\n    this.last_spr.active = (true)\r\n    // this.last_spr.setWorldPosition(new Vec3(pos2.x, pos2.y))\r\n    this.last_spr.setPosition(toNodeSpaceAR(this.batteryManager.getRootNode(), pos2))\r\n\r\n    // console.log(\"this.last_spr posotion \", this.last_spr.position.x, this.last_spr.position.y, this.last_spr.worldPosition.x, this.last_spr.worldPosition.y);\r\n\r\n    for (let i = show_index; i < this.spr_lock_line.length; i++) {\r\n      this.spr_lock_line[i].active = false\r\n    }\r\n\r\n    this.cur_lock_angle = angle\r\n  }\r\n\r\n  public getPosByDistanceAndAngle(dis, angle) {\r\n    let ranti = (angle / 180) * pi\r\n    let sx = dis * cos(ranti)\r\n    let sy = dis * sin(ranti)\r\n\r\n    return new Vec3(this.spos1.x + sx, this.spos1.y + sy)\r\n  }\r\n\r\n  public getRotationAngle(pos1, pos2, side) {\r\n    let angle = 0\r\n\r\n    if (abs(pos1.x - pos2.x) < 0.5) {\r\n      if (side === 1 && pos1.y >= pos2.y) {\r\n        angle = 90\r\n      } else if (side === 1 && pos1.y < pos2.y) {\r\n        angle = 270\r\n      } else if (side === 2 && pos1.y >= pos2.y) {\r\n        angle = 90\r\n      } else if (side === 2 && pos1.y < pos2.y) {\r\n        angle = 270\r\n      } else if (side === 3) {\r\n        angle = 270\r\n      } else if (side === 4) {\r\n        angle = 90\r\n      }\r\n    } else {\r\n      let k = (pos1.y - pos2.y) / (pos1.x - pos2.x)\r\n      angle = atan(k) * pia / pi\r\n\r\n      if (side === 1 && angle <= 0) {\r\n        angle = 2 * pia + angle\r\n      } else if (side === 2) {\r\n        angle = pia + angle\r\n      } else if (side === 3 && angle > 0) {\r\n        angle = pia + angle\r\n      } else if (side === 3 && angle <= 0) {\r\n        angle = 2 * pia + angle\r\n      } else if (side === 4 && angle <= 0) {\r\n        angle = pia + angle\r\n      }\r\n    }\r\n\r\n    return angle\r\n  }\r\n\r\n  public getLockState() {\r\n    if (this.block === true && this.is_lock_success === true) {\r\n      return true\r\n    }\r\n\r\n    return false\r\n  }\r\n\r\n  public getCurrentLockFishId() {\r\n    if (this.is_lock_success && this.block === true) {\r\n      return this.cur_lock_obj_id\r\n    }\r\n\r\n    return -1\r\n  }\r\n\r\n  public getCurrentLockAngle() {\r\n\r\n    return this.cur_lock_angle\r\n  }\r\n\r\n  public setLockCall(call) {\r\n    this.lock_call = call\r\n  }\r\n\r\n  public isLockObjChange() {\r\n    return this.is_lock_change\r\n  }\r\n\r\n  public destroy() {\r\n    for (let k = 0; k < this.spr_lock_line.length; k++) {\r\n      const v = this.spr_lock_line[k];\r\n      if (!v) continue;\r\n      v.destroy()\r\n    }\r\n    this.last_spr.destroy()\r\n  }\r\n}\r\n\r\n\r\n\r\n"]}