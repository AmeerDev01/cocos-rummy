{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/hall/components/SplitBundle.ts"],"names":["createBundle","id","data","options","onComplete","bundle","assetManager","bundles","get","name","AssetManager","BuiltinBundleName","RESOURCES","resources","Bundle","base","init","EDITOR","then","catch","_decorator","Component","instantiate","Label","Node","Prefab","ccclass","property","factory","register","SplitBundle","_bundle","start","button","node","getChildByName","buttonRun","getComponent","string","on","EventType","TOUCH_START","loadBundle","version","onFileProgress","n","t","console","log","err1","message","load","err2","asset","addChild","update","deltaTime"],"mappings":"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","sourcesContent":["import { _decorator, Asset, AssetManager, assetManager, Button, Component, director, instantiate, js, Label, Node, Prefab, resources, SceneAsset, Script, settings, System } from 'cc';\r\nimport { EDITOR } from 'cc/env';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nfunction createBundle (id: string, data: any, options: Record<string, any>, onComplete: ((err: Error | null, data?: AssetManager.Bundle | null) => void)) {\r\n    let bundle = assetManager.bundles.get(data.name);\r\n    if (!bundle) {\r\n        bundle = data.name === AssetManager.BuiltinBundleName.RESOURCES ? resources : new AssetManager.Bundle();\r\n        data.base = data.base || `${id}/`;\r\n        bundle.init(data);\r\n    }\r\n    //HACK: Can not import scripts in GameView due to the difference of Scripting System between the GameView and Preview\r\n    if (!EDITOR && bundle.name !== \"subGame\") {\r\n        import(`virtual:///prerequisite-imports/${bundle.name}`).then(() => {\r\n            onComplete(null, bundle);\r\n        }).catch(onComplete);\r\n    } else {\r\n        onComplete(null, bundle);\r\n    }\r\n}\r\n\r\nassetManager.factory.register(\"bundle\", createBundle)\r\n\r\n\r\n@ccclass('SplitBundle')\r\nexport class SplitBundle extends Component {\r\n    private _bundle: AssetManager.Bundle\r\n    start() {\r\n\r\n        // /** bundle 脚本表 */\r\n        // const bundle_script_tab: Record<string, any> = {};\r\n        // /** js 系统 */\r\n        // const system_js = self[\"System\"];\r\n        // /** 脚本缓存表 */\r\n        // const script_cache_tab: Record<string, any> = system_js[Reflect.ownKeys(system_js).find((v) => typeof v === \"symbol\")];\r\n        // // 初始化 bundle 脚本表\r\n        // Object.keys(script_cache_tab).forEach((v_s) => {\r\n        //     const current = script_cache_tab[v_s];\r\n        //     const parent = script_cache_tab[v_s].p;\r\n        //     const child = parent.d;\r\n        //     if (!parent || !child || current.id !== parent.id) {\r\n        //         return;\r\n        //     }\r\n        //     const name_s = parent.id.slice((parent.id as string).lastIndexOf(\"/\") + 1);\r\n        //     bundle_script_tab[name_s] = parent;\r\n        // });\r\n\r\n\r\n\r\n\r\n        const button = this.node.getChildByName(\"Button\")\r\n        const buttonRun = this.node.getChildByName(\"Button_run\")\r\n        this.node.getChildByName(\"Label\").getComponent(Label).string = \"ready\"\r\n        button.on(Node.EventType.TOUCH_START, () => {\r\n            // fetch(\"http://54.251.66.82:8008/subGame/config.90947.json\").then((response) => {\r\n            //     if (response.status === 200) {\r\n            //         response.json().then(({ data, status, message }) => {\r\n            //             if (status === \"SUCCESS\") {\r\n\r\n            //             } else {\r\n            //             }\r\n            //         })\r\n            //     } else {\r\n            //     }\r\n            // })\r\n            // settings.overrideSettings('scripting','scriptPackages',['../src/chunks/bundle.87e55.js'])\r\n\r\n            // 清理脚本缓存\r\n            // const bundle_s = \"subGame\"\r\n            // const bundle_root = bundle_script_tab[bundle_s];\r\n            // if (bundle_root) {\r\n            //     bundle_root.d.forEach((v: { id: string }) => {\r\n            //         delete script_cache_tab[v.id];\r\n            //         delete system_js[\"registerRegistry\"][v.id];\r\n            //     });\r\n            //     delete script_cache_tab[bundle_root.id];\r\n            //     delete system_js[\"registerRegistry\"][bundle_root.id];\r\n            // }\r\n\r\n            // // 清理 ccclass\r\n            // const reg = new RegExp(`${bundle_s}(_|/)`);\r\n            // Object.keys(js._nameToClass)\r\n            //     .filter((v_s) => v_s.match(reg) !== null)\r\n            //     .forEach((v_s) => {\r\n            //         js.unregisterClass(js.getClassByName(v_s));\r\n            //     });\r\n            // 清理 bundle 资源\r\n            // const bundle = assetManager.getBundle(bundle_s);\r\n            // if (bundle) {\r\n            //     bundle.releaseAll();\r\n            //     assetManager.removeBundle(bundle);\r\n            // }\r\n\r\n            this.node.getChildByName(\"Label\").getComponent(Label).string = \"go\"\r\n            assetManager.loadBundle(\"http://54.251.66.82:8008/subGame\",\r\n                {\r\n                    version: \"e8287\",\r\n                    onFileProgress: (n, t) => {\r\n                        console.log(`${n}&${t}`)\r\n                    }\r\n                }, (err1, _bundle) => {\r\n                    if (!err1) {\r\n                        this._bundle = _bundle\r\n                        this.node.getChildByName(\"Label\").getComponent(Label).string = \"done\"\r\n                    } else {\r\n                        this.node.getChildByName(\"Label\").getComponent(Label).string = err1.message\r\n                    }\r\n                })\r\n        })\r\n\r\n        buttonRun.on(Node.EventType.TOUCH_START, () => {\r\n            this._bundle.load(\"prefab/gameBg\", Prefab, (err2, asset: Prefab) => {\r\n                if (!err2) {\r\n                    const n = instantiate(asset)\r\n                    this.node.addChild(n);\r\n\r\n                } else {\r\n                    this.node.getChildByName(\"Label\").getComponent(Label).string = err2.message\r\n                }\r\n            })\r\n        })\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n\r\n    }\r\n}\r\n\r\n"]}