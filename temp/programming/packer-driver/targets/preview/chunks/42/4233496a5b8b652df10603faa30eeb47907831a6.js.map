{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/fish/FishManager.ts"],"names":["FishManager","UITransform","Vec3","Fish","sqrt","Math","pow","fishConfig","bondingBoxConfig","curveConfig","skillConfig","textureConfig","actionConfig","commonConfig","fishDataList","aliveFishList","Map","aliveFishBBList","fishParent","bUseSkew","sourceManage","batteryManager","fishGoldManager","fishLabelFntManager","skillPlayer","musicEffectPlayer","backgroundSceneManager","scaleRatio","rootNode","init","parent","fConfig","bbConfig","cveConfig","sklConfig","ttConfig","actConfig","comConfig","uninit","clear","getRootNode","getScaleRatio","freshFish","dt","i","length","v","run_t","fObj","object_id","fish_id","cve_id","spos","breserve","angle","user_info","getCurrentSceneId","set","getCurrentBBX","fishStart","splice","addFish","fish","push","addCacheDataTime","t","forEach","k","addAliveFishTime","addOtherTime","removeFish","objID","get","fishDead","delete","filter","update","isOutofTime","fishOut","convertToWorldSpaceAR","pos","getComponent","x","y","shotFish","bbx","entries","m","n","j","fishpos","getCurrentPos","dis","a","b","r","getAliveFishObjectLst","getFishObjById","clearAllFish","getFishSceneId","fishID","getObjectId","clearAllSceneAllFish","getParent","getFishIdByPoint","isPointInFish","setUseSkew","buse","clearFishCacheData"],"mappings":";;;wGAkDaA,W;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAlDEC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;;AAEnBC,MAAAA,I,iBAAAA,I;;;;;;;;;AA2BT;AACIC,MAAAA,I,GAAOC,IAAI,CAACD,I;AACZE,MAAAA,G,GAAMD,IAAI,CAACC,G,EAEf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;6BAEaN,W,GAAN,MAAMA,WAAN,CAAkB;AAAA;AAAA,eACfO,UADe,GACF,IADE;AAAA,eAEfC,gBAFe,GAEI,IAFJ;AAAA,eAGfC,WAHe,GAGD,IAHC;AAAA,eAIfC,WAJe,GAID,IAJC;AAAA,eAKfC,aALe,GAKC,IALD;AAAA,eAMfC,YANe,GAMA,IANA;AAAA,eAOfC,YAPe,GAOA,IAPA;AAAA,eASfC,YATe,GASA,EATA;AAWvB;AAXuB,eAYfC,aAZe,GAYC,IAAIC,GAAJ,EAZD;AAAA,eAafC,eAbe,GAaG,IAAID,GAAJ,EAbH;AAAA,eAcfE,UAde,GAcI,IAdJ;AAAA,eAefC,QAfe,GAeJ,KAfI;AAAA,eAgBfC,YAhBe;AAAA,eAiBfC,cAjBe;AAAA,eAkBfC,eAlBe;AAAA,eAmBfC,mBAnBe;AAAA,eAoBfC,WApBe;AAAA,eAqBfC,iBArBe;AAAA,eAsBfC,sBAtBe;;AAuBvB;AAvBuB,eAwBfC,UAxBe,GAwBM,CAxBN;AAAA,eAyBfC,QAzBe;AAAA;;AA2BhBC,QAAAA,IAAI,CAACC,MAAD,EAAeF,QAAf,EAA+BR,YAA/B,EAA2DW,OAA3D,EAAoEC,QAApE,EAA8EC,SAA9E,EAAyFC,SAAzF,EAAoGC,QAApG,EAA8GC,SAA9G,EAAyHC,SAAzH,EACThB,cADS,EACuBC,eADvB,EACyDC,mBADzD,EACmGC,WADnG,EAETC,iBAFS,EAE6BC,sBAF7B,EAE6EC,UAF7E,EAEiG;AAC1G,eAAKpB,UAAL,GAAkBwB,OAAlB;AACA,eAAKX,YAAL,GAAoBA,YAApB;AACA,eAAKZ,gBAAL,GAAwBwB,QAAxB;AACA,eAAKvB,WAAL,GAAmBwB,SAAnB;AACA,eAAKvB,WAAL,GAAmBwB,SAAnB;AACA,eAAKvB,aAAL,GAAqBwB,QAArB;AACA,eAAKvB,YAAL,GAAoBwB,SAApB;AACA,eAAKvB,YAAL,GAAoBwB,SAApB;AACA,eAAKhB,cAAL,GAAsBA,cAAtB;AACA,eAAKC,eAAL,GAAuBA,eAAvB;AACA,eAAKC,mBAAL,GAA2BA,mBAA3B;AACA,eAAKC,WAAL,GAAmBA,WAAnB;AACA,eAAKC,iBAAL,GAAyBA,iBAAzB;AACA,eAAKC,sBAAL,GAA8BA,sBAA9B;AACA,eAAKC,UAAL,GAAkBA,UAAlB;AAEA,eAAKZ,aAAL,GAAqB,IAAIC,GAAJ,EAArB;AACA,eAAKC,eAAL,GAAuB,IAAID,GAAJ,EAAvB;AACA,eAAKF,YAAL,GAAoB,EAApB;AACA,eAAKI,UAAL,GAAkBY,MAAlB;AACA,eAAKF,QAAL,GAAgBA,QAAhB;AACD;;AAEMU,QAAAA,MAAM,GAAG;AACd;AACA,eAAK/B,UAAL,GAAkB,IAAlB;AACA,eAAKC,gBAAL,GAAwB,IAAxB;AACA,eAAKC,WAAL,GAAmB,IAAnB;AACA,eAAKC,WAAL,GAAmB,IAAnB;AACA,eAAKC,aAAL,GAAqB,IAArB;AACA,eAAKC,YAAL,GAAoB,IAApB;AACA,eAAKC,YAAL,GAAoB,IAApB;AAEA,eAAKE,aAAL,IAAsB,KAAKA,aAAL,CAAmBwB,KAAnB,EAAtB;AACA,eAAKxB,aAAL,IAAsB,KAAKE,eAAL,CAAqBsB,KAArB,EAAtB;AACA,eAAKzB,YAAL,GAAoB,EAApB,CAZc,CAad;;AACA,eAAKC,aAAL,GAAqB,IAArB;AACA,eAAKE,eAAL,GAAuB,IAAvB;AACA,eAAKC,UAAL,GAAkB,IAAlB;AACA,eAAKJ,YAAL,GAAoB,IAApB;AACA,eAAKK,QAAL,GAAgB,KAAhB;AACA,eAAKC,YAAL,GAAoB,IAApB;AACA,eAAKC,cAAL,GAAsB,IAAtB;AACA,eAAKI,iBAAL,GAAyB,IAAzB;AACD;;AAEMe,QAAAA,WAAW,GAAG;AACnB,iBAAO,KAAKZ,QAAZ;AACD;;AAEMa,QAAAA,aAAa,GAAG;AACrB,iBAAO,KAAKd,UAAZ;AACD;;AAEMe,QAAAA,SAAS,CAACC,EAAD,EAAK;AACnB;AACA,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK9B,YAAL,CAAkB+B,MAAtC,EAA8CD,CAAC,EAA/C,EAAmD;AACjD,gBAAME,CAAC,GAAG,KAAKhC,YAAL,CAAkB8B,CAAlB,CAAV;;AACA,gBAAI,CAACE,CAAL,EAAQ;AACN;AACD;;AAED,gBAAIA,CAAC,CAACC,KAAF,IAAW,CAAf,EAAkB;AAChB,kBAAID,CAAC,CAACC,KAAF,GAAU,IAAd,EAAoB;AAClBD,gBAAAA,CAAC,CAACC,KAAF,GAAU,CAAV;AACD,eAHe,CAKhB;;;AACA,kBAAIC,IAAI,GAAG;AAAA;AAAA,gCACTF,CAAC,CAACG,SADO,EAETH,CAAC,CAACI,OAFO,EAGTJ,CAAC,CAACK,MAHO,EAIT,KAAKhC,QAJI,EAKT2B,CAAC,CAACC,KALO,EAMTD,CAAC,CAACM,IANO,EAOTN,CAAC,CAACO,QAPO,EAQTP,CAAC,CAACQ,KARO,EASTR,CAAC,CAACS,SATO,EAUT,KAAK7B,sBAAL,CAA4B8B,iBAA5B,EAVS,EAUwC,KAAK7C,aAV7C,EAU4D,KAAKJ,UAVjE,EAU6E,KAAKC,gBAVlF,EAWT,KAAKC,WAXI,EAWS,KAAKG,YAXd,EAW4B,KAAKC,YAXjC,EAW+C,KAAKO,YAXpD,EAWkE,KAAKF,UAXvE,EAYT,KAAKG,cAZI,EAYY,KAAKC,eAZjB,EAYkC,KAAKC,mBAZvC,EAY4D,KAAKC,WAZjE,EAY8E,KAAKC,iBAZnF,EAaT,KAAKE,UAbI,EAaQ,KAAKC,QAbb,CAAX,CANgB,CAqBhB;;AACA,mBAAKb,aAAL,CAAmB0C,GAAnB,CAAuBX,CAAC,CAACG,SAAzB,EAAoCD,IAApC;AACA,mBAAK/B,eAAL,CAAqBwC,GAArB,CAAyBX,CAAC,CAACG,SAA3B,EAAsCD,IAAI,CAACU,aAAL,EAAtC,EAvBgB,CAwBhB;AACA;;AAEAV,cAAAA,IAAI,CAACW,SAAL,GA3BgB,CA4BhB;;AACA,mBAAK7C,YAAL,CAAkB8C,MAAlB,CAAyBhB,CAAzB,EAA4B,CAA5B;AACAA,cAAAA,CAAC;AACF,aA/BD,MA+BO;AACLE,cAAAA,CAAC,CAACC,KAAF,GAAUD,CAAC,CAACC,KAAF,GAAUJ,EAApB;AACD;AACF;AACF,SAhIsB,CAkIvB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACOkB,QAAAA,OAAO,CAACC,IAAD,EAAgB;AAC5B;AACA,eAAKhD,YAAL,CAAkBiD,IAAlB,CAAuBD,IAAvB,EAF4B,CAG5B;AACD;;AACME,QAAAA,gBAAgB,CAACC,CAAD,EAAI;AACzB,eAAKnD,YAAL,CAAkBoD,OAAlB,CAA0B,CAACpB,CAAD,EAAIqB,CAAJ,KAAU;AAClCrB,YAAAA,CAAC,KAAKA,CAAC,CAACC,KAAF,GAAUD,CAAC,CAACC,KAAF,GAAUkB,CAAzB,CAAD;AACD,WAFD,EADyB,CAIzB;AACA;AACA;AACA;AACA;AACD;;AAEMG,QAAAA,gBAAgB,CAACH,CAAD,EAAI;AACzB,eAAKlD,aAAL,CAAmBmD,OAAnB,CAA2B,CAACpB,CAAD,EAAIqB,CAAJ,KAAU;AACnCrB,YAAAA,CAAC,IAAIA,CAAC,CAACuB,YAAF,CAAeJ,CAAf,CAAL;AACD,WAFD,EADyB,CAIzB;AACA;AACA;AACA;AACA;AACD;;AAEMK,QAAAA,UAAU,CAACC,KAAD,EAAQ;AACvB,cAAIvB,IAAI,GAAG,KAAKjC,aAAL,CAAmByD,GAAnB,CAAuBD,KAAvB,CAAX;;AACA,cAAIvB,IAAJ,EAAU;AACRA,YAAAA,IAAI,CAACyB,QAAL,GADQ,CAER;AACA;;AACA,iBAAK1D,aAAL,CAAmB2D,MAAnB,CAA0BH,KAA1B;AACA,iBAAKtD,eAAL,CAAqByD,MAArB,CAA4BH,KAA5B;AACD,WARsB,CASvB;;;AACA,eAAKzD,YAAL,GAAoB,KAAKA,YAAL,CAAkB6D,MAAlB,CAAyB7B,CAAC,IAAIA,CAAC,CAACG,SAAF,KAAgBsB,KAA9C,CAApB;AACD;;AAEMK,QAAAA,MAAM,CAACjC,EAAD,EAAK;AAChB,eAAKD,SAAL,CAAeC,EAAf;AACA,eAAK5B,aAAL,CAAmBmD,OAAnB,CAA2B,CAACpB,CAAD,EAAIqB,CAAJ,KAAU;AACnC,gBAAIrB,CAAJ,EAAO;AACLA,cAAAA,CAAC,CAAC8B,MAAF,CAASjC,EAAT;AACA,mBAAK1B,eAAL,CAAqBwC,GAArB,CAAyBU,CAAzB,EAA4BrB,CAAC,CAACY,aAAF,EAA5B,EAFK,CAGL;;AACA,kBAAIZ,CAAC,CAAC+B,WAAF,OAAoB,IAAxB,EAA8B;AAC5B/B,gBAAAA,CAAC,CAACgC,OAAF,GAD4B,CAE5B;AACA;;AACA,qBAAK/D,aAAL,CAAmB2D,MAAnB,CAA0BP,CAA1B;AACA,qBAAKlD,eAAL,CAAqByD,MAArB,CAA4BP,CAA5B;AACD;AACF;AACF,WAbD;AAcD;;AAEMY,QAAAA,qBAAqB,CAACC,GAAD,EAAM;AAChC,iBAAO,KAAK9D,UAAL,CAAgB+D,YAAhB,CAA6BhF,WAA7B,EAA0C8E,qBAA1C,CAAgE,IAAI7E,IAAJ,CAAS8E,GAAG,CAACE,CAAb,EAAgBF,GAAG,CAACG,CAApB,CAAhE,CAAP;AACD,SA5MsB,CA8MvB;AACA;AACA;AACA;AACA;;;AACOC,QAAAA,QAAQ,CAACC,GAAD,EAAM;AACnB,eAAK,IAAM,CAAClB,CAAD,EAAIrB,CAAJ,CAAX,IAAqB,KAAK7B,eAAL,CAAqBqE,OAArB,EAArB,EAAqD;AACnD,gBAAIxC,CAAJ,EAAO;AACL,mBAAK,IAAMyC,CAAX,IAAgBF,GAAhB,EAAqB;AACnB;AACA,oBAAMG,CAAC,GAAGH,GAAG,CAACE,CAAD,CAAb;AACA,oBAAI,CAACC,CAAL,EAAQ;;AACR,qBAAK,IAAM5C,CAAX,IAAgBE,CAAhB,EAAmB;AACjB;AACA,sBAAM2C,CAAC,GAAG3C,CAAC,CAACF,CAAD,CAAX;AACA,sBAAMkB,IAAI,GAAG,KAAK/C,aAAL,CAAmByD,GAAnB,CAAuBL,CAAvB,CAAb;AACA,sBAAMuB,OAAO,GAAG5B,IAAI,CAAC6B,aAAL,EAAhB,CAJiB,CAKjB;;AACA,sBAAIC,GAAG,GAAGxF,IAAI,CAACE,GAAG,CAACmF,CAAC,CAACI,CAAF,GAAML,CAAC,CAACK,CAAT,EAAY,CAAZ,CAAH,GAAoBvF,GAAG,CAACmF,CAAC,CAACK,CAAF,GAAMN,CAAC,CAACM,CAAT,EAAY,CAAZ,CAAxB,CAAd,CANiB,CAOjB;;AACA,sBAAIN,CAAC,CAACO,CAAF,GAAMN,CAAC,CAACM,CAAR,GAAYH,GAAhB,EAAqB;AACnB;AACA,2BAAO,KAAK7E,aAAL,CAAmByD,GAAnB,CAAuBL,CAAvB,CAAP;AACD;AACF;AACF;AACF;AACF;;AAED,iBAAO,IAAP;AACD;;AAEM6B,QAAAA,qBAAqB,GAAG;AAC7B,iBAAO,KAAKjF,aAAZ;AACD;;AAEMkF,QAAAA,cAAc,CAAC1B,KAAD,EAAQ;AAC3B,iBAAO,KAAKxD,aAAL,CAAmByD,GAAnB,CAAuBD,KAAvB,CAAP;AACD;AAED;AACF;AACA;;;AACS2B,QAAAA,YAAY,GAAG;AACpB,eAAKnF,aAAL,CAAmBmD,OAAnB,CAA2B,CAACpB,CAAD,EAAIqB,CAAJ,KAAU;AACnC,gBAAIrB,CAAC,IAAIA,CAAC,CAACqD,cAAF,OAAuB,KAAKzE,sBAAL,CAA4B8B,iBAA5B,EAA5B,IAA+EV,CAAC,CAACqD,cAAF,OAAuB,CAAC,CAA3G,EAA8G;AAC5G,kBAAIC,MAAM,GAAGtD,CAAC,CAACuD,WAAF,EAAb;AACAvD,cAAAA,CAAC,CAACgC,OAAF,GAF4G,CAG5G;AACA;;AACA,mBAAK/D,aAAL,CAAmB2D,MAAnB,CAA0B0B,MAA1B;AACA,mBAAKnF,eAAL,CAAqByD,MAArB,CAA4B0B,MAA5B;AACD;AACF,WATD;AAUD;AAED;AACF;AACA;;;AACSE,QAAAA,oBAAoB,GAAG;AAC5B,eAAKvF,aAAL,CAAmBwB,KAAnB;AACA,eAAKtB,eAAL,CAAqBsB,KAArB;AACA,eAAKzB,YAAL,GAAoB,EAApB;AACD;;AAEMyF,QAAAA,SAAS,GAAG;AACjB,iBAAO,KAAKrF,UAAZ;AACD;;AAEMsF,QAAAA,gBAAgB,CAACxB,GAAD,EAAM;AAC3B,cAAIoB,MAAM,GAAG,CAAC,CAAd;;AACA,eAAK,IAAM,CAACjC,CAAD,EAAIrB,CAAJ,CAAX,IAAqB,KAAK/B,aAAL,CAAmBuE,OAAnB,EAArB,EAAmD;AACjD,gBAAIxC,CAAC,IAAIA,CAAC,CAAC2D,aAAF,CAAgBzB,GAAhB,MAAyB,IAAlC,EAAwC;AACtCoB,cAAAA,MAAM,GAAGtD,CAAC,CAACuD,WAAF,EAAT;AACA;AACD;AACF,WAP0B,CAQ3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,iBAAOD,MAAP;AACD;;AAEMM,QAAAA,UAAU,CAACC,IAAD,EAAO;AACtB,eAAKxF,QAAL,GAAgBwF,IAAhB;AACD;;AAEMC,QAAAA,kBAAkB,GAAG;AAC1B,eAAK9F,YAAL,GAAoB,EAApB;AACD;;AA5SsB,O","sourcesContent":["import { Node, UITransform, Vec3 } from \"cc\"\r\nimport SourceManage from \"../../base/SourceManage\"\r\nimport { Fish } from \"./Fish\"\r\nimport { BatteryManager } from \"./BatteryManager\"\r\nimport { FishGoldManager } from \"./FishGoldManager\"\r\nimport { FishLabelFntManager } from \"./FishLabelFntManager\"\r\nimport { SkillPlayer } from \"./SkillPlayer\"\r\nimport { MusicEffectPlayer } from \"./MusicEffectPlayer\"\r\nimport { BackgroundSceneManager } from \"./BackgroundSceneManager\"\r\n\r\nexport type FishObj = {\r\n  /**对象id */\r\n  object_id: number\r\n  /**鱼配置id */\r\n  fish_id: number\r\n  /**曲线id */\r\n  cve_id: number\r\n  /**已经运动时间t */\r\n  run_t: number\r\n  /**起始坐标 */\r\n  spos: Vec3\r\n  /**路径是否反向 */\r\n  breserve: boolean\r\n  /**是否旋转 */\r\n  angle: number\r\n  /**用户数据 */\r\n  user_info: any,\r\n}\r\n\r\n// 鱼对象管理\r\nlet sqrt = Math.sqrt\r\nlet pow = Math.pow\r\n\r\n// 缓存服务端刷鱼数据\r\n// lst = {\r\n// \t[x] = {\r\n// \t\tobject_id :对象id\r\n// \t\tfish_id :鱼配置id\r\n// \t\tspos =[x,y] :起始坐标\r\n// \t\tbreserve,路径是否反向\r\n// \t\tangle :是否旋转\r\n// \t\tcve_id :曲线id\r\n// \t\trun_t :已经运动时间t\r\n// \t\tuser_info = {\r\n// \t\t\t用户数据\r\n// \t\t},\r\n// \t}\r\n// }\r\n////////////////////////////////////\r\n\r\nexport class FishManager {\r\n  private fishConfig = null\r\n  private bondingBoxConfig = null\r\n  private curveConfig = null\r\n  private skillConfig = null\r\n  private textureConfig = null\r\n  private actionConfig = null\r\n  private commonConfig = null\r\n\r\n  private fishDataList = []\r\n\r\n  // member\r\n  private aliveFishList = new Map<Number, Fish>()\r\n  private aliveFishBBList = new Map<Number, Fish>()\r\n  private fishParent: Node = null\r\n  private bUseSkew = false\r\n  private sourceManage: SourceManage;\r\n  private batteryManager: BatteryManager;\r\n  private fishGoldManager: FishGoldManager;\r\n  private fishLabelFntManager: FishLabelFntManager;\r\n  private skillPlayer: SkillPlayer;\r\n  private musicEffectPlayer: MusicEffectPlayer;\r\n  private backgroundSceneManager: BackgroundSceneManager\r\n  /**缩放比例 */\r\n  private scaleRatio: number = 1;\r\n  private rootNode: Node;\r\n\r\n  public init(parent: Node, rootNode: Node, sourceManage: SourceManage, fConfig, bbConfig, cveConfig, sklConfig, ttConfig, actConfig, comConfig,\r\n    batteryManager: BatteryManager, fishGoldManager: FishGoldManager, fishLabelFntManager: FishLabelFntManager, skillPlayer: SkillPlayer,\r\n    musicEffectPlayer: MusicEffectPlayer, backgroundSceneManager: BackgroundSceneManager, scaleRatio: number) {\r\n    this.fishConfig = fConfig\r\n    this.sourceManage = sourceManage\r\n    this.bondingBoxConfig = bbConfig\r\n    this.curveConfig = cveConfig\r\n    this.skillConfig = sklConfig\r\n    this.textureConfig = ttConfig\r\n    this.actionConfig = actConfig\r\n    this.commonConfig = comConfig\r\n    this.batteryManager = batteryManager\r\n    this.fishGoldManager = fishGoldManager\r\n    this.fishLabelFntManager = fishLabelFntManager\r\n    this.skillPlayer = skillPlayer\r\n    this.musicEffectPlayer = musicEffectPlayer\r\n    this.backgroundSceneManager = backgroundSceneManager\r\n    this.scaleRatio = scaleRatio\r\n\r\n    this.aliveFishList = new Map();\r\n    this.aliveFishBBList = new Map()\r\n    this.fishDataList = []\r\n    this.fishParent = parent\r\n    this.rootNode = rootNode\r\n  }\r\n\r\n  public uninit() {\r\n    // config\r\n    this.fishConfig = null\r\n    this.bondingBoxConfig = null\r\n    this.curveConfig = null\r\n    this.skillConfig = null\r\n    this.textureConfig = null\r\n    this.actionConfig = null\r\n    this.commonConfig = null\r\n\r\n    this.aliveFishList && this.aliveFishList.clear();\r\n    this.aliveFishList && this.aliveFishBBList.clear();\r\n    this.fishDataList = [];\r\n    // member\r\n    this.aliveFishList = null\r\n    this.aliveFishBBList = null\r\n    this.fishParent = null\r\n    this.fishDataList = null\r\n    this.bUseSkew = false\r\n    this.sourceManage = null;\r\n    this.batteryManager = null;\r\n    this.musicEffectPlayer = null;\r\n  }\r\n\r\n  public getRootNode() {\r\n    return this.rootNode\r\n  }\r\n\r\n  public getScaleRatio() {\r\n    return this.scaleRatio\r\n  }\r\n\r\n  public freshFish(dt) {\r\n    // console.log(this.uuid + \" 等待刷鱼数量 -------- \", fishDatas.length);\r\n    for (let i = 0; i < this.fishDataList.length; i++) {\r\n      const v = this.fishDataList[i];\r\n      if (!v) {\r\n        continue;\r\n      }\r\n\r\n      if (v.run_t >= 0) {\r\n        if (v.run_t < 0.02) {\r\n          v.run_t = 0\r\n        }\r\n\r\n        // create fish\r\n        let fObj = new Fish(\r\n          v.object_id,\r\n          v.fish_id,\r\n          v.cve_id,\r\n          this.bUseSkew,\r\n          v.run_t,\r\n          v.spos,\r\n          v.breserve,\r\n          v.angle,\r\n          v.user_info,\r\n          this.backgroundSceneManager.getCurrentSceneId(), this.textureConfig, this.fishConfig, this.bondingBoxConfig,\r\n          this.curveConfig, this.actionConfig, this.commonConfig, this.sourceManage, this.fishParent,\r\n          this.batteryManager, this.fishGoldManager, this.fishLabelFntManager, this.skillPlayer, this.musicEffectPlayer,\r\n          this.scaleRatio, this.rootNode\r\n        )\r\n        // this.fishParent.addChild(fObj.uiRoot)\r\n        this.aliveFishList.set(v.object_id, fObj);\r\n        this.aliveFishBBList.set(v.object_id, fObj.getCurrentBBX());\r\n        // this.aliveFishList[v.object_id] = fObj\r\n        // this.aliveFishBBList[v.object_id] = fObj.getCurrentBBX()\r\n\r\n        fObj.fishStart()\r\n        // this.fishDataList[k] = null\r\n        this.fishDataList.splice(i, 1);\r\n        i--;\r\n      } else {\r\n        v.run_t = v.run_t + dt\r\n      }\r\n    }\r\n  }\r\n\r\n  // //[[\r\n  // fish = {\r\n  //   object_id,//对象id\r\n  //   fish_id,//鱼配置id\r\n  //   spos =[x, y,],//起始坐标\r\n  //   breserve, 路径是否反向\r\n  // \t\tangle,//是否旋转\r\n  //   cve_id,//曲线id\r\n  //   run_t,//已经运动时间t\r\n  //   user_info = {\r\n  //     //用户数据\r\n  //   },\r\n  // }\r\n  // ]]\r\n  public addFish(fish: FishObj) {\r\n    // this.fishDataList[fish.object_id] = fish\r\n    this.fishDataList.push(fish)\r\n    // console.log(this.uuid + \" 等待刷鱼数量\", this.fishDataList.length);\r\n  }\r\n  public addCacheDataTime(t) {\r\n    this.fishDataList.forEach((v, k) => {\r\n      v && (v.run_t = v.run_t + t)\r\n    })\r\n    // for (const k in this.fishDataList) {\r\n    //   const v = this.fishDataList[k];\r\n    //   if (!v) continue;\r\n    //   v.run_t = v.run_t + t\r\n    // }\r\n  }\r\n\r\n  public addAliveFishTime(t) {\r\n    this.aliveFishList.forEach((v, k) => {\r\n      v && v.addOtherTime(t)\r\n    })\r\n    // for (const k in this.aliveFishList) {\r\n    //   const v = this.aliveFishList[k];\r\n    //   if (!v) continue;\r\n    //   v.addOtherTime(t)\r\n    // }\r\n  }\r\n\r\n  public removeFish(objID) {\r\n    let fObj = this.aliveFishList.get(objID) as Fish\r\n    if (fObj) {\r\n      fObj.fishDead()\r\n      // this.aliveFishList[objID] = null\r\n      // this.aliveFishBBList[objID] = null\r\n      this.aliveFishList.delete(objID);\r\n      this.aliveFishBBList.delete(objID);\r\n    }\r\n    // this.fishDataList[objID] = null\r\n    this.fishDataList = this.fishDataList.filter(v => v.object_id !== objID);\r\n  }\r\n\r\n  public update(dt) {\r\n    this.freshFish(dt)\r\n    this.aliveFishList.forEach((v, k) => {\r\n      if (v) {\r\n        v.update(dt)\r\n        this.aliveFishBBList.set(k, v.getCurrentBBX())\r\n        // this.aliveFishBBList[k] = v.getCurrentBBX()\r\n        if (v.isOutofTime() === true) {\r\n          v.fishOut()\r\n          // this.aliveFishList[k] = null\r\n          // this.aliveFishBBList[k] = null\r\n          this.aliveFishList.delete(k)\r\n          this.aliveFishBBList.delete(k)\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  public convertToWorldSpaceAR(pos) {\r\n    return this.fishParent.getComponent(UITransform).convertToWorldSpaceAR(new Vec3(pos.x, pos.y));\r\n  }\r\n\r\n  // //[[\r\n  // bonding_box = {\r\n  //   [1] = { a = 0, b = 0, r = 10, },\r\n  // }\r\n  // ]]\r\n  public shotFish(bbx) {\r\n    for (const [k, v] of this.aliveFishBBList.entries()) {\r\n      if (v) {\r\n        for (const m in bbx) {\r\n          // 子弹的包围盒坐标\r\n          const n = bbx[m];\r\n          if (!n) continue;\r\n          for (const i in v) {\r\n            // 鱼的包围盒坐标\r\n            const j = v[i];\r\n            const fish = this.aliveFishList.get(k);\r\n            const fishpos = fish.getCurrentPos()\r\n            // 计算两点间的距离\r\n            let dis = sqrt(pow(j.a - n.a, 2) + pow(j.b - n.b, 2))\r\n            // console.log(`bullet box ${n.a}, ${n.b}, ${n.r}, fish box ${j.a}, ${j.b}, ${j.r}, fish pos ${fishpos.x}, ${fishpos.y}, angle ${fish.getCurrentAngle()}, dis ${dis}`);\r\n            if (n.r + j.r > dis) {\r\n              // console.log('打中鱼了');\r\n              return this.aliveFishList.get(k)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  public getAliveFishObjectLst() {\r\n    return this.aliveFishList\r\n  }\r\n\r\n  public getFishObjById(objID) {\r\n    return this.aliveFishList.get(objID)\r\n  }\r\n\r\n  /**\r\n   * 清理非当前场景的鱼\r\n   */\r\n  public clearAllFish() {\r\n    this.aliveFishList.forEach((v, k) => {\r\n      if (v && v.getFishSceneId() !== this.backgroundSceneManager.getCurrentSceneId() && v.getFishSceneId() !== -1) {\r\n        let fishID = v.getObjectId()\r\n        v.fishOut()\r\n        // this.aliveFishList[fishID] = null\r\n        // this.aliveFishBBList[fishID] = null\r\n        this.aliveFishList.delete(fishID)\r\n        this.aliveFishBBList.delete(fishID)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 清理所有场景的所有鱼\r\n   */\r\n  public clearAllSceneAllFish() {\r\n    this.aliveFishList.clear();\r\n    this.aliveFishBBList.clear();\r\n    this.fishDataList = [];\r\n  }\r\n\r\n  public getParent() {\r\n    return this.fishParent\r\n  }\r\n\r\n  public getFishIdByPoint(pos) {\r\n    let fishID = -1\r\n    for (const [k, v] of this.aliveFishList.entries()) {\r\n      if (v && v.isPointInFish(pos) === true) {\r\n        fishID = v.getObjectId()\r\n        break\r\n      }\r\n    }\r\n    // for (const k in this.aliveFishList) {\r\n    //   const v = this.aliveFishList[k];\r\n    //   if (!v) continue;\r\n    //   if (v.isPointInFish(pos) === true) {\r\n    //     fishID = v.getObjectId()\r\n    //     break\r\n    //   }\r\n    // }\r\n    return fishID\r\n  }\r\n\r\n  public setUseSkew(buse) {\r\n    this.bUseSkew = buse\r\n  }\r\n\r\n  public clearFishCacheData() {\r\n    this.fishDataList = []\r\n  }\r\n}"]}