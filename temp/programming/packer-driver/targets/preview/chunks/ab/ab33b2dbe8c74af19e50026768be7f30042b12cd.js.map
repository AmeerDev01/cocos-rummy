{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/fish/viewModel/RoomViewModel.ts"],"names":["Vec3","ViewModel","StoreInject","config","SKT_MAG_TYPE","sktInstance","sktMsgListener","getStore","isSelf","GetnewwwepViewModel","sourceManageSelector","PrefabPathDefine","EffectType","RoomViewModel","constructor","fishManager","bulletManager","batteryManager","backgroundSceneManager","skillPlayer","fishLabelFntManager","roomId","userInfos","isListenerWs","stage","is_use_rotation","selfUserInfo","begin","initUI","listenerSocket","setEvent","setLockFisState","isChecked","getMyselfBatteryObj","setAutoFire","setFireState","exitRoom","onExitRoom","unListenerSocket","remove","GENERATE_FISH","name","SEND_BULLET","HIT_FISH","LOCK","CANCEL_LOCK","CHANGE_BATTERY","CHIPS_CHANGE","CHANGE_SCENCE","CHANGE_BATTERY_SKIN","REQ_SCENCE","OTHER_JOIN_ROOM","LEAVE_ROOM","EXIT_TABLE","add","data","addFish","fishs","runSendBullet","playerId","angle","bulletId","fishLstDeath","dies","lockFish","fishId","unLockFish","setBatteryBeishu","battery","score","power","updateScore","chips","cutBackgroundScene","scene","cutBattery","skin","enterScene","otherJoinRoom","levelRoom","batterys","forEach","v","setBatteryInfo","scenceId","comp","scheduleOnce","seteAllUserUIHidden","find","player_id","seats","userInfo","server_id","set_id","order","is_local","gold","cedit","head_id","parseInt","icon","level","vip_level","vip","nick_name","nickName","battery_id","battery_score","isPowerBattery","room_id","ready","offline","bullet","push","removeBatteryByPlayerId","removeBulletObjectByPlayerId","filter","getBatteryByPlayerId","setScoreVal","obj","object_id","id","fish_id","type","cve_id","road","run_t","t","spos","x","y","breserve","user_info","fishDeath","fshid","bat_obj","fsh_obj","getFishObjById","setGoldMoveEndPos","getBatteryPos","setUserInfo","getUserInfo","removeFish","lst","length","fsh_id","i","first_obj","addLineRelObj","setHitScore","enterRoom","viewNode","active","initSideBoard","getBatteryNode","getFishPondNode","createAllBatteryByPosition","map","undefined","setUseSkew","rotationOtherUserInfo","isTest","sendSktMessage","isEff","isPower","setPos","res","setBtnLocaltion","getScaleRatio","setPowerBattery","setLockFish","setUnlockFish","unMountCallBack","clearAllFish","clearAllSceneAllFish","clearFishCacheData","removeAllChildren","hideSideBoard","quitRoom","removeAllBattery","lock","send_yrby_ReqLock","bind","fire","send_yrby_ReqFire","cancelLock","send_yrby_ReqCancelLock","switchBattery","send_yrby_ReqSwitchBattery","wepShow","show","textureConfig","batterySkinConfig","showChangeBatteryUI","dataManager","getRoomType","getRoomInfo","param","lower","noMoney","changeScence","msg","getnewwwepViewModel","mountView","getFile","GET_NEWWAP","source","appendTo","parent","effectType","EFFECT2","connect","setProps","vipLevel","myBatteryId","changeBattery","batteryId","inject","state"],"mappings":"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","sourcesContent":["import { Vec3, view } from \"cc\";\r\nimport ViewModel, { StoreInject } from \"../../../base/ViewModel\"\r\nimport { BatteryManager } from \"../../../common/fish/BatteryManager\";\r\nimport { BulletManager } from \"../../../common/fish/BulletManager\";\r\nimport { FishManager } from \"../../../common/fish/FishManager\";\r\nimport { Fish_Room, IEvent, IProps } from \"../components/Fish_Room\"\r\nimport config from \"../config\";\r\nimport { SKT_MAG_TYPE, sktInstance, sktMsgListener } from \"../socketConnect\";\r\nimport { getStore } from \"../store\"\r\nimport { StateType } from \"../store/reducer\"\r\nimport { BatteryChangeVo, ChangeBatterySkinVo, ChipsChangeVo, EnterRoomVo, FireVo, FishDieInfo, FishInfo, HitFishVo, LockVo, MemInfo, OtherJoinRoomVo, Player, ProduceFishVo, ReadyVo, ResScenceVo, SeatInfo } from \"../type\";\r\nimport { BackgroundSceneManager } from \"../../../common/fish/BackgroundSceneManager\";\r\nimport { Battery, UserInfo } from \"../../../common/fish/Battery\";\r\nimport { Fish } from \"../../../common/fish/Fish\";\r\nimport { isSelf } from \"../fishTool\";\r\nimport { SkillPlayer } from \"../../../common/fish/SkillPlayer\";\r\nimport { FishLabelFntManager } from \"../../../common/fish/FishLabelFntManager\";\r\nimport GetnewwwepViewModel from \"./GetnewwwepViewModel\";\r\nimport { sourceManageSelector } from \"../index\";\r\nimport { PrefabPathDefine } from \"../sourceDefine/prefabDefine\";\r\nimport { EffectType } from \"../../../utils/NodeIOEffect\";\r\n\r\n@StoreInject(getStore())\r\nclass RoomViewModel extends ViewModel<Fish_Room, IProps, IEvent> {\r\n\r\n  private fishManager: FishManager;\r\n  private bulletManager: BulletManager;\r\n  private batteryManager: BatteryManager;\r\n  private backgroundSceneManager: BackgroundSceneManager;\r\n  private skillPlayer: SkillPlayer;\r\n  private fishLabelFntManager: FishLabelFntManager;\r\n  private roomId: string;\r\n  private userInfos: UserInfo[];\r\n  private isListenerWs = false;\r\n  /**当前阶段 */\r\n  private stage: number = 0;\r\n\r\n  private is_use_rotation = false;\r\n\r\n  /**自己的信息 */\r\n  private selfUserInfo: UserInfo;\r\n\r\n  constructor(fishManager: FishManager, bulletManager: BulletManager, batteryManager: BatteryManager, backgroundSceneManager: BackgroundSceneManager,\r\n    skillPlayer: SkillPlayer, fishLabelFntManager: FishLabelFntManager) {\r\n    super('Fish_Room')\r\n    this.fishManager = fishManager\r\n    this.bulletManager = bulletManager\r\n    this.batteryManager = batteryManager\r\n    this.backgroundSceneManager = backgroundSceneManager\r\n    this.skillPlayer = skillPlayer\r\n    this.fishLabelFntManager = fishLabelFntManager\r\n  }\r\n  protected begin() {\r\n    this.initUI();\r\n    this.listenerSocket();\r\n    this.setEvent({\r\n      setLockFisState: (isChecked: boolean) => {\r\n        this.batteryManager.getMyselfBatteryObj().setLockFisState(isChecked)\r\n      },\r\n      setAutoFire: (isChecked) => {\r\n        this.batteryManager.getMyselfBatteryObj().setFireState(isChecked)\r\n      },\r\n      exitRoom: () => {\r\n        this.onExitRoom();\r\n      },\r\n    })\r\n  }\r\n\r\n  private unListenerSocket() {\r\n    if (!this.isListenerWs) return;\r\n    sktMsgListener.remove(SKT_MAG_TYPE.GENERATE_FISH, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.SEND_BULLET, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.HIT_FISH, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.LOCK, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.CANCEL_LOCK, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.CHANGE_BATTERY, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.CHIPS_CHANGE, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.CHANGE_SCENCE, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.CHANGE_BATTERY_SKIN, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.REQ_SCENCE, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.OTHER_JOIN_ROOM, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.LEAVE_ROOM, config.name)\r\n    sktMsgListener.remove(SKT_MAG_TYPE.EXIT_TABLE, config.name)\r\n  }\r\n\r\n  private listenerSocket() {\r\n    sktMsgListener.add(SKT_MAG_TYPE.GENERATE_FISH, config.name, (data: ProduceFishVo) => {\r\n      this.addFish(data.fishs)\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.SEND_BULLET, config.name, (data: FireVo) => {\r\n      this.runSendBullet(data.playerId, data.angle, data.bulletId);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.HIT_FISH, config.name, (data: HitFishVo) => {\r\n      this.fishLstDeath(data.playerId, data.dies)\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.LOCK, config.name, (data: LockVo) => {\r\n      this.lockFish(data.playerId, data.fishId);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.CANCEL_LOCK, config.name, (data: LockVo) => {\r\n      this.unLockFish(data.playerId);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.CHANGE_BATTERY, config.name, (data: BatteryChangeVo) => {\r\n      this.setBatteryBeishu(data.battery.playerId, data.battery.score, true, data.battery.power > 0)\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.CHIPS_CHANGE, config.name, (data: ChipsChangeVo) => {\r\n      this.updateScore(data.playerId, data.chips);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.CHANGE_SCENCE, config.name, (data) => {\r\n      this.backgroundSceneManager.cutBackgroundScene(data.scene);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.CHANGE_BATTERY_SKIN, config.name, (data: ChangeBatterySkinVo) => {\r\n      this.cutBattery(data.playerId, data.skin);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.REQ_SCENCE, config.name, (data: ResScenceVo) => {\r\n      this.enterScene(data)\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.OTHER_JOIN_ROOM, config.name, (data: OtherJoinRoomVo) => {\r\n      this.otherJoinRoom(data);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.LEAVE_ROOM, config.name, (data) => {\r\n      this.levelRoom(data.playerId);\r\n    })\r\n    sktMsgListener.add(SKT_MAG_TYPE.EXIT_TABLE, config.name, (data) => {\r\n      this.levelRoom(data.playerId);\r\n    })\r\n    this.isListenerWs = true;\r\n  }\r\n\r\n  private enterScene(data: ResScenceVo) {\r\n    data.batterys.forEach(v => {\r\n      this.setBatteryInfo(v.playerId, v.score, v.skin, false, v.power > 0)\r\n    })\r\n    this.backgroundSceneManager.cutBackgroundScene(data.scenceId);\r\n    this.addFish(data.fishs)\r\n\r\n    this.comp.scheduleOnce(() => {\r\n      this.batteryManager.seteAllUserUIHidden();\r\n    }, 2);\r\n  }\r\n\r\n  private otherJoinRoom(data: OtherJoinRoomVo) {\r\n    if (this.userInfos.find(v => v.player_id === data.seats.playerId)) {\r\n      return;\r\n    }\r\n    const userInfo: UserInfo = {\r\n      player_id: data.seats.playerId,\r\n      server_id: 1,\r\n      set_id: data.seats.order + 1,\r\n      is_local: isSelf(data.seats.playerId),//是否为本地，区别自己与别人的炮台\r\n      gold: data.seats.cedit,//金币\r\n      head_id: parseInt(data.seats.icon),//头像\r\n      level: data.seats.level || 100,//等级\r\n      vip_level: data.seats.vip || 0,//vip等级\r\n      nick_name: data.seats.nickName,//昵称\r\n      battery_id: data.battery.skin,//炮id\r\n      battery_score: data.battery.score,//炮分数\r\n      isPowerBattery: data.battery.power > 0, //是否能量炮\r\n      room_id: this.roomId,//房间号\r\n      ready: data.seats.ready, //0:准备,1未准备\r\n      offline: data.seats.offline, //0:没有离线,非0:离线\r\n      bullet: data.seats.bullet, //剩余子弹  \r\n    }\r\n\r\n    this.userInfos.push(userInfo);\r\n    this.setBatteryInfo(data.seats.playerId, data.battery.score, data.battery.skin, false, data.battery.power > 0);\r\n  }\r\n\r\n  private levelRoom(playerId: string) {\r\n    if (isSelf(playerId)) {\r\n\r\n    } else {\r\n      this.batteryManager.removeBatteryByPlayerId(playerId);\r\n      this.bulletManager.removeBulletObjectByPlayerId(playerId);\r\n      this.userInfos = this.userInfos.filter(v => v.player_id !== playerId);\r\n    }\r\n  }\r\n\r\n  private updateScore(playerId: string, score: number) {\r\n    const battery = this.batteryManager.getBatteryByPlayerId(playerId);\r\n    if (battery) {\r\n      battery.setScoreVal(score)\r\n    } else {\r\n      const userInfo = this.userInfos.find(v => v.player_id === playerId)\r\n      if (userInfo) {\r\n        userInfo.gold = score;\r\n      }\r\n    }\r\n  }\r\n\r\n  private runSendBullet(player_id: string, angle: number, bulletId: number) {\r\n    let obj = this.batteryManager.getBatteryByPlayerId(player_id)\r\n    if (obj) {\r\n      obj.runSendBullet(angle, true, bulletId)\r\n    }\r\n  }\r\n\r\n\r\n  private addFish(fishs: FishInfo[]) {\r\n    fishs.forEach(v => {\r\n      this.fishManager.addFish({\r\n        object_id: v.id,\r\n        /**鱼配置id */\r\n        fish_id: v.type,\r\n        /**曲线id */\r\n        cve_id: v.road,\r\n        /**已经运动时间t */\r\n        run_t: v.t / 1000,\r\n        /**起始坐标 */\r\n        spos: new Vec3(v.x, v.y),\r\n        /**路径是否反向 */\r\n        breserve: false,\r\n        /**是否旋转 */\r\n        angle: v.angle,\r\n        /**用户数据 */\r\n        user_info: {},\r\n      })\r\n    })\r\n  }\r\n\r\n  private fishDeath(player_id, fshid, score) {\r\n    let bat_obj = this.batteryManager.getBatteryByPlayerId(player_id) as Battery\r\n    let fsh_obj = this.fishManager.getFishObjById(fshid) as Fish\r\n\r\n    if (bat_obj && fsh_obj) {\r\n      fsh_obj.setScoreVal(score)\r\n      fsh_obj.setGoldMoveEndPos(bat_obj.getBatteryPos())\r\n      fsh_obj.setUserInfo(bat_obj.getUserInfo())\r\n    }\r\n    this.fishManager.removeFish(fshid)\r\n  }\r\n\r\n  private fishLstDeath(player_id, lst: FishDieInfo[]) {\r\n    if (lst.length <= 0) { return }\r\n    let score = 0\r\n\r\n    let fsh_id = -1\r\n    for (let i = 0; i < lst.length; i++) {\r\n      if (i === 0) {\r\n        fsh_id = lst[i].fishId\r\n      }\r\n\r\n      if (i > 0) {\r\n        let fsh_obj = this.fishManager.getFishObjById(lst[i].fishId) as Fish\r\n        let first_obj = this.fishManager.getFishObjById(fsh_id) as Fish\r\n        if (first_obj && fsh_obj) {\r\n          first_obj.addLineRelObj(fsh_obj)\r\n        }\r\n        this.fishDeath(player_id, lst[i].fishId, lst[i].score)\r\n      }\r\n      score = score + lst[i].score\r\n    }\r\n\r\n    this.fishDeath(player_id, lst[0].fishId, lst[0].score)\r\n\r\n    // if( BuyuManager.getRoomType() != GAME_TYPE_FRIENDROOM ){\r\n    let bat_obj = this.batteryManager.getBatteryByPlayerId(player_id) as Battery;\r\n    bat_obj.setHitScore(score)\r\n    // }\r\n\r\n    // print(\"get hit score ===== \"  +  score)\r\n  }\r\n\r\n  public enterRoom(data: EnterRoomVo) {\r\n    this.viewNode.active = true;\r\n    this.comp.initSideBoard();\r\n    this.comp.getBatteryNode().angle = 0;\r\n    this.comp.getFishPondNode().angle = 0;\r\n    this.createAllBatteryByPosition();\r\n\r\n    this.userInfos = data.seats.map(v => {\r\n      const userInfo: UserInfo = {\r\n        player_id: v.playerId,\r\n        server_id: 1,\r\n        set_id: v.order + 1,\r\n        is_local: isSelf(v.playerId),//是否为本地，区别自己与别人的炮台\r\n        gold: v.cedit,//金币\r\n        head_id: parseInt(v.icon),//头像\r\n        level: v.level || 100,//等级\r\n        vip_level: v.vip || 0,//vip等级\r\n        nick_name: v.nickName,//昵称\r\n        battery_id: undefined,//炮id\r\n        battery_score: 0,//炮分数\r\n        isPowerBattery: false, //是否能量炮\r\n        room_id: data.roomId,//房间号\r\n        ready: v.ready, //0:准备,1未准备\r\n        offline: v.offline, //0:没有离线,非0:离线\r\n        bullet: v.bullet, //剩余子弹  \r\n      }\r\n      userInfo.is_local && (this.selfUserInfo = userInfo);\r\n      return userInfo;\r\n    });\r\n    this.stage = data.stage;\r\n    this.roomId = data.roomId;\r\n\r\n    if (this.selfUserInfo.set_id === 3 || this.selfUserInfo.set_id === 4) {\r\n      this.fishManager.setUseSkew(true);\r\n      this.skillPlayer.setUseSkew(true);\r\n      this.batteryManager.rotationOtherUserInfo();\r\n      this.fishLabelFntManager.setUseSkew(true)\r\n      this.comp.getBatteryNode().angle = 180;\r\n      this.comp.getFishPondNode().angle = 180;\r\n      this.is_use_rotation = true;\r\n    } else {\r\n      this.fishManager.setUseSkew(false);\r\n      this.skillPlayer.setUseSkew(false);\r\n      // this.batteryManager.resetRotation();\r\n      this.fishLabelFntManager.setUseSkew(false)\r\n      this.comp.getBatteryNode().angle = 0;\r\n      this.comp.getFishPondNode().angle = 0;\r\n      this.is_use_rotation = false;\r\n    }\r\n\r\n    !config.isTest && sktInstance.sendSktMessage(SKT_MAG_TYPE.REQ_SCENCE, {});\r\n    // if (this.stage === 1) {\r\n    // } else {\r\n    //   this.backgroundSceneManager.cutBackgroundScene(1);\r\n    //   if (this.seats.find(v => v.playerId + '' === config.selfUserId).ready !== 0) {\r\n    //     sktInstance.sendSktMessage(SKT_MAG_TYPE.READY, {});\r\n    //   }\r\n    // }\r\n  }\r\n\r\n  private setBatteryInfo(player_id: string, score: number, skin: number, isEff: boolean, isPower: boolean) {\r\n    const userInfo = this.userInfos.find(v => v.player_id === player_id)\r\n    this.batteryManager.setPos();\r\n    const res = this.batteryManager.setBatteryInfo({\r\n      user_info: {\r\n        ...userInfo,\r\n        battery_id: skin,//炮id\r\n        battery_score: score,//炮分数\r\n        isPowerBattery: isPower, //是否能量炮\r\n      },\r\n    })\r\n    this.comp.setBtnLocaltion(this.fishManager.getScaleRatio());\r\n  }\r\n\r\n  private setBatteryBeishu(playerId: string, score: number, isEff: boolean, isPower: boolean) {\r\n    const battery = this.batteryManager.getBatteryByPlayerId(playerId);\r\n    if (battery) {\r\n      battery.setBatteryBeishu(score, isEff);\r\n      battery.setPowerBattery(isPower)\r\n    }\r\n  }\r\n\r\n  private cutBattery(playerId: string, skin: number) {\r\n    const battery = this.batteryManager.getBatteryByPlayerId(playerId);\r\n    if (battery) {\r\n      battery.cutBattery(skin);\r\n    }\r\n  }\r\n\r\n  private lockFish(playerId: string, fishId: number) {\r\n    const battery = this.batteryManager.getBatteryByPlayerId(playerId);\r\n    if (battery) {\r\n      battery.setLockFish(fishId)\r\n    }\r\n  }\r\n  private unLockFish(playerId: string) {\r\n    const battery = this.batteryManager.getBatteryByPlayerId(playerId);\r\n    if (battery) {\r\n      battery.setUnlockFish();\r\n    }\r\n  }\r\n\r\n  protected unMountCallBack(): void {\r\n    this.unListenerSocket();\r\n    this.fishManager = null;\r\n    this.bulletManager = null;\r\n    this.batteryManager = null;\r\n    this.backgroundSceneManager = null;\r\n  }\r\n\r\n  public clearAllFish() {\r\n    this.fishManager.clearAllSceneAllFish();\r\n    this.fishManager.clearFishCacheData();\r\n    this.comp.getFishPondNode().removeAllChildren();\r\n  }\r\n\r\n  private onExitRoom() {\r\n    this.clearAllFish();\r\n    this.comp.hideSideBoard();\r\n    this.viewNode.active = false;\r\n\r\n    sktInstance.sendSktMessage(SKT_MAG_TYPE.EXIT_TABLE, {});\r\n    this.backgroundSceneManager.quitRoom();\r\n    this.batteryManager.removeAllBattery();\r\n  }\r\n\r\n  private initUI() {\r\n\r\n  }\r\n\r\n  private createAllBatteryByPosition() {\r\n    this.batteryManager.createAllBatteryByPosition({\r\n      lock: this.send_yrby_ReqLock.bind(this),\r\n      fire: this.send_yrby_ReqFire.bind(this),\r\n      cancelLock: this.send_yrby_ReqCancelLock.bind(this),\r\n      switchBattery: this.send_yrby_ReqSwitchBattery.bind(this),\r\n    }, {\r\n      wepShow: {\r\n        show: (textureConfig, batterySkinConfig) => {\r\n          this.showChangeBatteryUI(textureConfig, batterySkinConfig);\r\n        }\r\n      },\r\n      dataManager: {\r\n        getRoomType: () => { return 1 },\r\n        getRoomInfo: (param) => {\r\n          return {\r\n            lower: 10,\r\n          }\r\n        }\r\n      },\r\n      noMoney: {},\r\n    })\r\n  }\r\n\r\n  private changeScence(scenceId: number) {\r\n\r\n  }\r\n\r\n  private send_yrby_ReqFire(msg) {\r\n    !config.isTest && sktInstance.sendSktMessage(SKT_MAG_TYPE.SEND_BULLET, msg);\r\n  }\r\n\r\n  private send_yrby_ReqLock(msg) {\r\n    sktInstance.sendSktMessage(SKT_MAG_TYPE.LOCK, msg);\r\n  }\r\n\r\n  private send_yrby_ReqCancelLock(msg) {\r\n    sktInstance.sendSktMessage(SKT_MAG_TYPE.CANCEL_LOCK, msg);\r\n  }\r\n\r\n  private send_yrby_ReqSwitchBattery(msg) {\r\n    sktInstance.sendSktMessage(SKT_MAG_TYPE.CHANGE_BATTERY, msg);\r\n  }\r\n\r\n  private showChangeBatteryUI(textureConfig, batterySkinConfig) {\r\n    const getnewwwepViewModel = new GetnewwwepViewModel().mountView(sourceManageSelector().getFile(PrefabPathDefine.GET_NEWWAP).source)\r\n      .appendTo(this.viewNode.parent, { effectType: EffectType.EFFECT2 }).connect()\r\n      .setProps({\r\n        vipLevel: this.selfUserInfo.vip_level,\r\n        myBatteryId: this.batteryManager.getMyselfBatteryObj().getUserInfo().battery_id,\r\n        textureConfig: textureConfig,\r\n        batterySkinConfig: batterySkinConfig,\r\n      });\r\n\r\n    getnewwwepViewModel.setEvent({\r\n      changeBattery: (batteryId: number) => {\r\n        sktInstance.sendSktMessage(SKT_MAG_TYPE.CHANGE_BATTERY_SKIN, {\r\n          skin: batteryId\r\n        });\r\n      }\r\n    })\r\n  }\r\n\r\n  public connect() {\r\n    this.inject({}, (state: StateType) => {\r\n      return {\r\n      }\r\n    })\r\n    return this\r\n  }\r\n}\r\n\r\nexport default RoomViewModel"]}