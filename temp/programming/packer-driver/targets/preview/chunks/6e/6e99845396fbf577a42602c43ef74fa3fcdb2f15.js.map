{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/subGame/yxx/index.ts"],"names":["Prefab","assetManager","LoaderPanelViewModel","AudioMgr","config","socketConnect","removeInstance","yxxFileMap","bundlePkgName","PrefabPathDefine","SoundPathDefine","fruitStore","GameBoardViewModel","TestViewModel","getStore","addToastAction","setSubGameRunState","global","lang","SubGameRunState","subGameList","sourceManageMap","bundleyxx","sourceManageSeletor","bundleName","find","i","bundle","name","initTimeoutId","startUp","rootNode","dispatch","configureStore","loadBundle","err","load","LOAING_PANEL","progress","total","hallDispatch","LOADING","setSubGameGate","gameId","prefab","isAllowOpenSubGame","READY","loaderviweModel","mountView","appendTo","setProps","loadBarType","setEvent","onLoadDone","_sourceManageMap","window","setTimeout","closeSubGame","confirmContent","write","k","InitGameModule","GameBoardInit","confirmDoneBeforeFn","destoryGame","content","placeStr","yxxAudio","comp","setTipContent","WebSocketModule","GameInit","RUN","timeId","unMount","clearTimeout","then","gameBoardViewModel","getFile","GAME_BOARD","source","connect","initConnect","isTest","TEST_PANEL","getGameNode","catch","e","versionStr","md5","startLoad","stopGame","remove","playBtnClick","playOneShot","BTN_CLICK","playChip","CHIP","playDefeat","DEFEAT","playWin","WIN","playDong","DONG","playSieve","SIEVE","playGetCoin","GET_COIN","playTimeout","TIME_OUT","playMainBg","play","MAIN_BG","longStop"],"mappings":"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","sourcesContent":["import { AssetManager, Node, Prefab, assetManager, log } from \"cc\";\r\nimport SourceManage from \"../../base/SourceManage\";\r\nimport LoaderPanelViewModel from \"../../common/viewModel/LoaderPanelViewModel\";\r\nimport { AudioMgr } from \"../../utils/AudioMgr\";\r\nimport config from \"./config\";\r\nimport socketConnect, { removeInstance } from \"./socketConnect\";\r\nimport yxxFileMap, { bundlePkgName } from './sourceDefine';\r\nimport { PrefabPathDefine } from \"./sourceDefine/prefabDefine\";\r\nimport { SoundPathDefine } from \"./sourceDefine/soundDefine\";\r\nimport fruitStore from './store';\r\nimport GameBoardViewModel from \"./viewModel/GameBoardViewModel\";\r\nimport TestViewModel from \"./viewModel/TestViewModel\";\r\nimport { getStore } from \"../../hall/store\";\r\nimport { addToastAction, setSubGameRunState } from \"../../hall/store/actions/baseBoard\";\r\nimport { global, lang } from \"../../hall\";\r\nimport { SubGameRunState, subGameList } from \"../../hall/config\";\r\n\r\n\r\nlet sourceManageMap: Array<SourceManage> = [];\r\nexport let bundleyxx: AssetManager.Bundle = null;\r\nexport let gameBoardViewModel: GameBoardViewModel;\r\nexport let yxxAudio: AudioMgr<SoundPathDefine>;\r\nexport const sourceManageSeletor = (bundleName: string = 'yxx') => sourceManageMap.find(i => i.bundle.name === bundleName)\r\nlet initTimeoutId = 0;\r\n\r\nexport const startUp = (rootNode: Node) => {\r\n  const dispatch = getStore().dispatch\r\n  fruitStore.configureStore()\r\n  assetManager.loadBundle(bundlePkgName, (err, bundle) => {\r\n    bundleyxx = bundle\r\n    bundleyxx.load(PrefabPathDefine.LOAING_PANEL, Prefab, (progress, total) => {\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.LOADING))\r\n      global.setSubGameGate(config.gameId, (progress / total))\r\n    }, (err, prefab) => {\r\n      if (!global.isAllowOpenSubGame(config.gameId)) return\r\n      global.hallDispatch(setSubGameRunState(SubGameRunState.READY))\r\n      const loaderviweModel = new LoaderPanelViewModel().mountView(prefab).appendTo(rootNode).setProps({\r\n        loadBarType: 1\r\n      }).setEvent({\r\n        onLoadDone: (_sourceManageMap) => {\r\n          // window.clearTimeout(initTimeoutId);\r\n          // 默认给10秒进入游戏超时处理，有时候socket连接成功之后，服务器没有发送进入房间 消息，导致卡住\r\n          initTimeoutId = window.setTimeout(() => {\r\n            global.closeSubGame({\r\n              confirmContent: lang.write(k => k.InitGameModule.GameBoardInit),\r\n              confirmDoneBeforeFn: () => destoryGame(loaderviweModel, initTimeoutId)\r\n            });\r\n            dispatch(addToastAction({ content: lang.write(k => k.InitGameModule.GameBoardInit, {}, { placeStr: \"game init failed\" }) }))\r\n          }, 10000);\r\n\r\n          sourceManageMap = _sourceManageMap\r\n          // hallConfig.gameConfig.find(item => item.name === \"yxx\")\r\n          yxxAudio = new AudioMgr<SoundPathDefine>(sourceManageSeletor(\"yxx\"));\r\n\r\n          loaderviweModel.comp.setTipContent(lang.write(k => k.WebSocketModule.GameInit, {}, { placeStr: \"Game init...\" }))\r\n          global.hallDispatch(setSubGameRunState(SubGameRunState.RUN))\r\n          // 卸载游戏方法\r\n          const destoryGame = (loaderviweModel: LoaderPanelViewModel, timeId: number) => {\r\n            loaderviweModel.unMount();\r\n            window.clearTimeout(timeId);\r\n          }\r\n          removeInstance();\r\n\r\n          socketConnect().then(() => {\r\n\r\n            gameBoardViewModel = new GameBoardViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.GAME_BOARD).source)\r\n              .appendTo(rootNode).connect().initConnect(() => {\r\n                destoryGame(loaderviweModel, initTimeoutId);\r\n              });\r\n\r\n            /**测试界面，可以随时注释 */\r\n            if (config.isTest) {\r\n              new TestViewModel().mountView(sourceManageSeletor().getFile(PrefabPathDefine.TEST_PANEL).source).appendTo(gameBoardViewModel.comp.getGameNode()).connect()\r\n            }\r\n          }).catch(e => loaderviweModel.comp.setTipContent(e || 'error'))\r\n        }\r\n      }).setProps({\r\n        versionStr: `md5: ${subGameList.find(i => i.gameId === config.gameId).md5}`\r\n      })\r\n      loaderviweModel.comp.startLoad([bundle], [...yxxFileMap])\r\n    })\r\n  })\r\n}\r\n\r\nexport const stopGame = () => {\r\n  // log(\"stopGame\", initTimeoutId);\r\n  initTimeoutId && window.clearTimeout(initTimeoutId);\r\n  gameBoardViewModel && gameBoardViewModel.unMount();\r\n  yxxAudio && yxxAudio.remove();\r\n  removeInstance();\r\n}\r\n\r\n/**\r\n * 按钮单击音效\r\n */\r\nexport const playBtnClick = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.BTN_CLICK);\r\n}\r\n\r\n/**\r\n * 下注筹码音效\r\n */\r\nexport const playChip = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.CHIP);\r\n}\r\n\r\n/**\r\n * 失败音效\r\n */\r\nexport const playDefeat = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.DEFEAT);\r\n}\r\n\r\n/**\r\n * 胜利音效\r\n */\r\nexport const playWin = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.WIN);\r\n}\r\n\r\n/**\r\n * 开盖，关盖音效\r\n */\r\nexport const playDong = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.DONG);\r\n}\r\n/**\r\n * 摇骰子\r\n */\r\nexport const playSieve = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.SIEVE);\r\n}\r\n\r\n/**\r\n * 金币收集音效\r\n */\r\nexport const playGetCoin = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.GET_COIN);\r\n}\r\n\r\n/**\r\n * 3秒倒计时\r\n */\r\nexport const playTimeout = () => {\r\n  yxxAudio.playOneShot(SoundPathDefine.TIME_OUT);\r\n}\r\n\r\n/**\r\n * 背景音乐\r\n */\r\nexport const playMainBg = () => {\r\n  yxxAudio.play(SoundPathDefine.MAIN_BG, true);\r\n}\r\n\r\nexport const longStop = () => {\r\n  yxxAudio.longStop();\r\n}"]}