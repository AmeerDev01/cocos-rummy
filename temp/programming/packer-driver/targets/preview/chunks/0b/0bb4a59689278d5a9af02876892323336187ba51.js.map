{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/utils/StepNumberV2.ts"],"names":["StepNumberV2","Label","UIOpacity","UITransform","Vec3","instantiate","tween","constructor","component","targetNode","flyLabelNode","flyHeight","flyHandler","update","done","defaultStepTime","minKeepTime","maxKeepTime","step","currNum","beginNum","endNum","callback_fn","setFlyNode","num","flyNode","active","getComponent","string","Math","abs","formatAmountWithCommas","setScale","addChild","x","y","z","position","to","height","easing","start","addComponent","opacity","call","destroy","set","stepTime","minDistance","maxDistance","distance","isFlyNumber","unschedule","timeHandle","bind","schedule","stop","undefined"],"mappings":"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","sourcesContent":["import { Component, Label, Node, UIOpacity, UITransform, Vec3, instantiate, tween } from \"cc\"\r\n/**\r\n * 步进数字\r\n */\r\nexport default class StepNumberV2 {\r\n  constructor(component: Component) {\r\n    this.component = component\r\n  }\r\n  private targetNode: Node\r\n  private flyLabelNode: Node\r\n  private flyHeight: number\r\n  private flyHandler: (num: number) => void\r\n  /**\r\n   * 激活飘数字效果\r\n   * @param targetNode \r\n   * @param flyLabelNode \r\n   */\r\n  public setFlyNode(targetNode: Node, flyLabelNode: Node, flyHeight?: number) {\r\n    flyHeight && (this.flyHeight = flyHeight)\r\n    this.targetNode = targetNode\r\n    this.flyLabelNode = flyLabelNode\r\n    this.flyHandler = (num: number) => {\r\n      if (!this.flyLabelNode) return\r\n      const flyNode = instantiate(this.flyLabelNode)\r\n      flyNode.active = true\r\n      if (this.targetNode) {\r\n        flyNode.getComponent(Label).string = (num > 0 ? '+' : '-') + Math.abs(num).formatAmountWithCommas()\r\n        flyNode.setScale(0.9, 0.9)\r\n        this.targetNode.addChild(flyNode)\r\n        const { x, y, z } = flyNode.position\r\n        tween(flyNode).to(0.7, { position: new Vec3(x, y + this.flyHeight || flyNode.getComponent(UITransform).height, z) }, { easing: \"backOut\" }).start()\r\n        !flyNode.getComponent(UIOpacity) && (flyNode.addComponent(UIOpacity))\r\n        tween(flyNode.getComponent(UIOpacity)).to(0.8, { opacity: 0 }).call(() => {\r\n          flyNode.destroy()\r\n        }).start()\r\n      }\r\n    }\r\n  }\r\n  /**设置步进时间(默认步进时间20ms)，传入步进时间，你可以通过控制步进时间间接控制步进量 */\r\n  public set(stepTime: number = 20) {\r\n    stepTime && (this.defaultStepTime = stepTime)\r\n    // 比如50ms一次，每次变量10，持续时间最低1000ms~5000ms，那么数字间隔最低为1000/50 * 10 = 200,最高5000/50 * 10=1000，如果超越这个区间，将动态调整变量\r\n    const minDistance = (this.minKeepTime / this.defaultStepTime) * this.step\r\n    const maxDistance = (this.maxKeepTime / this.defaultStepTime) * this.step\r\n    const distance = this.endNum - this.beginNum\r\n    if (Math.abs(distance) <= minDistance || Math.abs(distance) >= maxDistance) {\r\n      // 重算步进量\r\n      this.step = distance / (this.minKeepTime / this.defaultStepTime)\r\n    } else {\r\n      distance < 0 && (this.step = this.step * -1)\r\n    }\r\n    // distance < 0 && (this.step = this.step * -1)\r\n    return this;\r\n  }\r\n  /**\r\n   * 开始执行\r\n   * @param isFlyNumber 是否激活数字飘动效果，前提是要设置flyHandler\r\n   * @returns \r\n   */\r\n  public start(beginNum: number, endNum: number, update: (num: number) => void, done?: () => void, stepTime: number = 20, isFlyNumber: boolean = true) {\r\n    this.beginNum = beginNum\r\n    this.endNum = endNum\r\n    this.update = update\r\n    this.done = done\r\n    this.set(stepTime);\r\n\r\n    this.currNum = this.beginNum\r\n    this.callback_fn && this.component.unschedule(this.callback_fn);\r\n    // console.log(this.endNum - this.beginNum)\r\n    this.flyHandler && isFlyNumber && this.flyHandler(this.endNum - this.beginNum)\r\n    this.callback_fn = this.timeHandle.bind(this);\r\n    this.component.schedule(this.callback_fn, stepTime / 1000);\r\n  }\r\n\r\n  private timeHandle() {\r\n    this.currNum += this.step\r\n    //乘以2是怕越过终点，这样就停不下来了\r\n    if (Math.abs(this.currNum - this.endNum) <= Math.abs(this.step)) {\r\n      this.stop()\r\n    } else {\r\n      this.update(this.currNum)\r\n    }\r\n  }\r\n\r\n  /**调过过程，直接变成目标值 */\r\n  public stop() {\r\n    this.currNum = this.endNum\r\n    this.update && this.update(this.endNum)\r\n    this.component.unschedule(this.callback_fn);\r\n    this.update = undefined;\r\n    this.callback_fn = undefined;\r\n    this.done && this.done()\r\n    this.done = undefined;\r\n  }\r\n  private component: Component\r\n  private update: (num: number) => void\r\n  private done: () => void\r\n  /**默认的步进时间 */\r\n  private defaultStepTime = 20;\r\n  /**最小持续时间 */\r\n  private readonly minKeepTime = 500\r\n  /**最大持续时间 */\r\n  private readonly maxKeepTime = 2000\r\n  /**步进量 */\r\n  private step = 10\r\n  /**在变化的值 */\r\n  private currNum = 0\r\n  private beginNum: number = 0\r\n  private endNum: number = 0\r\n  private callback_fn: any;\r\n}"]}