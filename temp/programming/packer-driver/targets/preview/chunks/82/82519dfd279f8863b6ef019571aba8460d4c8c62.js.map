{"version":3,"sources":["file:///Users/geliang/web/dibai/hall/assets/script/common/components/Common_Marquee.ts"],"names":["_decorator","instantiate","Label","Node","UITransform","Vec3","BaseComponent","ccclass","property","Common_Marquee","marueeMap","propertyNode","props_Mask_ticker","props_template_label_ticker","props","addInfoQueue","speed","isInSubGame","events","start","schedule","move","initState","isDone","bindEvent","useProps","key","value","cur","length","list","concat","sort","a","b","priority","state","setState","run","e","console","error","node","active","fristItem","count","shift","itemNode","cocosString","convertHtmlToCustomFormat","decodeURI","content","log","getComponent","string","addChild","setPosition","position","x","y","inputString","regex","convertedString","replace","match","r","g","hexColor","rgbToHex","parseInt","_r","Math","max","min","_g","_b","hexR","toString","padStart","hexG","hexB","bindUI","useState","children","forEach","child","width","destroy","update","deltaTime"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Label, Node, RichText, UITransform, Vec3 } from 'cc';\r\nimport { BaseComponent } from '../../base/BaseComponent';\r\nconst { ccclass, property } = _decorator;\r\n\r\nexport type MarueeType = {\r\n\t/**跑马灯内容 */\r\n\tcontent: string\r\n\t/**次数 */\r\n\tcount: number\r\n\t/**间隔时间(秒) */\r\n\tintervalSeconds: number\r\n\t/**优先级 (1:低，2:中，3:高) */\r\n\tpriority: number\r\n}\r\n\r\nexport interface IState {\r\n\tisDone: boolean\r\n}\r\n\r\nexport interface IProps {\r\n\taddInfoQueue?: MarueeType[]\r\n\tspeed?: number,\r\n\tisInSubGame: boolean\r\n}\r\nexport interface IEvent {\r\n\r\n}\r\n\r\n@ccclass('Common_Marquee')\r\nexport class Common_Marquee extends BaseComponent<IState, IProps, IEvent> {\r\n\tstart() {\r\n\t\tthis.schedule(this.move, 0.02)\r\n\t}\r\n\tprivate marueeMap: Array<MarueeType> = []\r\n\r\n\tprotected propertyNode = {\r\n\t\tprops_Mask_ticker: new Node(),\r\n\t\t/**跑马灯模板 */\r\n\t\tprops_template_label_ticker: new Node()\r\n\t}\r\n\r\n\tpublic props: IProps = {\r\n\t\taddInfoQueue: [],\r\n\t\tspeed: 3,\r\n\t\tisInSubGame: false\r\n\t}\r\n\r\n\tpublic events: IEvent = {\r\n\r\n\t}\r\n\r\n\tprotected initState() {\r\n\t\treturn {\r\n\t\t\tisDone: true\r\n\t\t}\r\n\t}\r\n\r\n\tprotected bindEvent(): void {\r\n\r\n\t}\r\n\r\n\tprotected useProps(key: keyof IProps, value: { pre: any, cur: any }) {\r\n\t\tif (key === \"addInfoQueue\") {\r\n\t\t\tif (!value.cur.length) return;\r\n\t\t\ttry {\r\n\t\t\t\tconst list = [...value.cur] as MarueeType[]\r\n\t\t\t\tthis.marueeMap = this.marueeMap.concat(list)\r\n\t\t\t\tthis.marueeMap.sort((a, b) => b.priority - a.priority)\r\n\t\t\t\tif (this.state.isDone) {\r\n\t\t\t\t\tthis.setState({ isDone: false })\r\n\t\t\t\t\tthis.run()\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.error(e)\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (key === \"isInSubGame\") {\r\n\t\t\tif (this.props.isInSubGame) {\r\n\t\t\t\tthis.node.active = false\r\n\t\t\t} else {\r\n\t\t\t\tif (this.props.addInfoQueue.length) {\r\n\t\t\t\t\tthis.node.active = true\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tprivate run() {\r\n\t\tif (this.marueeMap.length) {\r\n\t\t\tconst fristItem = this.marueeMap[0]\r\n\t\t\tif (fristItem.count === -1) {\r\n\t\t\t\t//无线循环\r\n\t\t\t} else if (fristItem.count <= 1) {\r\n\t\t\t\tthis.marueeMap.shift()\r\n\t\t\t} else {\r\n\t\t\t\tfristItem.count--\r\n\t\t\t}\r\n\t\t\t//const fristItem = this.marueeMap.shift()\r\n\t\t\tconst itemNode = instantiate(this.propertyNode.props_template_label_ticker) as Node\r\n\t\t\t// itemNode.getComponent(Label).string = decodeURI(fristItem.content)\r\n\t\t\t// const cocosString = decodeURI(fristItem.content).replace(/<span\\s+style=['\"]color\\s*:\\s*#([^'\"]+)['\"]>([^<]+)<\\/span>/gi, (match, color, content) => {\r\n\t\t\t// \t// 返回转换后的格式\r\n\t\t\t// \treturn `<color=#${color}>${content}</color>`;\r\n\t\t\t// })\r\n\t\t\tconst cocosString = this.convertHtmlToCustomFormat(decodeURI(fristItem.content))\r\n\t\t\tconsole.log(decodeURI(fristItem.content), cocosString)\r\n\t\t\t// itemNode.getComponent(RichText).string = cocosString\r\n\t\t\titemNode.getComponent(Label).string = decodeURI(fristItem.content)\r\n\t\t\t!this.props.isInSubGame && (itemNode.active = true)\r\n\t\t\tthis.propertyNode.props_Mask_ticker.addChild(itemNode)\r\n\t\t\t// itemNode.getComponent(RichText)['_updateRichText']()\r\n\t\t\t// console.log('width', itemNode.getComponent(UITransform).width)\r\n\t\t\titemNode.setPosition(new Vec3(itemNode.position.x * 2, itemNode.position.y, 0))\r\n\t\t} else {\r\n\t\t\tthis.setState({ isDone: true })\r\n\t\t}\r\n\t}\r\n\tprivate convertHtmlToCustomFormat(inputString) {\r\n\t\tconst regex = /<span\\s+style=['\"]color\\s*:\\s*rgb\\((\\d+),\\s*(\\d+),\\s*(\\d+)\\);['\"]>([^<]+)<\\/span>/gi;\r\n\r\n\t\tconst convertedString = inputString.replace(regex, (match, r, g, b, content) => {\r\n\t\t\tconst hexColor = this.rgbToHex(parseInt(r), parseInt(g), parseInt(b));\r\n\t\t\treturn `<color=${hexColor}>${content}</color>`;\r\n\t\t});\r\n\r\n\t\treturn convertedString;\r\n\t}\r\n\r\n\t// RGB 转换为十六进制格式的函数\r\n\tprivate rgbToHex(r, g, b) {\r\n\t\tconst _r = Math.max(0, Math.min(255, r));\r\n\t\tconst _g = Math.max(0, Math.min(255, g));\r\n\t\tconst _b = Math.max(0, Math.min(255, b));\r\n\r\n\t\tconst hexR = (_r.toString(16) as any).padStart(2, '0');\r\n\t\tconst hexG = (_g.toString(16) as any).padStart(2, '0');\r\n\t\tconst hexB = (_b.toString(16) as any).padStart(2, '0');\r\n\r\n\t\treturn `#${hexR}${hexG}${hexB}`;\r\n\t}\r\n\r\n\tprotected bindUI(): void {\r\n\t\tthis.node.active = false\r\n\t\tthis.useState((key, value) => {\r\n\t\t\tif (value.cur) {\r\n\t\t\t\tthis.node.active = false\r\n\t\t\t} else {\r\n\t\t\t\t!this.props.isInSubGame && (this.node.active = true)\r\n\t\t\t}\r\n\t\t}, [\"isDone\"])\r\n\t}\r\n\r\n\tprivate move() {\r\n\t\tthis.propertyNode.props_Mask_ticker.children.forEach((child: Node) => {\r\n\t\t\tchild.position = new Vec3(child.position.x - this.props.speed, child.position.y, 0)\r\n\t\t\tif (child.position.x < -child.getComponent(UITransform).width) {\r\n\t\t\t\tchild.destroy()\r\n\t\t\t\tthis.run()\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\tupdate(deltaTime: number) {\r\n\r\n\t}\r\n}\r\n\r\n"]}